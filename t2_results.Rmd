---
title: "t2_results"
author: "Eren Kafadar"
date: "2025-01-26"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
diagnostics <- FALSE
generate <- FALSE
knitr::opts_chunk$set(echo = TRUE)
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(ggplot2)
library(gamlss) #to fit model
require(gamlss.ggplots)
library(tidyr)
library(gamlssTools) #Margaret's package
library(gridExtra)
library(ggsegDKT)
library(ggseg)
library(ggcorrplot)

source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/inspect_model_fits.R")
source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/gamlss_functions_EK.R")
source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/data_functions.R")

source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/pred_og_centile_EK.R")

#df to map variable names onto names displayed on figures
name_mapping <- data.frame(
  abbreviation = c(
     "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_cdk_total",   
     "totalWM_cb", "totalWM_crb", "totalGM_crb",
     
    "smri_vol_scs_cbwmatterlh", "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_csf",
    "smri_vol_scs_lesionlh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_cbwmatterrh", "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh", "smri_vol_scs_lesionrh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_wmhint",
    "smri_vol_scs_wmhintlh", "smri_vol_scs_wmhintrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat", 
    
    "smri_vol_scs_wholeb", "smri_vol_scs_latventricles",
    "smri_vol_scs_allventricles", "smri_vol_scs_intracranialv", "smri_vol_scs_suprateialv",
    "smri_vol_scs_subcorticalgv",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  ),
  region_name = c(
    "Left-Cerebral_Cortex", "Right-Cerebral-Cortex", "Total-Cerebral-Cortex",
    "Total_Cerebral-WM", "Total_Cerebellum-WM", "Total-Cerebellum-Cortex",
    
    "Left-Cerebral-White-Matter", "Left-Lateral-Ventricle", "Left-Inf-Lat-Vent",
    "Left-Cerebellum-White-Matter", "Left-Cerebellum-Cortex", "Left-Thalamus-Proper",
    "Left-Caudate-Nucleus", "Left-Putamen", "Left-Pallidum",
    "x3rd-ventricle", "x4th-ventricle", "Brain-Stem",
    "Left-Hippocampus", "Left-Amygdala", "Cerebrospinal-Fluid",
    "Left-Lesion", "Left-Accumbens-Area", "Left-VentralDC",
    
   "Right-Cerebral-White-Matter", "Right-Lateral-Ventricle", "Right-Inf-Lat-Vent",
    "Right-Cerebellum-White-Matter", "Right-Cerebellum-Cortex", "Right-Thalamus-Proper",
    "Right-Caudate-Nucleus", "Right-Putamen", "Right-Pallidum",
    "Right-Hippocampus", "Right-Amygdala",
    "Right-Lesion", "Right-Accumbens-Area", "Right-VentralDC",
    
    "WM-Hypointensities","Left-WM-Hypointensities", "Right-WM-Hypointensities",
   
   "CC_Posterior","CC_Mid_Posterior", "CC_Central", "CC_Mid_Anterior",
    "CC_Anterior", 
   
   "WholeBrain", "LatVentricles","AllVentricles", "IntracranialVolume", 
   "SupratentorialVolume", "SubcorticalGrayVolume",
   
     "lh_bankssts", "lh_caudalanteriorcingulate", "lh_caudalmiddlefrontal",
    "lh_cuneus", "lh_entorhinal", "lh_fusiform",
    "lh_inferiorparietal", "lh_inferiortemporal", "lh_isthmuscingulate",
    "lh_lateraloccipital", "lh_lateralorbitofrontal", "lh_lingual",
    "lh_medialorbitofrontal", "lh_middletemporal", "lh_parahippocampal",
    "lh_paracentral", "lh_parsopercularis", "lh_parsorbitalis",
    "lh_parstriangularis", "lh_pericalcarine", "lh_postcentral",
    "lh_posteriorcingulate", "lh_precentral", "lh_precuneus", "lh_rostralanteriorcingulate",
    "lh_rostralmiddlefrontal", "lh_superiorfrontal", "lh_superiorparietal",
    "lh_superiortemporal", "lh_supramarginal", "lh_frontalpole",
    "lh_temporalpole", "lh_transversetemporal", "lh_insula",
   
     "rh_bankssts", "rh_caudalanteriorcingulate", "rh_caudalmiddlefrontal",
    "rh_cuneus", "rh_entorhinal", "rh_fusiform",
    "rh_inferiorparietal", "rh_inferiortemporal", "rh_isthmuscingulate",
    "rh_lateraloccipital", "rh_lateralorbitofrontal", "rh_lingual",
    "rh_medialorbitofrontal", "rh_middletemporal", "rh_parahippocampal",
    "rh_paracentral", "rh_parsopercularis", "rh_parsorbitalis",
    "rh_parstriangularis", "rh_pericalcarine", "rh_postcentral",
    "rh_posteriorcingulate", "rh_precentral", "rh_precuneus", "rh_rostralanteriorcingulate",
    "rh_rostralmiddlefrontal", "rh_superiorfrontal", "rh_superiorparietal",
    "rh_superiortemporal", "rh_supramarginal", "rh_frontalpole",
    "rh_temporalpole", "rh_transversetemporal", "rh_insula"
    )
)
```
#SETUP-data
##Define files
```{r}
#file paths
splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_t2_all_ONE/"
splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_t2_all_TWO/"
sOne_fits_stats_filename <- paste0(splitOne_folder, "gamlss_fits_stats_all.csv")
sTwo_fits_stats_filename <- paste0(splitTwo_folder, "gamlss_fits_stats_all.csv")
splitOne_data_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sOne_train.csv"
splitTwo_data_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sTwo_train.csv"
splitOne_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sOne_test.csv"
splitTwo_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sTwo_test.csv"

phenotype_set <- readRDS("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/phenotype_set.rds")

centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Centile_CSVs/regional_t2_volume_centiles.csv"
```
## Load data frames and clean them up
```{r}
#read in the dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
sOne_df <- read.csv(splitOne_data_filename)  %>% select(-1) %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
sOne_df$sex <- as.factor(sOne_df$sex)
sOne_df$site <- as.factor(sOne_df$site)
sOne_df$age <- as.numeric(sOne_df$age)

#read in the dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
sTwo_df <- read.csv(splitTwo_data_filename)  %>% select(-1) %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
sTwo_df$sex <- as.factor(sTwo_df$sex)
sTwo_df$site <- as.factor(sTwo_df$site)
sTwo_df$age <- as.numeric(sTwo_df$age)

#read in the test dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
sOne_test_df <- read.csv(splitOne_test_filename)  %>% select(-1)  %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
sOne_test_df$sex <- as.factor(sOne_test_df$sex)
sOne_test_df$site <- as.factor(sOne_test_df$site)
sOne_test_df$age <- as.numeric(sOne_test_df$age)

#read in the test dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
sTwo_test_df <- read.csv(splitTwo_test_filename)  %>% select(-1) %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
sTwo_test_df$sex <- as.factor(sTwo_test_df$sex)
sTwo_test_df$site <- as.factor(sTwo_test_df$site)
sTwo_test_df$age <- as.numeric(sTwo_test_df$age)

centiles_all <- read.csv(centiles_filename)  %>% select(-1)
full_test_df <- rbind(sOne_test_df,sTwo_test_df)
full_test_df <- merge(centiles_all, full_test_df, by = "src_subject_id")
```
#Gestational Age
##whole sample
Look at the predicted centiles (from cross model) with GA, whole sample
```{r}
#regression (to be able to include covariates later)
ga_zscore <- z_score(full_test_df$gestAge)
reg_table_full <- as.data.frame(t(sapply(full_test_df[, grepl("centiles", names(full_test_df))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4])
})))

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)
```

##Visualize on the brain

```{r}
reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "Regions with GA")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with GA")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA")
```

#Additional Data
##Merge data
Get PRS, neonatal complications, birthweight in the same data tables
scrn_birthcomp - any birth complications for >1 month hospitalization?
birth_weight_lbs - birth weight in pounds?
full_abcd
  race_ethinicity variable (to check PRS calculated sample)
  1 - White, 2 - Black, 3 - Hispanic, 4 - Asian, 5 - Other
```{r}
filename_fullfile <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_long_full_2024-10-04.csv"
full_abcd <- read.csv(filename_fullfile) %>% select(-1) %>% filter(eventname == "baseline_year_1_arm_1")
filename_prs <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/abcd_clean.csv"
filename_psych1 <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/abcd_longitudinal_psychopathology_factors_scores_full_sample.csv"
filename_psych2 <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/psy_var.RData"
filename_anthro_vars <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/raw_tables_5.1/ph_y_anthro.csv"
filename_bwcentile_boy <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/boy_birthweight.csv"
filename_bwcentile_girl <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/girl_birthweight.csv"
abcd_prs <- read.csv(filename_prs)
abcd_psych <- read.csv(filename_psych1)
load(filename_psych2)
abcd_anthro <- read.csv(filename_anthro_vars)
all_birthweight <- rbind(read.csv(filename_bwcentile_boy), read.csv(filename_bwcentile_girl)) %>% select(-1)

#Get composite variable for neonatal complications
neonatal_vars <- c("devhx_14a3_p", "devhx_14b3_p", "devhx_14c3_p", "devhx_14d3_p", "devhx_14e3_p", "devhx_14f3_p", "devhx_14g3_p", "devhx_14h3_p")
#4 rows NAs initially (presumably did not respond to the question)
full_abcd[neonatal_vars] <- lapply(full_abcd[neonatal_vars], function(x) replace(x, x==999, NA))
full_abcd$neonatal_comp_total <- rowSums(full_abcd[neonatal_vars], na.rm = TRUE)

#Regress out the first ten PCs from the PRS scores
model_bw <- lm(bw_pgs ~ PC1 + PC2 + PC3 + PC4 + PC5 + PC6 + PC7 + PC8 + PC9 + PC10, data = abcd_prs)
model_ga <- lm(ga_pgs ~ PC1 + PC2 + PC3 + PC4 + PC5 + PC6 + PC7 + PC8 + PC9 + PC10, data = abcd_prs)
abcd_prs$bw_pgs_resd <- model_bw$residuals
abcd_prs$ga_pgs_resd <- model_ga$residuals
ten_PCs <- paste0("PC", 1:10)

#Match participant names to other dataframes for merge
abcd_prs$participant <- sub("sub-NDAR", "NDAR_", abcd_prs$participant)

#Merge dataframes
test <- merge(full_test_df, full_abcd[,c("scrn_birthcomp","neonatal_comp_total", "birth_weight_lbs","race_ethnicity", "src_subject_id")], by = c("src_subject_id"))

test <- merge(test, abcd_psych %>% filter(eventname == 2) %>% select(-c("rel_family_id", "interview_age", "eventname")), by = c("src_subject_id"), all = TRUE)

test <- merge(test, psy %>% select (-c("age", "sex")), by.x = "src_subject_id", by.y = "IID", all = TRUE)

test <- merge(test, abcd_anthro %>% filter(eventname == "baseline_year_1_arm_1"), by = c("src_subject_id"), all = TRUE)

test <- merge(test, all_birthweight %>% select(c("src_subject_id", "birth_weight_grams", "bw_category", "bweight_zscore", "bweight_percentile")), by = c("src_subject_id"), all = TRUE)

test_prs <- merge(test, abcd_prs[,c("bw_pgs", "ga_pgs","ga_pgs_resd", "bw_pgs_resd", "bw", ten_PCs, "participant")], by.x = "src_subject_id", by.y = "participant", all.x = TRUE)
```


##Inter-variable correlations
```{r}
#bw pgs
cor.test(abcd_prs$bw_pgs, abcd_prs$bw)
cor.test(test_prs$bw_pgs, test_prs$birth_weight_lbs)
#ga pgs
cor.test(test_prs$ga_pgs, test_prs$gestAge)
# bw ga pgs
cor.test(abcd_prs$bw_pgs, abcd_prs$ga_pgs)
cor.test(test_prs$bw_pgs, test_prs$ga_pgs)
#bw and ga
cor.test(test_prs$gestAge, test_prs$birth_weight_lbs)
#bw and birth comp
cor.test(test_prs$neonatal_comp_total, test_prs$birth_weight_lbs)
#ga and birth comp
cor.test(test_prs$gestAge, test_prs$neonatal_comp_total)
#bwpgs and birth comp
cor.test(test_prs$neonatal_comp_total, test_prs$bw_pgs)
#gapgs and birth comp
cor.test(test_prs$ga_pgs, test_prs$neonatal_comp_total)
#cross pgs
cor.test(test_prs$bw_pgs, test_prs$gestAge)
cor.test(test_prs$ga_pgs, test_prs$birth_weight_lbs)

#correlation matrix and visualization
cor_matrix <- cor(test_prs[,c("gestAge", "bw", "neonatal_comp_total", "ga_pgs", "bw_pgs")], use = "pairwise.complete.obs")

ggcorrplot(
  cor_matrix,
  type = "lower",
  insig = "blank"
)
```

##Correlations with centile scores
###birth weight
```{r}

bw_reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  bw_zscore <- z_score(test_prs$birth_weight_lbs)
  x_zscore <- qnorm(x)
  #also omit those cells in bw_zscore to match the two vectors
  bw_zscore[is.infinite(x_zscore)] <- NA
  x_zscore[is.na(bw_zscore)] <- NA
  bw_zscore <- na.omit(bw_zscore)
  #omit cells with infinite values after applying qnorm
  x_zscore[is.infinite(x_zscore)] <- NA
  x_zscore <- na.omit(x_zscore)
  
  lm <- lm(x_zscore ~ bw_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4])
})))

bw_reg_table_full_sig <- bw_reg_table_full %>% filter(bw_p < 0.05)
bw_reg_table_full$bw_p_adj <- p.adjust(bw_reg_table_full$bw_p, method = "BH")
bw_reg_table_full_sig_MC <- bw_reg_table_full %>% filter(bw_p_adj < 0.05)
```

```{r}
bw_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_reg_table_full_sig_MC[!(bw_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with BW")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with BW")
```
###neonatal-comp
```{r}
neo_comp_reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
  x_zscore <- qnorm(x)
  #also omit those cells in neo_comp_zscore to match the two vectors
  neo_comp_zscore[is.infinite(x_zscore)] <- NA
  x_zscore[is.na(neo_comp_zscore)] <- NA
  neo_comp_zscore <- na.omit(neo_comp_zscore)
  #omit cells with infinite values after applying qnorm
  x_zscore[is.infinite(x_zscore)] <- NA
  x_zscore <- na.omit(x_zscore)
  lm <- lm(x_zscore ~ neo_comp_zscore)
  summary <- summary(lm)
  
  c(neo_comp_beta = summary$coefficients[2,1], neo_comp_p = summary$coefficients[2,4])
})))

neo_comp_reg_table_full_sig <- neo_comp_reg_table_full %>% filter(neo_comp_p < 0.05)
neo_comp_reg_table_full$neo_comp_p_adj <- p.adjust(neo_comp_reg_table_full$neo_comp_p, method = "BH")
neo_comp_reg_table_full_sig_MC <- neo_comp_reg_table_full %>% filter(neo_comp_p_adj < 0.05)
```

```{r}
neo_comp_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(neo_comp_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(neo_comp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neo_comp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
neo_comp_reg_table_full_sig_MC[!(neo_comp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(neo_comp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neo_comp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with Neonatal Comp.")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neo_comp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with Neonatal Comp.")
```
###PRS-bw
```{r}
bw_pgs_reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  
 bw_pgs_zscore <- as.data.frame(sapply(test_prs[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")],   function(x) {z_score(x)}))
  x_zscore <- qnorm(x)
  #also omit those cells in bw_zscore to match the two vectors
  bw_pgs_zscore[is.infinite(x_zscore), ] <- lapply(bw_pgs_zscore[is.infinite(x_zscore), ], function(col) replace(col, TRUE, NA))
  x_zscore[is.na(bw_pgs_zscore[,1])] <- NA
  bw_pgs_zscore <- na.omit(bw_pgs_zscore)
  #omit cells with infinite values after applying qnorm
  x_zscore[is.infinite(x_zscore)] <- NA
  x_zscore <- na.omit(x_zscore)

  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4])
})))

bw_pgs_reg_table_full_sig <- bw_pgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_full$bw_pgs_p, method = "BH")
bw_pgs_reg_table_full_sig_MC <- bw_pgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)
```

```{r}
bw_pgs_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_reg_table_full_sig_MC[!(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with BW_pgs")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with BW_pgs")
```

###PRS-ga
```{r}
ga_pgs_reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  
   ga_pgs_zscore <- as.data.frame(sapply(test_prs[,c("ga_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")],   function(x) {z_score(x)}))
   
  x_zscore <- qnorm(x)
  
  #also omit those cells in ga_zscore to match the two vectors
  ga_pgs_zscore[is.infinite(x_zscore), ] <- lapply(ga_pgs_zscore[is.infinite(x_zscore), ], function(col) replace(col, TRUE, NA))
  x_zscore[is.na(ga_pgs_zscore[,1])] <- NA
  ga_pgs_zscore <- na.omit(ga_pgs_zscore)
  #omit cells with infinite values after applying qnorm
  x_zscore[is.infinite(x_zscore)] <- NA
  x_zscore <- na.omit(x_zscore)
  lm <- lm(x_zscore ~ ga_pgs_zscore$ga_pgs + ga_pgs_zscore$PC1 + ga_pgs_zscore$PC2 + ga_pgs_zscore$PC3 + ga_pgs_zscore$PC4 + ga_pgs_zscore$PC5 + ga_pgs_zscore$PC6 + ga_pgs_zscore$PC7 + ga_pgs_zscore$PC8 + ga_pgs_zscore$PC9 + ga_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(ga_pgs_beta = summary$coefficients[2,1], ga_pgs_p = summary$coefficients[2,4])
})))

ga_pgs_reg_table_full_sig <- ga_pgs_reg_table_full %>% filter(ga_pgs_p < 0.05)
ga_pgs_reg_table_full$ga_pgs_p_adj <- p.adjust(ga_pgs_reg_table_full$ga_pgs_p, method = "BH")
ga_pgs_reg_table_full_sig_MC <- ga_pgs_reg_table_full %>% filter(ga_pgs_p_adj < 0.05)
```

```{r}
ga_pgs_reg_table_full_sig$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_pgs_reg_table_full_sig)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(ga_pgs_reg_table_full_sig, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_pgs_reg_table_full_sig, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_pgs_reg_table_full_sig[!(ga_pgs_reg_table_full_sig$label %in% plot_data_dkt$label) & !(ga_pgs_reg_table_full_sig$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_pgs_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with GA_pgs, pre-MC")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_pgs_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA_pgs, pre-MC")
```
###general P-factor
```{r}
gp_reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl(".t2_centiles", names(test_prs))], function(x) {
  
  gp_zscore <- z_score(test_prs$General_p)
  x_zscore <- qnorm(x)
  #also omit those cells in gp_zscore to match the two vectors
  gp_zscore[is.infinite(x_zscore)] <- NA
  gp_zscore[is.na(x_zscore)] <- NA
  x_zscore[is.na(gp_zscore)] <- NA
  gp_zscore <- na.omit(gp_zscore)
  
  #omit cells with infinite values after applying qnorm
  x_zscore[is.infinite(x_zscore)] <- NA
  x_zscore <- na.omit(x_zscore)
  
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4])
})))

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)
```

```{r}
gp_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with gp")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with gp")
```

##With Covariates
###BW as cov
```{r}
#regression
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bw_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4])
})))

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)
```

###Visualize on the brain
###GA coefs
```{r}
reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "Regions with GA")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with GA")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA")
```
####BW coefs
```{r}
bw_reg_table_full_sig <- reg_table_full %>% filter(bw_p < 0.05)
reg_table_full$bw_p_adj <- p.adjust(reg_table_full$bw_p, method = "BH")
bw_reg_table_full_sig_MC <- reg_table_full %>% filter(bw_p_adj < 0.05)

bw_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(bw_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#bw_regions not matched in atlases
bw_reg_table_full_sig_MC[!(bw_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with BW")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with BW")
```

###BW-Percentile as cov
```{r}
#regression
bwp_ga_reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  ga_zscore <- z_score(test_prs$gestAge)
  bwp_zscore <- qnorm(test_prs$bweight_percentile)
  x_zscore <- qnorm(x)
  
  #also omit those cells in ga_zscore and bwp_zscore to match the two vectors
  ga_zscore[is.infinite(x_zscore)] <- NA
  ga_zscore[is.infinite(bwp_zscore)] <- NA
  ga_zscore[is.na(bwp_zscore)] <- NA
  ga_zscore[is.na(x_zscore)] <- NA
  bwp_zscore[is.na(ga_zscore)] <- NA
  x_zscore[is.na(ga_zscore)] <- NA
  ga_zscore <- na.omit(ga_zscore)
  
  bwp_zscore[is.infinite(x_zscore)] <- NA
  bwp_zscore[is.infinite(bwp_zscore)] <- NA
  bwp_zscore[is.na(x_zscore)] <- NA
  x_zscore[is.na(bwp_zscore)] <- NA
  x_zscore[is.infinite(bwp_zscore)] <- NA
  bwp_zscore <- na.omit(bwp_zscore)

  #omit cells with infinite values after applying qnorm
  x_zscore[is.infinite(x_zscore)] <- NA
  x_zscore <- na.omit(x_zscore)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

ga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full$ga_p_adj <- p.adjust(bwp_ga_reg_table_full$ga_p, method = "BH")
bwp_ga_reg_table_full$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full$bwp_p, method = "BH")
ga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(bwp_p < 0.05)
bwpga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(bwp_p_adj < 0.05)
```

####Visualize on the brain
#####GA coefs
```{r}
ga_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(ga_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full_sig_MC[!(ga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "Regions with GA")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with GA")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA")
```
###bwp coefs
```{r}

bwpga_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(bwpga_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full_sig_MC[!(bwpga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bwp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with BW Percentile")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bwp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with BW Percentile")
```

###NeoComp as cov
Look at the predicted centiles (from cross model) with GA, whole sample
```{r}
#regression
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
reg_table_full <- as.data.frame(t(sapply(full_test_df[, grepl("centiles", names(full_test_df))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + neo_comp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], neo_comp_beta = summary$coefficients[3,1], neo_comp_p = summary$coefficients[3,4])
})))

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full$neo_comp_p_adj <- p.adjust(reg_table_full$neo_comp_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)
```

###Visualize on the brain
###GA coefs
```{r}
reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "Regions with GA")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with GA")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA")
```


###NeoComp coefs
```{r}
neo_comp_reg_table_full_sig <- reg_table_full %>% filter(neo_comp_p < 0.05)
neo_comp_reg_table_full_sig_MC <- reg_table_full %>% filter(neo_comp_p_adj < 0.05)

neo_comp_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(neo_comp_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(neo_comp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(neo_comp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#neo_comp_regions not matched in atlases
neo_comp_reg_table_full_sig_MC[!(neo_comp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(neo_comp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = neo_comp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with Neo Comp")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = neo_comp_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with Neo Comp")
```


###BW and Neo Comp as Covar
```{r}
#regression
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
reg_table_full <- as.data.frame(t(sapply(full_test_df[, grepl("centiles", names(full_test_df))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bw_zscore + neo_comp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], neo_comp_beta = summary$coefficients[4,1], neo_comp_p = summary$coefficients[4,4])
})))

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)
```

###Visualize on the brain
###GA coefs
```{r}
reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub("_centiles", "", rownames(reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "Regions with GA")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with GA")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA")
```


##GA*BW interaction model
```{r}
#regression
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
reg_table_full <- as.data.frame(t(sapply(test_prs[, grepl("centiles", names(test_prs))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore*bw_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], gabw_beta = summary$coefficients[4,1], gabw_p = summary$coefficients[4,4])
})))

ga_reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
bw_reg_table_full_sig <- reg_table_full %>% filter(bw_p < 0.05)
gabw_reg_table_full_sig <- reg_table_full %>% filter(gabw_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full$bw_p_adj <- p.adjust(reg_table_full$bw_p, method = "BH")
reg_table_full$gabw_p_adj <- p.adjust(reg_table_full$gabw_p, method = "BH")
ga_reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)
bw_reg_table_full_sig_MC <- reg_table_full %>% filter(bw_p_adj < 0.05)
gabw_reg_table_full_sig_MC <- reg_table_full %>% filter(gabw_p_adj < 0.05)
```

###Visualize on the brain
####GA coefs
```{r}
ga_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(ga_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#ga_regions not matched in atlases
ga_reg_table_full_sig_MC[!(ga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),c("ga_beta", "ga_p", "label")]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "ga_regions with GA")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical ga_regions with GA")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with GA")
```
####BW coefs
```{r}
bw_reg_table_full_sig_MC$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_reg_table_full_sig_MC)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#bw_regions not matched in atlases
bw_reg_table_full_sig_MC[!(bw_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full_sig_MC$label %in% plot_data_aseg$label),c("bw_beta", "bw_p", "label")]

#Setting manual limits (could match the colorbar limits between different variables)
# Plot using ggseg
# ggplot(plot_data) +
#   geom_brain(atlas = dk, 
#              position = position_brain(hemi ~ side),
#              aes(fill = correlation.rho)) +
#   scale_fill_gradient2(limits = c(-0.2, 0.2)) +
#   theme_void() +
#   labs(title = "bw_regions with bw")

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical bw_regions with bw")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with bw")
```
####Interaction
13 regions significant, but only 1 after correcting for MC
```{r}
gabw_reg_table_full_sig$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gabw_reg_table_full_sig)), name_mapping$abbreviation)]

#merge with atlas data
plot_data_dkt <- merge(gabw_reg_table_full_sig, ggseg::dk, by = "label")
plot_data_aseg <- merge(gabw_reg_table_full_sig, ggseg::aseg, by = "label")

#gabw_regions not matched in atlases
gabw_reg_table_full_sig[!(gabw_reg_table_full_sig$label %in% plot_data_dkt$label) & !(gabw_reg_table_full_sig$label %in% plot_data_aseg$label),c("gabw_beta", "gabw_p", "label")]

# Plot using ggseg
ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gabw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Cortical Regions with gabw")

ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gabw_beta)) +
  scale_fill_gradient2() +
  theme_void() +
  labs(title = "Subcortical with gabw")
```


####visualize the interaction
```{r}
vars <- rownames(gabw_reg_table_full_sig)
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
interaction_plots <-  vector(mode = "list", length = length(vars))
for (i in 1:length(vars)){
  x <- test_prs[,grepl(vars[i], names(test_prs))]
  y_label <- name_mapping$region_name[match(sub(".t2_centiles", "", vars[i]), name_mapping$abbreviation)]
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore*bw_zscore)
  summary <- summary(lm)
  interaction_plots[[i]] <- interact_plot(lm, pred = ga_zscore, modx = bw_zscore) + ylab(y_label) + ggtitle(paste0("gabw beta = ", as.character(signif(summary$coefficients[4,1], 3))))
}

n <- length(interaction_plots)
nCol <- floor(sqrt(n))
do.call("grid.arrange", c(interaction_plots, ncol=nCol))
```


#Behavioral
##Define behavioral variables
```{r}
beh_vars<-c("Factor1","Factor2","Factor3","Factor4","Factor5","Factor6","Factor7","Factor8","General_p","anxdep","withdep","somatic","social","thought","attention","rulebreak","aggressive","totprob")
```
##General P Factor
```{r}
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
bw_zscore2 <- bw_zscore^2
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
lm_ga <- lm(General_p ~ ga_zscore, data = test_prs)
summary(lm_ga)

plot(ga_zscore, test_prs$General_p)

lm_bw <- lm(General_p ~ bw_zscore, data = test_prs)
summary(lm_bw)
plot(lm_bw)

plot(bw_zscore, test_prs$General_p)

lm_neo <- lm(General_p ~ neo_comp_zscore, data = test_prs)
summary(lm_neo)

plot(neo_comp_zscore, test_prs$General_p)

lm_gabw <- lm(General_p ~ ga_zscore + bw_zscore, data = test_prs)
summary(lm_gabw)

lm_gabwneo <- lm(General_p ~ ga_zscore + bw_zscore + neo_comp_zscore, data = test_prs)
summary(lm_gabwneo)

lm_bwneo <- lm(General_p ~  bw_zscore + neo_comp_zscore, data = test_prs)
summary(lm_bwneo)

lm_ganeo <- lm(General_p ~ ga_zscore + neo_comp_zscore, data = test_prs)
summary(lm_ganeo)
```

##Cognitive Stuff
- Want to look at the cognitive domains agains bw, ga, and neo_comp


##General P Factor
```{r}
ga_zscore <- z_score(test_prs$gestAge)
bw_zscore <- z_score(test_prs$birth_weight_lbs)
bw_zscore2 <- bw_zscore^2
neo_comp_zscore <- z_score(test_prs$neonatal_comp_total)
lm_ga <- lm(General_p ~ ga_zscore, data = test_prs)
summary(lm_ga)

plot(ga_zscore, test_prs$General_p)

lm_bw <- lm(General_p ~ bw_zscore, data = test_prs)
summary(lm_bw)
plot(lm_bw)

plot(bw_zscore, test_prs$General_p)

lm_neo <- lm(General_p ~ neo_comp_zscore, data = test_prs)
summary(lm_neo)

plot(neo_comp_zscore, test_prs$General_p)

lm_gabw <- lm(General_p ~ ga_zscore + bw_zscore, data = test_prs)
summary(lm_gabw)

lm_gabwneo <- lm(General_p ~ ga_zscore + bw_zscore + neo_comp_zscore, data = test_prs)
summary(lm_gabwneo)

lm_bwneo <- lm(General_p ~  bw_zscore + neo_comp_zscore, data = test_prs)
summary(lm_bwneo)

lm_ganeo <- lm(General_p ~ ga_zscore + neo_comp_zscore, data = test_prs)
summary(lm_ganeo)
```
