---
title: "all models results"
author: "Eren Kafadar"
date: "2025-06-23"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
diagnostics <- FALSE
generate <- FALSE
save_tables <- FALSE
knitr::opts_chunk$set(echo = TRUE)
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(gamlss) #to fit model
require(gamlss.ggplots)
library(splines)
library(tidyr)
library(gamlssTools) #Margaret's package
#For figures/plotting
library(ggplot2)
library(gridExtra)
library(ggsegDKT)
library(ggseg)
library(ggcorrplot)
library(cowplot)
library(egg)
library(interactions)
library(growthstandards)
library(gtsummary)

source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/inspect_model_fits.R")
source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/gamlss_functions_EK.R")
source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/data_functions.R")

source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/pred_og_centile_EK.R")

#df to map variable names onto names displayed on figures
name_mapping <- data.frame(
  abbreviation = c(
     "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_cdk_total",   
     "totalWM_cb", "totalWM_crb", "totalGM_crb",
     
    "smri_vol_scs_cbwmatterlh", "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_csf",
    "smri_vol_scs_lesionlh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_cbwmatterrh", "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh", "smri_vol_scs_lesionrh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_wmhint",
    "smri_vol_scs_wmhintlh", "smri_vol_scs_wmhintrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat", 
    
    "smri_vol_scs_wholeb", "smri_vol_scs_latventricles",
    "smri_vol_scs_allventricles", "smri_vol_scs_intracranialv", "smri_vol_scs_suprateialv",
    "smri_vol_scs_subcorticalgv",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  ),
  region_name = c(
    "Left-Cerebral_Cortex", "Right-Cerebral-Cortex", "Total-Cerebral-Cortex",
    "Total_Cerebral-WM", "Total_Cerebellum-WM", "Total-Cerebellum-Cortex",
    
    "Left-Cerebral-White-Matter", "Left-Lateral-Ventricle", "Left-Inf-Lat-Vent",
    "Left-Cerebellum-White-Matter", "Left-Cerebellum-Cortex", "Left-Thalamus-Proper",
    "Left-Caudate", "Left-Putamen", "Left-Pallidum",
    "x3rd-ventricle", "x4th-ventricle", "Brain-Stem",
    "Left-Hippocampus", "Left-Amygdala", "Cerebrospinal-Fluid",
    "Left-Lesion", "Left-Accumbens-Area", "Left-VentralDC",
    
   "Right-Cerebral-White-Matter", "Right-Lateral-Ventricle", "Right-Inf-Lat-Vent",
    "Right-Cerebellum-White-Matter", "Right-Cerebellum-Cortex", "Right-Thalamus-Proper",
    "Right-Caudate", "Right-Putamen", "Right-Pallidum",
    "Right-Hippocampus", "Right-Amygdala",
    "Right-Lesion", "Right-Accumbens-Area", "Right-VentralDC",
    
    "WM-Hypointensities","Left-WM-Hypointensities", "Right-WM-Hypointensities",
   
   "CC_Posterior","CC_Mid_Posterior", "CC_Central", "CC_Mid_Anterior",
    "CC_Anterior", 
   
   "WholeBrain", "LatVentricles","AllVentricles", "IntracranialVolume", 
   "SupratentorialVolume", "SubcorticalGrayVolume",
   
     "lh_bankssts", "lh_caudalanteriorcingulate", "lh_caudalmiddlefrontal",
    "lh_cuneus", "lh_entorhinal", "lh_fusiform",
    "lh_inferiorparietal", "lh_inferiortemporal", "lh_isthmuscingulate",
    "lh_lateraloccipital", "lh_lateralorbitofrontal", "lh_lingual",
    "lh_medialorbitofrontal", "lh_middletemporal", "lh_parahippocampal",
    "lh_paracentral", "lh_parsopercularis", "lh_parsorbitalis",
    "lh_parstriangularis", "lh_pericalcarine", "lh_postcentral",
    "lh_posteriorcingulate", "lh_precentral", "lh_precuneus", "lh_rostralanteriorcingulate",
    "lh_rostralmiddlefrontal", "lh_superiorfrontal", "lh_superiorparietal",
    "lh_superiortemporal", "lh_supramarginal", "lh_frontalpole",
    "lh_temporalpole", "lh_transversetemporal", "lh_insula",
   
     "rh_bankssts", "rh_caudalanteriorcingulate", "rh_caudalmiddlefrontal",
    "rh_cuneus", "rh_entorhinal", "rh_fusiform",
    "rh_inferiorparietal", "rh_inferiortemporal", "rh_isthmuscingulate",
    "rh_lateraloccipital", "rh_lateralorbitofrontal", "rh_lingual",
    "rh_medialorbitofrontal", "rh_middletemporal", "rh_parahippocampal",
    "rh_paracentral", "rh_parsopercularis", "rh_parsorbitalis",
    "rh_parstriangularis", "rh_pericalcarine", "rh_postcentral",
    "rh_posteriorcingulate", "rh_precentral", "rh_precuneus", "rh_rostralanteriorcingulate",
    "rh_rostralmiddlefrontal", "rh_superiorfrontal", "rh_superiorparietal",
    "rh_superiortemporal", "rh_supramarginal", "rh_frontalpole",
    "rh_temporalpole", "rh_transversetemporal", "rh_insula"
    )
)

phenotypes_for_MC <- c(
    "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  )

global_phenotypes <- c("smri_vol_cdk_total", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv")

phenotypes_to_fit <- (c(phenotypes_for_MC, global_phenotypes, "smri_vol_scs_wholeb", "smri_vol_scs_intracranialv", "totalWM_crb", "totalGM_crb", "smri_vol_scs_csf", "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_scs_cbwmatterlh", "smri_vol_scs_cbwmatterrh"))
```
#Data Setup
Load all saved centiles data tables for t1, t2, and longitudinal
##T1
###Define files
```{r}
#file paths
splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/gamlss_fits_t1_BCT_vol_splitONE_2.0/"
splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/gamlss_fits_t1_BCT_vol_splitTWO_2.0/"
sOne_fits_stats_filename <- paste0(splitOne_folder, "gamlss_fits_stats_all.csv")
sTwo_fits_stats_filename <- paste0(splitTwo_folder, "gamlss_fits_stats_all.csv")
splitOne_train_filename <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Onetrain2025-06-16.csv"
splitTwo_train_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Twotrain2025-06-16.csv"
splitOne_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Onetest2025-06-16.csv"
splitTwo_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Twotest2025-06-16.csv"

t1.centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/centiles_calculated/t1.volume_centiles_2025-07-07.csv"
```
###Load data frames and clean them up
```{r}
#rename variables and select t1 scans
rename_vec <- c(age = "interview_age", sex = "sex_baseline", site = "site_id_l", nonSingleton = "nonSingleton")

t1.sOne_train_df <- read.csv(splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sOne_train_df$sex <- as.factor(t1.sOne_train_df$sex)
t1.sOne_train_df$site <- as.factor(t1.sOne_train_df$site)
t1.sOne_train_df$age <- as.numeric(t1.sOne_train_df$age)

t1.sTwo_train_df <- read.csv(splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sTwo_train_df$sex <- as.factor(t1.sTwo_train_df$sex)
t1.sTwo_train_df$site <- as.factor(t1.sTwo_train_df$site)
t1.sTwo_train_df$age <- as.numeric(t1.sTwo_train_df$age)

t1.sOne_test_df <- read.csv(splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sOne_test_df$sex <- as.factor(t1.sOne_test_df$sex)
t1.sOne_test_df$site <- as.factor(t1.sOne_test_df$site)
t1.sOne_test_df$age <- as.numeric(t1.sOne_test_df$age)

t1.sTwo_test_df <- read.csv(splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t1")
t1.sTwo_test_df$sex <- as.factor(t1.sTwo_test_df$sex)
t1.sTwo_test_df$site <- as.factor(t1.sTwo_test_df$site)
t1.sTwo_test_df$age <- as.numeric(t1.sTwo_test_df$age)
```
###load saved centiles and merge with full test df (both sOne test and sTwo test)
```{r}
t1.centiles <- read.csv(t1.centiles_filename)  %>% select(-1)
names(t1.centiles) <- sub("_centiles", ".t1_centiles", names(t1.centiles))
t1.full_test_df <- rbind(t1.sOne_test_df,t1.sTwo_test_df)
t1.full_test_df <- merge(t1.centiles, t1.full_test_df, by = "src_subject_id")
```
###recalculate birthweight metrics
```{r}
t1.full_test_df$birth_weight_oz_adj <- t1.full_test_df$birth_weight_oz
t1.full_test_df[which(is.na(t1.full_test_df$birth_weight_oz) & !is.na(t1.full_test_df$birth_weight_lbs)), "birth_weight_oz_adj"] <- 8
t1.full_test_df$birth_weight_oz_sum_adj <- t1.full_test_df$birth_weight_lbs*16 + t1.full_test_df$birth_weight_oz_adj
```
##T2
###Define files
```{r}
#file paths
t2.splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/gamlss_fits_t2_BCT_vol_splitONE_2.0/"
t2.splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/gamlss_fits_t2_BCT_vol_splitTWO_2.0/"
t2.sOne_fits_stats_filename <- paste0(t2.splitOne_folder, "gamlss_fits_stats_all.csv")
t2.sTwo_fits_stats_filename <- paste0(t2.splitTwo_folder, "gamlss_fits_stats_all.csv")

splitOne_train_filename <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Onetrain2025-06-16.csv"
splitTwo_train_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Twotrain2025-06-16.csv"
splitOne_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Onetest2025-06-16.csv"
splitTwo_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_long_Twotest2025-06-16.csv"

t2.centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/centiles_calculated/t2.volume_centiles_2025-07-08.csv"
```
### Load data frames and clean them up
```{r}
#rename variables and select t2 scans
rename_vec <- c(age = "interview_age", sex = "sex_baseline", site = "site_id_l", nonSingleton = "nonSingleton")

t2.sOne_train_df <- read.csv(splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sOne_train_df$sex <- as.factor(t2.sOne_train_df$sex)
t2.sOne_train_df$site <- as.factor(t2.sOne_train_df$site)
t2.sOne_train_df$age <- as.numeric(t2.sOne_train_df$age)

t2.sTwo_train_df <- read.csv(splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sTwo_train_df$sex <- as.factor(t2.sTwo_train_df$sex)
t2.sTwo_train_df$site <- as.factor(t2.sTwo_train_df$site)
t2.sTwo_train_df$age <- as.numeric(t2.sTwo_train_df$age)

t2.sOne_test_df <- read.csv(splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sOne_test_df$sex <- as.factor(t2.sOne_test_df$sex)
t2.sOne_test_df$site <- as.factor(t2.sOne_test_df$site)
t2.sOne_test_df$age <- as.numeric(t2.sOne_test_df$age)

t2.sTwo_test_df <- read.csv(splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "t2")
t2.sTwo_test_df$sex <- as.factor(t2.sTwo_test_df$sex)
t2.sTwo_test_df$site <- as.factor(t2.sTwo_test_df$site)
t2.sTwo_test_df$age <- as.numeric(t2.sTwo_test_df$age)
```
###load saved centiles and merge with full test df (both sOne test and sTwo test)
```{r}
t2.centiles <- read.csv(t2.centiles_filename)  %>% select(-1)
names(t2.centiles) <- sub("_centiles", ".t2_centiles", names(t2.centiles))
t2.full_test_df <- rbind(t2.sOne_test_df,t2.sTwo_test_df)
t2.full_test_df <- merge(t2.centiles, t2.full_test_df, by = "src_subject_id")
```
###add birthweight metrics from t1 table
```{r}
t2.full_test_df$birth_weight_oz_sum_adj <- t1.full_test_df$birth_weight_oz_sum_adj[match(t2.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
```

##LONG
###Define files
```{r}
#file paths
long.splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/gamlss_fits_long_vol_splitONE_2.0/"
long.splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/gamlss_fits_long_vol_splitTWO_2.0/"
long.sOne_fits_stats_filename <- paste0(long.splitOne_folder, "gamlss_fits_stats_all.csv")
long.sTwo_fits_stats_filename <- paste0(long.splitTwo_folder, "gamlss_fits_stats_all.csv")

long.splitOne_train_filename <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_wide_Onetrain2025-06-17.csv"
long.splitTwo_train_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_wide_Twotrain2025-06-17.csv"
long.splitOne_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_wide_Onetest2025-06-17.csv"
long.splitTwo_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1_2.0/abcd_wide_Twotest2025-06-17.csv"

long.centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/centiles_calculated/long.volume_centiles_2025-07-08.csv"
```
### Load data frames and clean them up
```{r}
#rename variables and select long scans
rename_vec <- c(age = "interview_age.t2", sex = "sex_baseline", site = "site_id_l.t2")

long.sOne_train_df <- read.csv(long.splitOne_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sOne_train_df$sex <- as.factor(long.sOne_train_df$sex)
long.sOne_train_df$site <- as.factor(long.sOne_train_df$site)
long.sOne_train_df$age <- as.numeric(long.sOne_train_df$age)

long.sTwo_train_df <- read.csv(long.splitTwo_train_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sTwo_train_df$sex <- as.factor(long.sTwo_train_df$sex)
long.sTwo_train_df$site <- as.factor(long.sTwo_train_df$site)
long.sTwo_train_df$age <- as.numeric(long.sTwo_train_df$age)

long.sOne_test_df <- read.csv(long.splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sOne_test_df$sex <- as.factor(long.sOne_test_df$sex)
long.sOne_test_df$site <- as.factor(long.sOne_test_df$site)
long.sOne_test_df$age <- as.numeric(long.sOne_test_df$age)

long.sTwo_test_df <- read.csv(long.splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec))
long.sTwo_test_df$sex <- as.factor(long.sTwo_test_df$sex)
long.sTwo_test_df$site <- as.factor(long.sTwo_test_df$site)
long.sTwo_test_df$age <- as.numeric(long.sTwo_test_df$age)
```
###load saved centiles and merge with full test df (both sOne test and sTwo test)
```{r}
long.centiles <- read.csv(long.centiles_filename)  %>% select(-1)
names(long.centiles) <- sub(".t2_centiles", ".long_centiles", names(long.centiles))
long.full_test_df <- rbind(long.sOne_test_df,long.sTwo_test_df)
long.full_test_df <- merge(long.centiles, long.full_test_df, by = "src_subject_id")
```
####add birthweight metrics from t1 table
```{r}
long.full_test_df$birth_weight_oz_sum_adj <- t1.full_test_df$birth_weight_oz_sum_adj[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
```
##Combine dataframes
```{r}
t1.full_test_df <- t1.full_test_df %>% rename(age.t1 = age, site.t1 = site)
t2.full_test_df_merge <- t2.full_test_df %>% rename(age.t2 = age, site.t2 = site) %>%
  select(-c("split_ID", "sex", "gestAge", "PTB", "twin_statusFAM", "twin_statusP", "triplet_statusFAM", "rel_family_id", "rel_birth_id", "nonSingleton", "scrn_birthcomp", "birth_weight_oz_adj", "birth_weight_oz_sum_adj", "neonatal_comp_total", "bw_pgs", "ga_pgs", "bw_pgs_resd", "ga_pgs_resd", "PC1", "PC2", "PC3", "PC4", "PC5","PC6","PC6", "PC7", "PC7", "PC8", "PC9", "PC10", "matched_group", "handedness", "parental_education"))
shared_names = c("src_subject_id")
full.df <- merge(t1.full_test_df, t2.full_test_df_merge, by = shared_names, all.x = TRUE, suffixes = c(".t1",".t2"))

#add longitudinal centiles
long.full_test_df_tomerge <- long.full_test_df %>% select(c(names(long.full_test_df)[grepl(".long_centiles", names(long.full_test_df))], "interscan_months_t1t2", "src_subject_id"))
full.df <- merge(full.df, long.full_test_df_tomerge, by = shared_names, all.x = TRUE)
```

##SES Variables
Income and Parental Education
0 = Never attended/Kindergarten only Nunca asist‚àö‚â†/Kinder solamente ; 1 = 1st grade 1.er grado ; 2 = 2nd grade 2.¬¨‚à´ grado ; 3 = 3rd grade 3.er grado ; 4 = 4th grade 4.¬¨‚à´ grado ; 5 = 5th grade 5.¬¨‚à´ grado ; 6 = 6th grade 6.¬¨‚à´ grado ; 7 = 7th grade 7.¬¨‚à´ grado ; 8 = 8th grade 8.¬¨‚à´ grado ; 9 = 9th grade 9.¬¨‚à´ grado ; 10 = 10th grade 10.¬¨‚à´ grado ; 11 = 11th grade 11.¬¨‚à´ grado ; 12 = 12th grade; 13 = High school graduate Preparatoria terminada ; 14 = GED or equivalent Diploma General de Equivalencia (GED) o equivalente ; 15 = Some college; 16 = Associate degree: Occupational; 17 = Associate degree: Academic Program T‚àö‚â†tulo de asociado: programa acad‚àö¬©mico ; 18 = Bachelor's degree (ex. BA; 19 = Master's degree (ex. MA; 20 = Professional School degree (ex. MD; 21 = Doctoral degree (ex. PhD; 777 = Refused to answer Prefiero no responder

1 = Less than $5,000 ; 2 = $5,000 through $11,999 ; 3 = $12,000 through $15,999 ; 4 = $16,000 through $24,999 ; 5 = $25,000 through $34,999 ; 6 = $35,000 through $49,999 ; 7 = $50,000 through $74,999 ; 8 = $75,000 through $99,999 ; 9 = $100,000 through $199,999 ; 10 = $200,000 and greater ; 999, Don't know ; 777, Refuse to answer
###Check variables names & change between timepoints
```{r}
abcd_demo_file <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/raw_tables_5.1/abcd_p_demo.csv"
abcd_demo <- read.csv(abcd_demo_file)

#check how many people changed categories between timepoint 1 and timepoint 2
t2.abcd_demo <- abcd_demo %>% filter(eventname == "2_year_follow_up_y_arm_1")
t1.abcd_demo <- abcd_demo %>% filter(eventname == "baseline_year_1_arm_1") %>%
  filter(src_subject_id %in% t2.abcd_demo$src_subject_id)

income_change <- t2.abcd_demo$demo_comb_income_v2_l - t1.abcd_demo$demo_comb_income_v2
hist(income_change, xlim = c(-10,10), breaks = 20000)
prnt_edu_change <- t2.abcd_demo$demo_prnt_ed_v2_2yr_l - t1.abcd_demo$demo_prnt_ed_v2
hist(prnt_edu_change, xlim = c(-20,20), breaks = 20000)
prtnr_edu_change <- t2.abcd_demo$demo_prtnr_ed_v2_2yr_l - t1.abcd_demo$demo_prtnr_ed_v2
hist(prtnr_edu_change, xlim = c(-20,20), breaks = 20000)
```
###Change encoding of variables
```{r}
abcd_demo <- abcd_demo %>%
  mutate(t1.income_label = case_when(
    demo_comb_income_v2 == 1 ~ "Less than $5,000",
    demo_comb_income_v2 == 2 ~ "$5,000 through $11,999",
    demo_comb_income_v2 == 3 ~ "$12,000 through $15,999",
    demo_comb_income_v2 == 4 ~ "$16,000 through $24,999",
    demo_comb_income_v2 == 5 ~ "$25,000 through $34,999",
    demo_comb_income_v2 == 6 ~ "$35,000 through $49,999",
    demo_comb_income_v2 == 7 ~ "$50,000 through $74,999",
    demo_comb_income_v2 == 8 ~ "$75,000 through $99,999",
    demo_comb_income_v2 == 9 ~ "$100,000 through $199,999",
    demo_comb_income_v2 == 10 ~ "$200,000 and greater",
    demo_comb_income_v2 == 999 ~ "Don't know",
    demo_comb_income_v2 == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_comb_income_v2)  # Default case, if none of the above match
  ))

abcd_demo <- abcd_demo %>%
  mutate(t2.income_label = case_when(
    demo_comb_income_v2_l == 1 ~ "Less than $5,000",
    demo_comb_income_v2_l == 2 ~ "$5,000 through $11,999",
    demo_comb_income_v2_l == 3 ~ "$12,000 through $15,999",
    demo_comb_income_v2_l == 4 ~ "$16,000 through $24,999",
    demo_comb_income_v2_l == 5 ~ "$25,000 through $34,999",
    demo_comb_income_v2_l == 6 ~ "$35,000 through $49,999",
    demo_comb_income_v2_l == 7 ~ "$50,000 through $74,999",
    demo_comb_income_v2_l == 8 ~ "$75,000 through $99,999",
    demo_comb_income_v2_l == 9 ~ "$100,000 through $199,999",
    demo_comb_income_v2_l == 10 ~ "$200,000 and greater",
    demo_comb_income_v2_l == 999 ~ "Don't know",
    demo_comb_income_v2_l == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_comb_income_v2_l)  # Default case, if none of the above match
  ))

abcd_demo <- abcd_demo %>%
  mutate(t1.prnt_edu_label = case_when(
    demo_prnt_ed_v2 == 0 ~ "Never attended/Kindergarten only",
    demo_prnt_ed_v2 == 1 ~ "1st grade",
    demo_prnt_ed_v2 == 2 ~ "2nd grade",
    demo_prnt_ed_v2 == 3 ~ "3rd grade",
    demo_prnt_ed_v2 == 4 ~ "4th grade",
    demo_prnt_ed_v2 == 5 ~ "5th grade",
    demo_prnt_ed_v2 == 6 ~ "6th grade",
    demo_prnt_ed_v2 == 7 ~ "7th grade",
    demo_prnt_ed_v2 == 8 ~ "8th grade",
    demo_prnt_ed_v2 == 9 ~ "9th grade",
    demo_prnt_ed_v2 == 10 ~ "10th grade",
    demo_prnt_ed_v2 == 11 ~ "11th grade",
    demo_prnt_ed_v2 == 12 ~ "12th grade, no diploma",
    demo_prnt_ed_v2 == 13 ~ "High school graduate",
    demo_prnt_ed_v2 == 14 ~ "GED or equivalent",
    demo_prnt_ed_v2 == 15 ~ "Some college",
    demo_prnt_ed_v2 == 16 ~ "Associate degree: Occupational, Technical, or Vocational",
    demo_prnt_ed_v2 == 17 ~ "Associate degree: Academic Program",
    demo_prnt_ed_v2 == 18 ~ "Bachelor's degree (ex. BA, AB, BS, BBS)",
    demo_prnt_ed_v2 == 19 ~ "Master's degree (ex. MA, MS, MEng, MEd, MBA)",
    demo_prnt_ed_v2 == 20 ~ "Professional School degree (ex. MD, DDS, DVN, JD)",
    demo_prnt_ed_v2 == 21 ~ "Doctoral degree (ex. PhD, EdD)",
    demo_prnt_ed_v2 == 999 ~ "Don't know",
    demo_prnt_ed_v2 == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_prnt_ed_v2)  # Default case, if none of the above match
  ))

abcd_demo <- abcd_demo %>%
  mutate(t2.prnt_edu_label = case_when(
    demo_prnt_ed_v2_2yr_l == 0 ~ "Never attended/Kindergarten only",
    demo_prnt_ed_v2_2yr_l == 1 ~ "1st grade",
    demo_prnt_ed_v2_2yr_l == 2 ~ "2nd grade",
    demo_prnt_ed_v2_2yr_l == 3 ~ "3rd grade",
    demo_prnt_ed_v2_2yr_l == 4 ~ "4th grade",
    demo_prnt_ed_v2_2yr_l == 5 ~ "5th grade",
    demo_prnt_ed_v2_2yr_l == 6 ~ "6th grade",
    demo_prnt_ed_v2_2yr_l == 7 ~ "7th grade",
    demo_prnt_ed_v2_2yr_l == 8 ~ "8th grade",
    demo_prnt_ed_v2_2yr_l == 9 ~ "9th grade",
    demo_prnt_ed_v2_2yr_l == 10 ~ "10th grade",
    demo_prnt_ed_v2_2yr_l == 11 ~ "11th grade",
    demo_prnt_ed_v2_2yr_l == 12 ~ "12th grade, no diploma",
    demo_prnt_ed_v2_2yr_l == 13 ~ "High school graduate",
    demo_prnt_ed_v2_2yr_l == 14 ~ "GED or equivalent",
    demo_prnt_ed_v2_2yr_l == 22 ~ "Less than 1 year of college credit/post-secondary education (or less than 10 classes)",
    demo_prnt_ed_v2_2yr_l == 23 ~ "One year or more of college credit, no degree",
    demo_prnt_ed_v2_2yr_l == 16 ~ "Associate degree: Occupational, Technical, or Vocational",
    demo_prnt_ed_v2_2yr_l == 17 ~ "Associate degree: Academic Program",
    demo_prnt_ed_v2_2yr_l == 18 ~ "Bachelor's degree (ex. BA, AB, BS, BBS)",
    demo_prnt_ed_v2_2yr_l == 19 ~ "Master's degree (ex. MA, MS, MEng, MEd, MBA)",
    demo_prnt_ed_v2_2yr_l == 20 ~ "Professional School degree (ex. MD, DDS, DVN, JD)",
    demo_prnt_ed_v2_2yr_l == 21 ~ "Doctoral degree (ex. PhD, EdD)",
    demo_prnt_ed_v2_2yr_l == 999 ~ "Don't know",
    demo_prnt_ed_v2_2yr_l == 777 ~ "Refuse to answer",
    TRUE ~ as.character(demo_prnt_ed_v2_2yr_l)  # Default case, if none of the above match
  ))



```
###Add variables to data frames
set "no response" to NA
make the factors ordered
```{r}
abcd_demo$t1.income_label_NAs <- ifelse(abcd_demo$t1.income_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t1.income_label)
abcd_demo$t2.income_label_NAs <- ifelse(abcd_demo$t2.income_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t2.income_label)

abcd_demo$t1.prnt_edu_label_NAs <- ifelse(abcd_demo$t1.prnt_edu_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t1.prnt_edu_label)
abcd_demo$t2.prnt_edu_label_NAs <- ifelse(abcd_demo$t2.prnt_edu_label %in% c("Don't know", "Refuse to answer"), NA, abcd_demo$t2.prnt_edu_label)

t2.abcd_demo <- abcd_demo %>% filter(eventname == "2_year_follow_up_y_arm_1") %>%
  filter(src_subject_id %in% full.df$src_subject_id)
t1.abcd_demo <- abcd_demo %>% filter(eventname == "baseline_year_1_arm_1")%>%
  filter(src_subject_id %in% full.df$src_subject_id)

income_levels_order <- c("Less than $5,000","$5,000 through $11,999","$12,000 through $15,999", 
  "$16,000 through $24,999","$25,000 through $34,999","$35,000 through $49,999",
  "$50,000 through $74,999","$75,000 through $99,999","$100,000 through $199,999",
  "$200,000 and greater")
t1.prnt_edu_levels_order <- c("Never attended/Kindergarten only","1st grade","2nd grade","3rd grade","4th grade","5th grade","6th grade","7th grade","8th grade","9th grade","10th grade","11th grade","12th grade, no diploma","High school graduate","GED or equivalent","Some college","Associate degree: Occupational, Technical, or Vocational","Associate degree: Academic Program","Bachelor's degree (ex. BA, AB, BS, BBS)",
  "Master's degree (ex. MA, MS, MEng, MEd, MBA)","Professional School degree (ex. MD, DDS, DVN, JD)",
  "Doctoral degree (ex. PhD, EdD)")
t2.prnt_edu_levels_order <- c("Never attended/Kindergarten only","1st grade","2nd grade","3rd grade","4th grade","5th grade","6th grade","7th grade","8th grade","9th grade","10th grade","11th grade","12th grade, no diploma","High school graduate","GED or equivalent","Less than 1 year of college credit/post-secondary education (or less than 10 classes)","One year or more of college credit, no degree","Associate degree: Occupational, Technical, or Vocational","Associate degree: Academic Program","Bachelor's degree (ex. BA, AB, BS, BBS)","Master's degree (ex. MA, MS, MEng, MEd, MBA)","Professional School degree (ex. MD, DDS, DVN, JD)","Doctoral degree (ex. PhD, EdD)")


#Add Income Levels to full df and to t1 / t2 dfs. Set level orders for ordered factor
##T1 Income
full.df$t1.income_ordered <- as.factor(t1.abcd_demo$t1.income_label_NAs[match(full.df$src_subject_id, t1.abcd_demo$src_subject_id)])
full.df$t1.income_ordered <- factor(full.df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

t1.full_test_df$t1.income_ordered <- as.factor(t1.abcd_demo$t1.income_label_NAs[match(t1.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])
t1.full_test_df$t1.income_ordered <- factor(t1.full_test_df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

t2.full_test_df$t1.income_ordered <- as.factor(t1.abcd_demo$t1.income_label_NAs[match(t2.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])
t2.full_test_df$t1.income_ordered <- factor(t2.full_test_df$t1.income_ordered, levels = income_levels_order, ordered = TRUE)

t1.full_test_df$t1.income_label <- as.factor(t1.abcd_demo$t1.income_label[match(t1.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])

t2.full_test_df$t1.income_label <- as.factor(t1.abcd_demo$t1.income_label[match(t2.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])

##T2 Income
full.df$t2.income_ordered <- as.factor(t2.abcd_demo$t2.income_label_NAs[match(full.df$src_subject_id, t2.abcd_demo$src_subject_id)])
full.df$t2.income_ordered <- factor(full.df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)
t2.full_test_df$t2.income_ordered <- as.factor(t2.abcd_demo$t2.income_label_NAs[match(t2.full_test_df$src_subject_id, t2.abcd_demo$src_subject_id)])
t2.full_test_df$t2.income_ordered <- factor(t2.full_test_df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)

t1.full_test_df$t2.income_ordered <- as.factor(t2.abcd_demo$t2.income_label_NAs[match(t1.full_test_df$src_subject_id, t2.abcd_demo$src_subject_id)])
t1.full_test_df$t2.income_ordered <- factor(t1.full_test_df$t2.income_ordered, levels = income_levels_order, ordered = TRUE)

t2.full_test_df$t2.income_label <- as.factor(t2.abcd_demo$t2.income_label[match(t2.full_test_df$src_subject_id, t2.abcd_demo$src_subject_id)])

#Add Parent Education Levels to full df and to t1 / t2 dfs. Set level orders for ordered factor
##T1 Parent Education
full.df$t1.prnt_edu_ordered <- as.factor(t1.abcd_demo$t1.prnt_edu_label_NAs[match(full.df$src_subject_id, t1.abcd_demo$src_subject_id)])
full.df$t1.prnt_edu_ordered <- factor(full.df$t1.prnt_edu_ordered, levels = t1.prnt_edu_levels_order, ordered = TRUE)

t1.full_test_df$t1.prnt_edu_ordered <- as.factor(t1.abcd_demo$t1.prnt_edu_label_NAs[match(t1.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])
t1.full_test_df$t1.prnt_edu_ordered <- factor(t1.full_test_df$t1.prnt_edu_ordered, levels = t1.prnt_edu_levels_order, ordered = TRUE)

t2.full_test_df$t1.prnt_edu_ordered <- as.factor(t1.abcd_demo$t1.prnt_edu_label_NAs[match(t2.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])
t2.full_test_df$t1.prnt_edu_ordered <- factor(t2.full_test_df$t1.prnt_edu_ordered, levels = t1.prnt_edu_levels_order, ordered = TRUE)

t1.full_test_df$t1.prnt_edu_label <- as.factor(t1.abcd_demo$t1.prnt_edu_label[match(t1.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])

t2.full_test_df$t1.prnt_edu_label <- as.factor(t1.abcd_demo$t1.prnt_edu_label[match(t2.full_test_df$src_subject_id, t1.abcd_demo$src_subject_id)])

##T2 Parent Education
full.df$t2.prnt_edu_ordered <- as.factor(t2.abcd_demo$t2.prnt_edu_label_NAs[match(full.df$src_subject_id, t2.abcd_demo$src_subject_id)])
full.df$t2.prnt_edu_ordered <- factor(full.df$t2.prnt_edu_ordered, levels = t2.prnt_edu_levels_order, ordered = TRUE)

t2.full_test_df$t2.prnt_edu_ordered <- as.factor(t2.abcd_demo$t2.prnt_edu_label_NAs[match(t2.full_test_df$src_subject_id, t2.abcd_demo$src_subject_id)])
t2.full_test_df$t2.prnt_edu_ordered <- factor(t2.full_test_df$t2.prnt_edu_ordered, levels = t2.prnt_edu_levels_order, ordered = TRUE)

t1.full_test_df$t2.prnt_edu_ordered <- as.factor(t2.abcd_demo$t2.prnt_edu_label_NAs[match(t1.full_test_df$src_subject_id, t2.abcd_demo$src_subject_id)])
t1.full_test_df$t2.prnt_edu_ordered <- factor(t1.full_test_df$t2.prnt_edu_ordered, levels = t2.prnt_edu_levels_order, ordered = TRUE)

t2.full_test_df$t2.prnt_edu_label <- as.factor(t2.abcd_demo$t2.prnt_edu_label[match(t2.full_test_df$src_subject_id, t2.abcd_demo$src_subject_id)])
```
#Make Table One
by timepoint and split
parental education and income encoding not clear to me
Need to set names for t1/t2 income and parental education as the same name so that the table only shows the relevant income/parental education for each timepoint.
For example t1 income should be called "income" in the t1 table and and t2 income should be called "income" in the t2 table.
```{r}
t1.full_test_df$table_group <- paste0(t1.full_test_df$matched_group, "_t1")
t1.full_test_df <- t1.full_test_df %>% rename(age = age.t1, site = site.t1)
t2.full_test_df$table_group <- paste0(t2.full_test_df$matched_group, "_t2")

names_no_centiles <- names(t1.full_test_df)[-grep("centiles", names(t1.full_test_df))]
table1_df <- rbind(t1.full_test_df %>% select(all_of(names_no_centiles)), 
                   t2.full_test_df %>% select(all_of(names_no_centiles))) %>%
  mutate(age_years = age/12)


# Create Table 1 with additional variables
table1 <- table1_df %>%
  select(table_group, age_years, sex, gestAge, birth_weight_oz_sum_adj, anthroweightcalc, anthroheightcalc, t1.income_ordered, t2.income_ordered, t1.prnt_edu_ordered, t2.prnt_edu_ordered) %>%
  tbl_summary(
    by = table_group,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing = "ifany"
  ) %>%
  bold_labels()

# View Table
table1
```
#Load Global Phenotype Models
##t1 global phenotype models
```{r}
#load saved fits
t1.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/t1_BCT_fits.csv"
t1.all_fits <- read.csv(t1.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% c(global_phenotypes, "smri_vol_scs_wholeb"))
t1.sOne_fits <- t1.all_fits %>% filter(split_no == 1)
t1.sTwo_fits <- t1.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
t1.sOne_best <- t1.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

t1.sTwo_best <- t1.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
t1.sOne_best_list <- paste0(splitOne_folder,"gamlssFIT_",t1.sOne_best$model_index,".rds")
t1.best_models_One <- lapply(t1.sOne_best_list, readRDS)
t1.sTwo_best_list <- paste0(splitTwo_folder,"gamlssFIT_",t1.sTwo_best$model_index,".rds")
t1.best_models_Two <- lapply(t1.sTwo_best_list, readRDS)
```
##t2 global phenotype models
```{r}
#load saved fits
t2.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/t2_BCT_fits.csv"
t2.all_fits <- read.csv(t2.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% c(global_phenotypes, "smri_vol_scs_wholeb"))
t2.sOne_fits <- t2.all_fits %>% filter(split_no == 1)
t2.sTwo_fits <- t2.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
t2.sOne_best <- t2.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

t2.sTwo_best <- t2.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
t2.sOne_best_list <- paste0(t2.splitOne_folder,"gamlssFIT_",t2.sOne_best$model_index,".rds")
t2.best_models_One <- lapply(t2.sOne_best_list, readRDS)
t2.sTwo_best_list <- paste0(t2.splitTwo_folder,"gamlssFIT_",t2.sTwo_best$model_index,".rds")
t2.best_models_Two <- lapply(t2.sTwo_best_list, readRDS)
```
##longitudinal global phenotype models
```{r}
global_t2 <- paste0(c(global_phenotypes, "smri_vol_scs_wholeb"), ".t2")
#load saved fits
long.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/long_fits.csv"
long.all_fits <- read.csv(long.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% global_t2)
long.sOne_fits <- long.all_fits %>% filter(split_no == 1)
long.sTwo_fits <- long.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
long.sOne_best <- long.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

long.sTwo_best <- long.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
long.sOne_best_list <- paste0(long.splitOne_folder,"gamlssFIT_",long.sOne_best$model_index,".rds")
long.best_models_One <- lapply(long.sOne_best_list, readRDS)
long.sTwo_best_list <- paste0(long.splitTwo_folder,"gamlssFIT_",long.sTwo_best$model_index,".rds")
long.best_models_Two <- lapply(long.sTwo_best_list, readRDS)
```
#Explore Centiles Across Models
```{r}
length <- length(grep(".t1_centiles", names(full.df)))
#Ensure all names are in the same order
names <- names(full.df)[grep(".t1_centiles", names(full.df))] %>% sub(".t1_centiles","",.)
names.t1 <- paste0(names, ".t1_centiles")
names.t2 <- paste0(names, ".t2_centiles")
names.long <- paste0(names, ".long_centiles")
plots <- vector(mode = "list", length = length)
plots.long <- vector(mode = "list", length = length)
plots.t2 <- vector(mode = "list", length = length)
plots.t1 <- vector(mode = "list", length = length)
for(i in 1:length){
  t1.vector <- qnorm(full.df[,names.t1[i]])
  t2.vector <- qnorm(full.df[,names.t2[i]])
  title <-  as.character(name_mapping$region_name[match(names[i],  name_mapping$abbreviation)])
  plots[[i]] <- ggplot(mapping = aes(x = t1.vector, y = t2.vector)) + geom_point() + ggtitle(title)
  names(plots)[i] <- title
  col_name <- paste0(names[i], ".diff")
  full.df[[col_name]] <- t2.vector-t1.vector
  long.vector <- qnorm(full.df[,names.long[i]])
  plots.long[[i]]<- ggplot(mapping = aes(x = full.df[,col_name], y = long.vector)) + geom_point() + ggtitle(title) + xlab("t2-t1 centiles")
  names(plots.long)[i] <- title
  plots.t2[[i]]<- ggplot(mapping = aes(x = t1.vector, y = long.vector)) + geom_point() + ggtitle(title)
  names(plots.t2)[i] <- title
  plots.t1[[i]]<- ggplot(mapping = aes(x = t1.vector, y = long.vector)) + geom_point() + ggtitle(title)
  names(plots.t1)[i] <- title}
```
###plot global phenotypes
```{r}
global_labels <- name_mapping$region_name[match(global_phenotypes, name_mapping$abbreviation)]

do.call("grid.arrange", c(plots[names(plots) %in% global_labels], ncol=3))
do.call("grid.arrange", c(plots.long[names(plots.long) %in% global_labels], ncol=3))
do.call("grid.arrange", c(plots.t1[names(plots.t1) %in% global_labels], ncol=3))
do.call("grid.arrange", c(plots.t2[names(plots.t2) %in% global_labels], ncol=3))
```
#Choose individuals to plot
CHOSEN SUBJECTS, all male
decrease in centiles
high long centile
**NDAR_INV79NF4B2M
NDAR_INVVF47E1YM
low long centile
0NDAR_INV3P7XHWPD
NDAR_INV41U1CNA9

increase in centiles
low long centile
NDAR_INVK20NJZWV (site 20)
NDAR_INV38T88Z04 (site 20)
high long centile
NDAR_INV6AC2J61C

no change in centiles
high long centile
NDAR_INV2KJNX54B (site 20)
low long centile
NDAR_INV1BWHMRFY (site 20)
50th long centile
NDAR_INV8KDDNHZY
```{r}
decrease_subjects <- full.df %>% filter((smri_vol_cdk_total.t1_centiles - smri_vol_cdk_total.t2_centiles > 0.1))
hist(decrease_subjects$smri_vol_cdk_total.long_centiles)
decrease_subjects %>% filter(smri_vol_cdk_total.long_centiles > 0.20) %>% select(c("src_subject_id", "sex", "site.t1"))
decrease_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.01) %>% select(c("src_subject_id", "sex", "site.t1"))

increase_subjects <- full.df %>% filter((smri_vol_cdk_total.t2_centiles - smri_vol_cdk_total.t1_centiles > 0.1))
hist(increase_subjects$smri_vol_cdk_total.long_centiles)
increase_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.85) %>% select(c("src_subject_id", "sex", "site.t1"))
increase_subjects %>% filter(smri_vol_cdk_total.long_centiles > 0.99) %>% select(c("src_subject_id", "sex", "site.t1"))


nochange_subjects <- full.df %>% filter(abs(smri_vol_cdk_total.t2_centiles - smri_vol_cdk_total.t1_centiles) < 0.01)
hist(nochange_subjects$smri_vol_cdk_total.long_centiles)
nochange_subjects %>% filter(smri_vol_cdk_total.long_centiles > 0.95) %>% select(c("src_subject_id", "sex", "site.t1"))
nochange_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.05) %>% select(c("src_subject_id", "sex", "site.t1"))
nochange_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.51 & smri_vol_cdk_total.long_centiles > 0.49) %>% select(c("src_subject_id", "sex", "site.t1"))
```
normal t1 and t2, extreme conditional
"NDAR_INV04YC4RXD" 
"NDAR_INV07924XF1" 
"NDAR_INV08DNLREC" 
"NDAR_INV097LUBWX" 
"NDAR_INV0APJMRD1" 
"NDAR_INV0AUBJJJ4"
"NDAR_INV0C7TZ6YW"
extreme t1 & t2, normal conditional
NDAR_INV00HEV6HB
NDAR_INV0191C80U
NDAR_INV02EBX0JJ
NDAR_INV04TRXUGL
NDAR_INV08K0R9C4
NDAR_INV0A4ZDYNL
NDAR_INV0AEBMADL

```{r}
pool1 <- full.df %>% filter((smri_vol_cdk_total.t2_centiles < 0.75 & smri_vol_cdk_total.t2_centiles > 0.25) & (smri_vol_cdk_total.t1_centiles < 0.75 & smri_vol_cdk_total.t1_centiles > 0.25) & (smri_vol_cdk_total.long_centiles > 0.9 | smri_vol_cdk_total.long_centiles < 0.1))

p1 <- ggplot(pool1) + geom_point(aes(x = smri_vol_cdk_total.t1_centiles, y = smri_vol_cdk_total.t2_centiles, color = smri_vol_cdk_total.long_centiles))
p1

pool2 <- full.df %>% filter((smri_vol_cdk_total.t2_centiles > 0.9 | smri_vol_cdk_total.t2_centiles < 0.1) & (smri_vol_cdk_total.t1_centiles > 0.9 | smri_vol_cdk_total.t1_centiles < 0.1) & (smri_vol_cdk_total.long_centiles < 0.75 & smri_vol_cdk_total.long_centiles > 0.25))

p2 <- ggplot(pool2) + geom_point(aes(x = smri_vol_cdk_total.t1_centiles, y = smri_vol_cdk_total.t2_centiles, color = smri_vol_cdk_total.long_centiles))
p2
```

#Plots for Fig 1
##t1 plot
###one plot
```{r}
#plot by timepoint and add the same 3 subjects to each plot
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
##residualize subjects to plot them correctly
model <- t1.best_models_One[[1]]
df <- full.df  %>% select(c("smri_vol_cdk_total.t1", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1, smri_vol_cdk_total = smri_vol_cdk_total.t1)
t1.subjects_resid <- resid_data(model, df, og_data = t1.sOne_train_df, rm_terms = c("sex","site"))
t1.subjects_resid <- t1.subjects_resid %>% filter(src_subject_id %in% subjects)
t1.subjects_resid <- t1.subjects_resid [match(subjects, t1.subjects_resid $src_subject_id), ]

#plot t1
t1.plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="darkgray")
##add subjects and axis labels
t1.plot <- t1.plot + 
  geom_point(aes(x = t1.subjects_resid[1,2], y = t1.subjects_resid[1,1]), color = "#E69F00", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t1.subjects_resid[1,2], y = t1.subjects_resid[1,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[1]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#E69F00") + #orange
  geom_point(aes(x = t1.subjects_resid[2,2], y = t1.subjects_resid[2,1]), color = "#56B4E9", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t1.subjects_resid[2,2], y = t1.subjects_resid[2,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[2]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#56B4E9") + #blue 
  geom_point(aes(x = t1.subjects_resid[3,2], y = t1.subjects_resid[3,1]), color = "#009E73", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t1.subjects_resid[3,2], y = t1.subjects_resid[3,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[4]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#009E73")+ #green
   geom_point(aes(x = t1.subjects_resid[4,2], y = t1.subjects_resid[4,1]), color = "#E0776E", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t1.subjects_resid[4,2], y = t1.subjects_resid[4,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[4]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#E0776E")+ #pink
theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- t1.best_models_One[[1]]
df.t1 <- full.df  %>% select(c("smri_vol_cdk_total.t1", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1, smri_vol_cdk_total = smri_vol_cdk_total.t1)

#subject 1
sub1.t1 <- df.t1 %>% filter(src_subject_id == subjects[1])
sub1_age.t1 <- sub1.t1$age
sub1_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub1.t1  <- sub1.t1 %>% slice(rep(1,100))

#simulate across age
sub1.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub1_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub1.t1))

t1.sub1_plot <- t1.sub1_plot + geom_point(aes(x = sub1_age.t1, y = sub1.t1$smri_vol_cdk_total[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.t1, y = sub1.t1$smri_vol_cdk_total[1], label = round(sub1_centile.t1, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14)) +
    scale_y_continuous(
    breaks = seq(450000, 750000, by=50000),  # tick positions in raw units
    labels = function(x) x / 10000,        # transform labels
    limits = c(450000, 750000)               # fix y-axis range
  ) +
  scale_x_continuous(
   breaks = seq(96, 144, by = 12),              # positions (in months)
   labels = as.character(seq(8, 12, by = 1)),    # corresponding labels (in years)
   limits = c(105,133)               # fix x-axis range
  )

#subject 2
sub2.t1 <- df.t1 %>% filter(src_subject_id == subjects[2])
sub2_age.t1 <- sub2.t1$age
sub2_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub2.t1  <- sub2.t1 %>% slice(rep(1,100))

#simulate across age
sub2.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub2_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub2.t1))

t1.sub2_plot <- t1.sub2_plot + geom_point(aes(x = sub2_age.t1, y = sub2.t1$smri_vol_cdk_total[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.t1, y = sub2.t1$smri_vol_cdk_total[1], label = round(sub2_centile.t1, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 3
sub3.t1 <- df.t1 %>% filter(src_subject_id == subjects[3])
sub3_age.t1 <- sub3.t1$age
sub3_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub3.t1  <- sub3.t1 %>% slice(rep(1,100))

#simulate across age
sub3.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub3_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub3.t1))

t1.sub3_plot <- t1.sub3_plot + geom_point(aes(x = sub3_age.t1, y = sub3.t1$smri_vol_cdk_total[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.t1, y = sub3.t1$smri_vol_cdk_total[1], label = round(sub3_centile.t1, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4
sub4.t1 <- df.t1 %>% filter(src_subject_id == subjects[4])
sub4_age.t1 <- sub4.t1$age
sub4_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub4.t1  <- sub4.t1 %>% slice(rep(1,100))

#simulate across age
sub4.t1 $age <- seq(from = min(t1.sOne_train_df$age), to = max(t1.sOne_train_df$age), length.out = 100)

#plot
t1.sub4_plot <- make_centile_fan(model, t1.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub4.t1))

t1.sub4_plot <- t1.sub4_plot + geom_point(aes(x = sub4_age.t1, y = sub4.t1$smri_vol_cdk_total[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.t1, y = sub4.t1$smri_vol_cdk_total[1], label = round(sub4_centile.t1, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
##t2 plot
###one plot
```{r}
#plot by timepoint and add the same 3 subjects to each plot
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
##residualize subjects to plot them correctly
model <- t2.best_models_One[[1]]
df <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2, smri_vol_cdk_total = smri_vol_cdk_total.t2) %>% drop_na()
t2.subjects_resid <- resid_data(model, df, og_data = t2.sOne_train_df, rm_terms = c("sex","site"))
t2.subjects_resid <- t2.subjects_resid %>% filter(src_subject_id %in% subjects)
t2.subjects_resid <- t2.subjects_resid [match(subjects, t2.subjects_resid $src_subject_id), ]

#plot t2
t2.plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="darkgray")
##add subjects and axis labels
t2.plot <- t2.plot + 
  geom_point(aes(x = t2.subjects_resid[1,2], y = t2.subjects_resid[1,1]), color = "#E69F00", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t2.subjects_resid[1,2], y = t2.subjects_resid[1,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[1]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#E69F00") + #orange
  geom_point(aes(x = t2.subjects_resid[2,2], y = t2.subjects_resid[2,1]), color = "#56B4E9", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t2.subjects_resid[2,2], y = t2.subjects_resid[2,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[2]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#56B4E9") + #blue 
  geom_point(aes(x = t2.subjects_resid[3,2], y = t2.subjects_resid[3,1]), color = "#009E73", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t2.subjects_resid[3,2], y = t2.subjects_resid[3,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[3]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#009E73")+ #green
   geom_point(aes(x = t2.subjects_resid[4,2], y = t2.subjects_resid[4,1]), color = "#E0776E", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t2.subjects_resid[4,2], y = t2.subjects_resid[4,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[4]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#E0776E")+ #pink
theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- t2.best_models_One[[1]]
df.t2 <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2, smri_vol_cdk_total = smri_vol_cdk_total.t2)

#subject 1
sub1.t2 <- df.t2 %>% filter(src_subject_id == subjects[1])
sub1_age.t2 <- sub1.t2$age
sub1_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub1.t2  <- sub1.t2 %>% slice(rep(1,100))

#simulate across age
sub1.t2 $age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub1_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub1.t2))

t2.sub1_plot <- t2.sub1_plot + geom_point(aes(x = sub1_age.t2, y = sub1.t2$smri_vol_cdk_total[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.t2, y = sub1.t2$smri_vol_cdk_total[1], label = round(sub1_centile.t2, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 2
sub2.t2 <- df.t2 %>% filter(src_subject_id == subjects[2])
sub2_age.t2 <- sub2.t2$age
sub2_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub2.t2  <- sub2.t2 %>% slice(rep(1,100))

#simulate across age
sub2.t2$age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub2_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub2.t2))

t2.sub2_plot <- t2.sub2_plot + geom_point(aes(x = sub2_age.t2, y = sub2.t2$smri_vol_cdk_total[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.t2, y = sub2.t2$smri_vol_cdk_total[1], label = round(sub2_centile.t2, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 3
sub3.t2 <- df.t2 %>% filter(src_subject_id == subjects[3])
sub3_age.t2 <- sub3.t2$age
sub3_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub3.t2  <- sub3.t2 %>% slice(rep(1,100))

#simulate across age
sub3.t2 $age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub3_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub3.t2))

t2.sub3_plot <- t2.sub3_plot + geom_point(aes(x = sub3_age.t2, y = sub3.t2$smri_vol_cdk_total[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.t2, y = sub3.t2$smri_vol_cdk_total[1], label = round(sub3_centile.t2, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4
sub4.t2 <- df.t2 %>% filter(src_subject_id == subjects[4])
sub4_age.t2 <- sub4.t2$age
sub4_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub4.t2  <- sub4.t2 %>% slice(rep(1,100))

#simulate across age
sub4.t2 $age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
t2.sub4_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub4.t2))

t2.sub4_plot <- t2.sub4_plot + geom_point(aes(x = sub4_age.t2, y = sub4.t2$smri_vol_cdk_total[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.t2, y = sub4.t2$smri_vol_cdk_total[1], label = round(sub4_centile.t2, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
##longitudinal plot
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- long.best_models_One[[1]]
df.long <- full.df  %>% select(c("smri_vol_cdk_total.t2", "smri_vol_cdk_total.t1", "interscan_months_t1t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2)

#subject 1
sub1.long <- df.long %>% filter(src_subject_id == subjects[1])
sub1_age.long <- sub1.long$age
sub1_centile.long <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub1.long  <- sub1.long %>% slice(rep(1,100))

#simulate across age
sub1.long $age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub1_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[1], average_over = FALSE, sim_data_list = list(one = sub1.long))

long.sub1_plot <- long.sub1_plot + geom_point(aes(x = sub1_age.long, y = sub1.long$smri_vol_cdk_total.t2[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.long, y = sub1.long$smri_vol_cdk_total.t2[1], label = round(sub1_centile.long, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 2
sub2.long <- df.long %>% filter(src_subject_id == subjects[2])
sub2_age.long <- sub2.long$age
sub2_centile.long <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub2.long  <- sub2.long %>% slice(rep(1,100))

#simulate across age
sub2.long $age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub2_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[2], average_over = FALSE, sim_data_list = list(one = sub2.long))

long.sub2_plot <- long.sub2_plot + geom_point(aes(x = sub2_age.long, y = sub2.long$smri_vol_cdk_total.t2[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.long, y = sub2.long$smri_vol_cdk_total.t2[1], label = round(sub2_centile.long, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 3
sub3.long <- df.long %>% filter(src_subject_id == subjects[3])
sub3_age.long <- sub3.long$age
sub3_centile.long <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub3.long  <- sub3.long %>% slice(rep(1,100))

#simulate across age
sub3.long$age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub3_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[3], average_over = FALSE, sim_data_list = list(one = sub3.long))

long.sub3_plot <- long.sub3_plot + geom_point(aes(x = sub3_age.long, y = sub3.long$smri_vol_cdk_total.t2[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.long, y = sub3.long$smri_vol_cdk_total.t2[1], label = round(sub3_centile.long, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4
sub4.long <- df.long %>% filter(src_subject_id == subjects[4])
sub4_age.long <- sub4.long$age
sub4_centile.long <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub4.long  <- sub4.long %>% slice(rep(1,100))

#simulate across age
sub4.long $age <- seq(from = min(long.sOne_train_df$age), to = max(long.sOne_train_df$age), length.out = 100)

#plot
long.sub4_plot <- make_centile_fan(model, long.sOne_train_df, "age", show_points=FALSE, color_manual=colors[4], average_over = FALSE, sim_data_list = list(one = sub4.long))

long.sub4_plot <- long.sub4_plot + geom_point(aes(x = sub4_age.long, y = sub4.long$smri_vol_cdk_total.t2[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.long, y = sub4.long$smri_vol_cdk_total.t2[1], label = round(sub4_centile.long, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
##Put plots together
```{r}
# Define plots (3 columns of 3 plots each)
plots <- list(
  t1 = list(
    t1.sub1_plot, 
    t1.sub2_plot, 
    t1.sub3_plot, 
    t1.sub4_plot
  ),
  t2 = list(
    t2.sub1_plot, 
    t2.sub2_plot, 
    t2.sub3_plot,
    t2.sub4_plot
  ),
  long = list(
    long.sub1_plot, 
    long.sub2_plot, 
    long.sub3_plot,
    long.sub4_plot
  )
)

#Get x axis and title
x_axis_1 <- get_plot_component(plots$t1[[1]], "axis-b")
x_axis_2 <- get_plot_component(plots$t2[[1]], "axis-b")
x_axis_3 <- get_plot_component(plots$long[[1]], "axis-b")

xlab <- get_plot_component(plots$t1[[1]], "xlab-b")
ylab <- get_plot_component(plots$t1[[1]], "ylab-l")

title_1 <- get_plot_component(plots$t1[[1]], "title", return_all = TRUE)[[2]]
title_2 <- get_plot_component(plots$t2[[1]], "title", return_all = TRUE)[[2]]
title_3 <- get_plot_component(plots$long[[1]], "title", return_all = TRUE)[[2]]



# Remove x-axis and xlab and ylab and titles from all plots
##change this function to be adaptable for # of plots
clean_column <- function(plot_list) {
  plot_list[[1]] <- plot_list[[1]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[2]] <- plot_list[[2]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[3]] <- plot_list[[3]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[4]] <- plot_list[[4]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  return(plot_list)
}

plots$t1 <- clean_column(plots$t1)
plots$t2 <- clean_column(plots$t2)
plots$long <- clean_column(plots$long)

# Build each column with 3 plots + shared x-axis + shared title
make_column <- function(plot_list, x_axis, title) {
  col_body <- plot_grid(plotlist = plot_list, ncol = 1, align = 'v', rel_heights = c(1, 1, 1))
  with_x <- plot_grid(col_body, x_axis, ncol = 1, rel_heights = c(1, 0.1))
  with_title <- plot_grid(title, with_x, ncol = 1, rel_heights = c(0.1, 1))
  return(with_title)
}

col1 <- make_column(plots$t1, x_axis_1, title_1)
col2 <- make_column(plots$t2, x_axis_2, title_2)
col3 <- make_column(plots$long, x_axis_3, title_3)

# Combine all columns side by side
final_grid <- plot_grid(col1, col2, col3, ncol = 3, align = "h", rel_widths = c(1, 1, 1))
final_grid <- plot_grid(ylab, final_grid, ncol = 2,rel_widths = c(0.05, 1))
final_grid <- plot_grid(final_grid,xlab, ncol = 1, rel_heights = c(1, 0.05))

# Display final plot grid
print(final_grid)

ggsave(plot=final_grid, filename='Fig1_2025-07-08.pdf', dpi=300, width=12, height=8)
```

##plot longitudinal centiles -- deprecated
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
model <- long.best_models_One[[1]]
df <- full.df  %>% select(c("smri_vol_cdk_total.t1", "smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "PCW_between_t1t2", "nonSingleton")) %>% rename(age = age.t2, site = site.t2) %>% drop_na()
long.subjects_resid <- df

#replace t1 values with residualized t1 values from cross-sectional model
##residualized t1 dataframe
model.t1 <- t1.best_models_One[[1]]
df.t1 <- full.df  %>% select(c("smri_vol_cdk_total", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1)
t1.subjects_resid <- resid_data(model.t1, df.t1, og_data = t1.sOne_train_df, rm_terms = c("sex","site")) %>% filter(src_subject_id %in% df$src_subject_id)
long.subjects_resid$smri_vol_cdk_total.t1 <- t1.subjects_resid[match(t1.subjects_resid$src_subject_id, long.subjects_resid$src_subject_id), "smri_vol_cdk_total"]

#replace t2 values with residualized t2 values from cross-sectional model
##residualized t2 dataframe
model.t2 <- t2.best_models_One[[1]]
df.t2 <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2) %>% drop_na()
t2.subjects_resid <- resid_data(model.t2, df.t2, og_data = t2.sOne_train_df, rm_terms = c("sex","site"))
long.subjects_resid$smri_vol_cdk_total.t2 <- t2.subjects_resid[match(t2.subjects_resid$src_subject_id, long.subjects_resid$src_subject_id), "smri_vol_cdk_total.t2"]

#residualize the longitudinal model on sex and site.
long.subjects_resid <- resid_data(model, long.subjects_resid, og_data = t2.sOne_train_df, rm_terms = c("sex","site", "nonSingleton"))

#subject 1

long.sub1_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[1])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub1_resid$sex <- "M"
long.sub1_resid$site <- "site16"
long.sub1_resid$nonSingleton <- 0
sub1_age <- long.sub1_resid$age

#calculate correct data point for the correct centile value
long.sub1_centile <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub1_resid, 
            type = "response", data = t2.sOne_train_df)
centile <- as.data.frame(lapply(long.sub1_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub1_resid <- long.sub1_resid %>% slice(rep(1,100))

#simulate across age
long.sub1_resid$age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
long.sub1_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="#E69F00", average_over = FALSE, sim_data_list = list(one = long.sub1_resid))

long.sub1_plot <- long.sub1_plot + geom_point(aes(x = sub1_age, y = centile$value), color = "#E69F00", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub1_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#E69F00") +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal Subject 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subject 2

long.sub2_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[2])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub2_resid$sex <- "M"
long.sub2_resid$site <- "site16"
long.sub2_resid$nonSingleton <- 0
sub2_age <- long.sub2_resid$age

#calculate correct data point for the correct centile value
long.sub2_centile <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub2_resid, 
            type = "response", data = t2.sOne_train_df)
centile <- as.data.frame(lapply(long.sub2_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub2_resid <- long.sub2_resid %>% slice(rep(1,100))

#simulate across age
long.sub2_resid$age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
long.sub2_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="#56B4E9", average_over = FALSE, sim_data_list = list(one = long.sub2_resid))

long.sub2_plot <- long.sub2_plot + geom_point(aes(x = sub2_age, y = centile$value), color = "#56B4E9", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub2_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#56B4E9") +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal Subject 2") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subject 3

long.sub3_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[3])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub3_resid$sex <- "M"
long.sub3_resid$site <- "site16"
long.sub3_resid$nonSingleton <- 0
sub3_age <- long.sub3_resid$age

#calculate correct data point for the correct centile value
long.sub3_centile <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub3_resid, 
            type = "response", data = t2.sOne_train_df)
centile <- as.data.frame(lapply(long.sub3_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub3_resid <- long.sub3_resid %>% slice(rep(1,100))

#simulate across age
long.sub3_resid$age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
long.sub3_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="#009E73", average_over = FALSE, sim_data_list = list(one = long.sub3_resid))

long.sub3_plot <- long.sub3_plot + geom_point(aes(x = sub3_age, y = centile$value), color = "#009E73", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub3_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#009E73") +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal Subject 3") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4

long.sub4_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[4])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub4_resid$sex <- "M"
long.sub4_resid$site <- "site16"
long.sub4_resid$nonSingleton <- 0
sub4_age <- long.sub4_resid$age

#calculate correct data point for the correct centile value
long.sub4_centile <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub4_resid, 
            type = "response", data = t2.sOne_train_df)
centile <- as.data.frame(lapply(long.sub4_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub4_resid <- long.sub4_resid %>% slice(rep(1,100))

#simulate across age
long.sub4_resid$age <- seq(from = min(t2.sOne_train_df$age), to = max(t2.sOne_train_df$age), length.out = 100)

#plot
long.sub4_plot <- make_centile_fan(model, t2.sOne_train_df, "age", show_points=FALSE, color_manual="#E0776E", average_over = FALSE, sim_data_list = list(one = long.sub4_resid))

long.sub4_plot <- long.sub4_plot + geom_point(aes(x = sub4_age, y = centile$value), color = "#E0776E", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub4_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#E0776E") +
  theme_minimal() + labs(x = "Age (Years) ", y = expression("Total Gray Matter (" * 10^5 * " " * mm^3 * ")"), title = "Conditional Longitudinal Subject 3") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

```

#Plots for Fig 2/Fig 3/Fig 4
##T1
###Gestational Age
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge))
ga_zscore <- z_score(t1.full_test_df$gestAge)

#Global phenotypes
reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(reg_table_global)), name_mapping$abbreviation)]

reg_table_global_sig <- reg_table_global %>% filter(ga_p < 0.05)
reg_table_global$ga_p_adj <- p.adjust(reg_table_global$ga_p, method = "BH")
reg_table_global_sig_MC <- reg_table_global %>% filter(ga_p_adj < 0.05)

reg_table_global_sig_MC

#Regional phenotypes
reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(reg_table_full)), name_mapping$abbreviation)]

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_gestAge_all.csv")
  filename_sig <- paste0(output_folder, "dsk_gestAge_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
```{r}
#cortical GMV-points
t1.ga_ctxgmv_scatterplot <-ggplot(t1.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#cortical GMV-boxplots
t1.ga_ctxgmv_boxplot <- ggplot(t1.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_cdk_total_centiles))) + geom_boxplot(aes(group = gestAge), color = "#d1dff6", alpha = 0.5) + geom_point(color = "#d1dff6", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_cdk_total_centiles)) ,method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(t1.full_test_df$gestAge), breaks = t1.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subcortical GMV - points
t1.ga_subctxgmv_scatterplot <- ggplot(t1.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#subcortical GMV - boxplots
t1.ga_subctxgmv_boxplot <-ggplot(t1.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_boxplot(aes(group = gestAge), color = "#d1dff6", alpha = 0.5) + geom_point(color = "#d1dff6", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_scs_subcorticalgv_centiles)) ,method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(t1.full_test_df$gestAge), breaks = t1.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t1.ga_vent_scatterplot <-ggplot(t1.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "Gestational Age (Weeks)",
       y = "All Ventricles Centile(z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#ventricles - boxplots
t1.ga_vent_boxplot <-ggplot(t1.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_boxplot(aes(group = gestAge), color = "#ecc9c9", alpha = 0.5) + geom_point(color = "#ecc9c9", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_scs_allventricles_centiles)) ,method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "Gestational Age (Weeks)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(t1.full_test_df$gestAge), breaks = t1.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(t1.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void()+
  labs(title = "GA T1"))

(t1.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA T1"))
```
###Gestational Age with SES
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge) & !is.na(t1.full_test_df$t1.income_ordered))
ga_zscore <- z_score(t1.full_test_df$gestAge)

#Global regression
ga_ses_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + t1.full_test_df$t1.income_ordered + t1.full_test_df$t1.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_ses_reg_table_global)), name_mapping$abbreviation)]

ga_ses_table_global_sig <- ga_ses_reg_table_global %>% filter(ga_p < 0.05)
ga_ses_reg_table_global$ga_p_adj <- p.adjust(ga_ses_reg_table_global$ga_p, method = "BH")
ga_ses_reg_table_global_sig_MC <- ga_ses_reg_table_global %>% filter(ga_p_adj < 0.05)

ga_ses_reg_table_global_sig_MC

#regional regression
ga_ses_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + t1.full_test_df$t1.income_ordered + t1.full_test_df$t1.prnt_edu_ordered)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

ga_ses_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(ga_ses_reg_table_full)), name_mapping$abbreviation)]

ga_ses_reg_table_full_sig <- ga_ses_reg_table_full %>% filter(ga_p < 0.05)
ga_ses_reg_table_full$ga_p_adj <- p.adjust(ga_ses_reg_table_full$ga_p, method = "BH")
ga_ses_reg_table_full_sig_MC <- ga_ses_reg_table_full %>% filter(ga_p_adj < 0.05)
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_ses_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_ses_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_ses_reg_table_full_sig_MC[!(ga_ses_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(ga_ses_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.ga_ses_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, T1"))

(t1.ga_ses_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(low = "#4878CF", mid = "white", high = "#D65F5F",
                       limits = c(-0.23, 0.23)) +
  theme_void() +
  labs(title = "GA with SES, T1"))
```
###birth weight - storing models in list to compare linear and non-linear across phenotypes

####linear regressions
```{r}
sum(!is.na(t1.full_test_df$birth_weight_oz_sum_adj))
df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$bw_zscore <- z_score(t1.full_test_df$birth_weight_oz_sum_adj)

#Global models save
bw_global_models_list <- lapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})
  
#Global phenotypes -- save betas and p-values
bw_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_reg_table_global)), name_mapping$abbreviation)]

bw_reg_table_global_sig <- bw_reg_table_global %>% filter(bw_p < 0.05)
bw_reg_table_global$bw_p_adj <- p.adjust(bw_reg_table_global$bw_p, method = "BH")
bw_reg_table_global_sig_MC <- bw_reg_table_global %>% filter(bw_p_adj < 0.05)

bw_reg_table_global_sig_MC

#Regional models save
bw_regional_models_list <- lapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})

#Regional phenotypes -- save betas and p-values
bw_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_reg_table_full)), name_mapping$abbreviation)]

bw_reg_table_full_sig <- bw_reg_table_full %>% filter(bw_p < 0.05)
bw_reg_table_full$bw_p_adj <- p.adjust(bw_reg_table_full$bw_p, method = "BH")
bw_reg_table_full_sig_MC <- bw_reg_table_full %>% filter(bw_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bw_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
t1.full_test_df$bw_zscore <- z_score(t1.full_test_df$birth_weight_sum_oz)
#cerebral WM-points
t1.bw_wmv_scatterplot <-ggplot(t1.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t1.bw_ctxgmv_scatterplot <-ggplot(t1.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t1.bw_subctxgmv_scatterplot <- ggplot(t1.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t1.bw_vent_scatterplot <- ggplot(t1.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_reg_table_full_sig_MC[!(bw_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW T1"))

(t1.bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW T1"))
```
####non-linear relationship with birthweight
```{r}
sum(!is.na(t1.full_test_df$birth_weight_sum_oz))
df <- as.data.frame(t1.full_test_df[,"src_subject_id"])
df$bw_zscore <- z_score(t1.full_test_df$birth_weight_sum_oz)

#Global non-linear models save
NLbw_global_models_list <- lapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ns(bw_zscore,3), data = df)
})

#Regional non-linear models save
NLbw_regional_models_list <- lapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ns(bw_zscore,3), data = df)
})
```

####visualize the nonlinear models
```{r}
##Visualize global models
#Predict on new data
for (i in 1:length(NLbw_global_models_list)){
model <- NLbw_global_models_list[[i]]
x <- t1.full_test_df[,names(NLbw_global_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}

##Visualize regional models
#Predict on new data
for (i in 1:length(NLbw_regional_models_list)){
model <- NLbw_regional_models_list[[i]]
x <- t1.full_test_df[,names(NLbw_regional_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_regional_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}
```
####Compare linear and non-linear models
```{r}
length_total <- length(NLbw_global_models_list) + length(NLbw_regional_models_list)
bw_modelcompare <- data.frame(label = rep(NA, length_total), phenotype = rep(NA, length_total), pr = rep(NA, length_total))

for(i in 1:length(NLbw_global_models_list)){
 bw_modelcompare$label[i] <- as.character(name_mapping$region_name[match(sub("_centiles", "",names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
 bw_modelcompare$phenotype[i] <- names(NLbw_global_models_list)[i]
  modelNL <- NLbw_global_models_list[[i]]
  modelOG <- bw_global_models_list[[i]]
  #x <- t1.full_test_df[,names(NLbw_global_models_list)[i]]
  #df$x_zscore <- qnorm(x)
  anova <- anova(modelOG, modelNL, test = "LRT")
  bw_modelcompare$pr[i] <- anova$`Pr(>Chi)`[2]
}

for(i in (length(NLbw_global_models_list)+1):length_total){
  j = i - length(NLbw_global_models_list)
 bw_modelcompare$label[i] <- as.character(name_mapping$region_name[match(sub("_centiles", "",names(NLbw_regional_models_list)[j]), name_mapping$abbreviation)])
 bw_modelcompare$phenotype[i] <- names(NLbw_regional_models_list)[j]
  modelNL <- NLbw_regional_models_list[[j]]
  modelOG <- bw_regional_models_list[[j]]
  #x <- t1.full_test_df[,names(NLbw_regional_models_list)[i]]
  #df$x_zscore <- qnorm(x)
  anova <- anova(modelOG, modelNL, test = "LRT")
  bw_modelcompare$pr[i] <- anova$`Pr(>Chi)`[2]
}

NL_sig_models <- bw_modelcompare[bw_modelcompare$pr < 0.05,]
```
####Plot models significantly better fit with NL model
```{r}
plot <- TRUE
NLall_models <- c(NLbw_global_models_list, NLbw_regional_models_list)
OGall_models <- c(bw_global_models_list, bw_regional_models_list)
plots_nl <- vector(mode = "list", length = length(NLall_models))
for (i  in 1:length(NLall_models)) {
  modelNL <- NLall_models[[i]]
  modelOG <- OGall_models[[i]]
  if(!(names(NLall_models)[i] %in% NL_sig_models$phenotype)) next
  x <- t1.full_test_df[,names(NLall_models)[i]]
 df$x_zscore <- qnorm(x)
 new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
 new_data$y_predNL <- predict(modelNL, newdata = new_data)
 new_data$y_predOG <- predict(modelOG, newdata = new_data)
 
 #Save plot
 title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLall_models)[i]),  name_mapping$abbreviation)])
  plots_nl[[i]] <- ggplot(df, aes(bw_zscore, x_zscore)) +
   geom_line(data = new_data, aes(bw_zscore, y_predNL), color = "red", linewidth = 1) + 
    geom_line(data = new_data, aes(bw_zscore, y_predOG), color = "blue", linewidth = 1) +
    ggtitle(title)

}
plots_nl <- Filter(Negate(is.null), plots_nl)
do.call("grid.arrange", c(plots_nl[1:15], ncol=5))

#The code below gives an error ... haven't solved it yet.
if (plot == TRUE){
  n <- length(plots_nl)
  nCol <- min(c(floor(sqrt(n)), 4))
  nRow <- min(ceiling(n/nCol), 4)
  breaks <- c(seq(from = 0, to = n , by = (nCol*nRow)), n)
  for(k in 1:length(breaks)){
    start <- breaks[k] + 1
    end <- breaks[k+1]
    do.call("grid.arrange", c(plots_nl[start:end], ncol=nCol))
  }
}                                



##Visualize models where it is significantly better than linear model
#Predict on new data
for (i in 1:length(NLbw_global_models_list)){
model <- NLbw_global_models_list[[i]]

x <- t1.full_test_df[,names(NLbw_global_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}

for (i in 1:length(NLbw_regional_models_list)){
model <- NLbw_regional_models_list[[i]]
if(!(names(NLbw_regional_models_list)[i] %in% NL_sig_models$phenotype)){
  stop()
}
x <- t1.full_test_df[,names(NLbw_regional_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_regional_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}
```

###birth weight percentile
####calculate birth weight percentile
```{r}
#convert birthweight into percentiles using the gitHub growthstandards package which use the intergrowth charts
t1.full_test_df <- t1.full_test_df %>%
  mutate(birth_weight_kg = birth_weight_oz_sum_adj * 0.0283495) %>%
  mutate(gestAge_days = gestAge*7+3) %>%
  mutate(sexLong = recode(sex, "M" = "Male", "F" = "Female"))

t1.full_test_df$bweight_percentile <- igb_wtkg2centile(t1.full_test_df$gestAge_days, t1.full_test_df$birth_weight_kg, sex = t1.full_test_df$sexLong)/100

t1.full_test_df$bw_category <- ifelse(t1.full_test_df$bweight_percentile < 0.10, "SGA", ifelse(t1.full_test_df$bweight_percentile > 0.90, "LGA", "AGA"))
```
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bweight_percentile))
bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)

#Global Phenotypes
bwp_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bwp_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_reg_table_global)), name_mapping$abbreviation)]

bwp_reg_table_global_sig <- bwp_reg_table_global %>% filter(bw_p < 0.05)
bwp_reg_table_global$bw_p_adj <- p.adjust(bwp_reg_table_global$bw_p, method = "BH")
bwp_reg_table_global_sig_MC <- bwp_reg_table_global %>% filter(bw_p_adj < 0.05)

bwp_reg_table_global_sig_MC

#Regional Phenotypes
bwp_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bwp_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_reg_table_full)), name_mapping$abbreviation)]

bwp_reg_table_full_sig <- bwp_reg_table_full %>% filter(bw_p < 0.05)
bwp_reg_table_full$bw_p_adj <- p.adjust(bwp_reg_table_full$bw_p, method = "BH")
bwp_reg_table_full_sig_MC <- bwp_reg_table_full %>% filter(bw_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bwp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightpercentile_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
t1.full_test_df$bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)
#cerebral WM-points
t1.bwp_wmv_scatterplot <-ggplot(t1.full_test_df, aes(x = bwp_zscore, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t1.bwp_ctxgmv_scatterplot <-ggplot(t1.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t1.bwp_subctxgmv_scatterplot <- ggplot(t1.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t1.bwp_vent_scatterplot <- ggplot(t1.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_reg_table_full_sig_MC[!(bwp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWp T1"))

(t1.bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWp T1"))
```
###PRS-bw
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$bw_pgs))
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {z_score(x)}))

#Global Phenotypes
bw_pgs_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_reg_table_global)), name_mapping$abbreviation)]

bw_pgs_reg_table_global_sig <- bw_pgs_reg_table_global %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_global$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_global$bw_pgs_p, method = "BH")
bw_pgs_reg_table_global_sig_MC <- bw_pgs_reg_table_global %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_reg_table_global_sig_MC

#Regional Phenotypes
bw_pgs_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[,which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bw_pgs_reg_table_full)), name_mapping$abbreviation)]

bw_pgs_reg_table_full_sig <- bw_pgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_full$bw_pgs_p, method = "BH")
bw_pgs_reg_table_full_sig_MC <- bw_pgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bw_pgs_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightPGS_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
t1.bwpgs_wmv_scatterplot <-ggplot(t1.full_test_df, aes(x = bw_pgs, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t1.bwpgs_ctxgmv_scatterplot <-ggplot(t1.full_test_df, aes(x = bw_pgs, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t1.bwpgs_subctxgmv_scatterplot <- ggplot(t1.full_test_df, aes(x = bw_pgs, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_reg_table_full_sig_MC[!(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs T1"))

(t1.bwpgs_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs T1"))
```
####correlations with bw
- spin test in Python using neuromaps package
```{r}
bw_bwpgs <- merge(bw_pgs_reg_table_full, bw_reg_table_full, by = c("label"))
#all regions
plot(bw_bwpgs$bw_beta, bw_bwpgs$bw_pgs_beta)
cor.test(bw_bwpgs$bw_beta, bw_bwpgs$bw_pgs_beta)
#only significant post-FDR in both
bw_bwpgs_sig <- bw_bwpgs %>% filter(bw_p_adj < 0.05 & bw_pgs_p_adj < 0.05)
plot(bw_bwpgs_sig$bw_beta, bw_bwpgs_sig$bw_pgs_beta)
cor.test(bw_bwpgs_sig$bw_beta, bw_bwpgs_sig$bw_pgs_beta)
```
###general P-factor
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$General_p))
gp_zscore <- z_score(t1.full_test_df$General_p)

#Global Phenotypes
gp_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_reg_table_global)), name_mapping$abbreviation)]

gp_reg_table_global_sig <- gp_reg_table_global %>% filter(gp_p < 0.05)
gp_reg_table_global$gp_p_adj <- p.adjust(gp_reg_table_global$gp_p, method = "BH")
gp_reg_table_global_sig_MC <- gp_reg_table_global %>% filter(gp_p_adj < 0.05)

gp_reg_table_global_sig_MC

#Regional Phenotypes
gp_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(gp_reg_table_full)), name_mapping$abbreviation)]

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- gp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "gp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_genP_all.csv")
  filename_sig <- paste0(output_folder, "dsk_genP_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
t1.gp_wmv_scatterplot <-ggplot(t1.full_test_df, aes(x = General_p, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t1.gp_ctxgmv_scatterplot <-ggplot(t1.full_test_df, aes(x = General_p, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t1.gp_subctxgmv_scatterplot <- ggplot(t1.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t1.gp_vent_scatterplot <- ggplot(t1.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "P-factor T1"))

(t1.gp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "P-factor T1"))
```

###GA-BWpercentile as cov
####linear regressions
```{r}
sum(!is.na(t1.full_test_df$gestAge) & !is.na(t1.full_test_df$bweight_percentile))
ga_zscore <- z_score(t1.full_test_df$gestAge)
bwp_zscore <- qnorm(t1.full_test_df$bweight_percentile)

#Global regression
bwp_ga_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_ga_reg_table_global)), name_mapping$abbreviation)]

ga_reg_table_global_sig <- bwp_ga_reg_table_global %>% filter(ga_p < 0.05)
bwp_ga_reg_table_global$ga_p_adj <- p.adjust(bwp_ga_reg_table_global$ga_p, method = "BH")
bwp_ga_reg_table_global$bwp_p_adj <- p.adjust(bwp_ga_reg_table_global$bwp_p, method = "BH")
ga_reg_table_global_sig_MC <- bwp_ga_reg_table_global %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_global_sig <- bwp_ga_reg_table_global %>% filter(bwp_p < 0.05)
bwpga_reg_table_global_sig_MC <- bwp_ga_reg_table_global %>% filter(bwp_p_adj < 0.05)

bwpga_reg_table_global_sig_MC


#regional regression
bwp_ga_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwp_ga_reg_table_full)), name_mapping$abbreviation)]

ga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full$ga_p_adj <- p.adjust(bwp_ga_reg_table_full$ga_p, method = "BH")
bwp_ga_reg_table_full$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full$bwp_p, method = "BH")
ga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(bwp_p < 0.05)
bwpga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(bwp_p_adj < 0.05)
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full_sig_MC[!(ga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpga_ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, T1"))

(t1.bwpga_ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, T1"))
```
####BWp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full_sig_MC[!(bwpga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bwpga_bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, T1"))

(t1.bwpga_bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, T1"))
```

###BW + BW PGS 
```{r}
sum(!is.na(t1.full_test_df$bw_pgs) & !is.na(t1.full_test_df$birth_weight_oz_sum_adj))
bw_pgs_zscore <- as.data.frame(sapply(t1.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {z_score(x)}))
#bw_pgs_zscore$bw_zscore <- qnorm(t1.full_test_df$bweight_percentile)
bw_pgs_zscore$bw_zscore <- z_score(t1.full_test_df$birth_weight_oz_sum_adj)

#Global variables
bwbwpgs_reg_table_global <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(global_phenotypes, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_global$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwbwpgs_reg_table_global)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_global_sig <- bwbwpgs_reg_table_global %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_global$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_global$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_global_sig_MC <- bwbwpgs_reg_table_global %>% filter(bw_pgs_p_adj < 0.05)

pgs_bwbwpgs_reg_table_global_sig_MC

bw_bwbwpgs_reg_table_global_sig <- bwbwpgs_reg_table_global %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_global$bw_p_adj <- p.adjust(bwbwpgs_reg_table_global$bw_p, method = "BH")
bw_bwbwpgs_reg_table_global_sig_MC <- bwbwpgs_reg_table_global %>% filter(bw_p_adj < 0.05)

bw_bwbwpgs_reg_table_global_sig_MC

#Regional variables
bwbwpgs_reg_table_full <- as.data.frame(t(sapply(t1.full_test_df[, which(names(t1.full_test_df) %in% paste0(phenotypes_for_MC, ".t1_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_full$label <- name_mapping$region_name[match(sub(".t1_centiles", "", rownames(bwbwpgs_reg_table_full)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_full_sig <- bwbwpgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_full$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_full_sig_MC <- bwbwpgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)

bw_bwbwpgs_reg_table_full_sig <- bwbwpgs_reg_table_full %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_full$bw_p_adj <- p.adjust(bwbwpgs_reg_table_full$bw_p, method = "BH")
bw_bwbwpgs_reg_table_full_sig_MC <- bwbwpgs_reg_table_full %>% filter(bw_p_adj < 0.05)
```
####surface visualization of bw-pgs beta
```{r}
#merge with atlas data
plot_data_dkt <- merge(pgs_bwbwpgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(pgs_bwbwpgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
pgs_bwbwpgs_reg_table_full_sig_MC[!(pgs_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(pgs_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.pgs_bwbwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW_pgs in BW-BWpgs, T1"))

(t1.pgs_bwbwpgs_aseg_plot <-ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW_pgs in BW-BWpgs, T1"))
```
####surface visualization of bw beta
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_bwbwpgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_bwbwpgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_bwbwpgs_reg_table_full_sig_MC[!(bw_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t1.bw_bwbwpgs_dkt_plot <-ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW in BW-BWpgs, T1"))

(t1.bw_bwbwpgs_aseg_plot <-ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW in BW-BWpgs, T1"))
```
##T2
###Gestational Age
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge))
ga_zscore <- z_score(t2.full_test_df$gestAge)

#Global phenotypes
reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(reg_table_global)), name_mapping$abbreviation)]

reg_table_global_sig <- reg_table_global %>% filter(ga_p < 0.05)
reg_table_global$ga_p_adj <- p.adjust(reg_table_global$ga_p, method = "BH")
reg_table_global_sig_MC <- reg_table_global %>% filter(ga_p_adj < 0.05)

reg_table_global_sig_MC

#Regional phenotypes
reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(reg_table_full)), name_mapping$abbreviation)]

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_gestAge_all.csv")
  filename_sig <- paste0(output_folder, "dsk_gestAge_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
```{r}
#cortical GMV-points
t2.ga_ctxgmv_scatterplot <-ggplot(t2.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#cortical GMV-boxplots
t2.ga_ctxgmv_boxplot <- ggplot(t2.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_cdk_total_centiles))) + geom_boxplot(aes(group = gestAge), color = "#d1dff6", alpha = 0.5) + geom_point(color = "#d1dff6", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_cdk_total_centiles)) ,method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(t2.full_test_df$gestAge), breaks = t2.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subcortical GMV - points
t2.ga_subctxgmv_scatterplot <- ggplot(t2.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#subcortical GMV - boxplots
t2.ga_subctxgmv_boxplot <-ggplot(t2.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_boxplot(aes(group = gestAge), color = "#d1dff6", alpha = 0.5) + geom_point(color = "#d1dff6", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_scs_subcorticalgv_centiles)) ,method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(t2.full_test_df$gestAge), breaks = t2.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t2.ga_vent_scatterplot <-ggplot(t2.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "Gestational Age (Weeks)",
       y = "All Ventricles Centile(z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#ventricles - boxplots
t2.ga_vent_boxplot <-ggplot(t2.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_boxplot(aes(group = gestAge), color = "#ecc9c9", alpha = 0.5) + geom_point(color = "#ecc9c9", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_scs_allventricles_centiles)) ,method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "Gestational Age (Weeks)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(t2.full_test_df$gestAge), breaks = t2.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(t2.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void()+
  labs(title = "GA t2"))

(t2.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA t2"))
```
###birth weight - storing models in list to compare linear and non-linear across phenotypes
####add birthweight metrics from t1 table
```{r}
t2.full_test_df$birth_weight_oz_sum_adj <- t1.full_test_df$birth_weight_oz_sum_adj[match(t2.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
```
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$birth_weight_oz_sum_adj))
df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$bw_zscore <- z_score(t2.full_test_df$birth_weight_oz_sum_adj)

#Global models save
bw_global_models_list <- lapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})
  
#Global phenotypes -- save betas and p-values
bw_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_reg_table_global)), name_mapping$abbreviation)]

bw_reg_table_global_sig <- bw_reg_table_global %>% filter(bw_p < 0.05)
bw_reg_table_global$bw_p_adj <- p.adjust(bw_reg_table_global$bw_p, method = "BH")
bw_reg_table_global_sig_MC <- bw_reg_table_global %>% filter(bw_p_adj < 0.05)

bw_reg_table_global_sig_MC

#Regional models save
bw_regional_models_list <- lapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})

#Regional phenotypes -- save betas and p-values
bw_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_reg_table_full)), name_mapping$abbreviation)]

bw_reg_table_full_sig <- bw_reg_table_full %>% filter(bw_p < 0.05)
bw_reg_table_full$bw_p_adj <- p.adjust(bw_reg_table_full$bw_p, method = "BH")
bw_reg_table_full_sig_MC <- bw_reg_table_full %>% filter(bw_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bw_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
t2.full_test_df$bw_zscore <- z_score(t2.full_test_df$birth_weight_sum_oz)
#cerebral WM-points
t2.bw_wmv_scatterplot <-ggplot(t2.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t2.bw_ctxgmv_scatterplot <-ggplot(t2.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t2.bw_subctxgmv_scatterplot <- ggplot(t2.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t2.bw_vent_scatterplot <- ggplot(t2.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_reg_table_full_sig_MC[!(bw_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW t2"))

(t2.bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW t2"))
```
####non-linear relationship with birthweight
```{r}
sum(!is.na(t2.full_test_df$birth_weight_sum_oz))
df <- as.data.frame(t2.full_test_df[,"src_subject_id"])
df$bw_zscore <- z_score(t2.full_test_df$birth_weight_sum_oz)

#Global non-linear models save
NLbw_global_models_list <- lapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ns(bw_zscore,3), data = df)
})

#Regional non-linear models save
NLbw_regional_models_list <- lapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ns(bw_zscore,3), data = df)
})
```

####visualize the nonlinear models
```{r}
##Visualize global models
#Predict on new data
for (i in 1:length(NLbw_global_models_list)){
model <- NLbw_global_models_list[[i]]
x <- t2.full_test_df[,names(NLbw_global_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}

##Visualize regional models
#Predict on new data
for (i in 1:length(NLbw_regional_models_list)){
model <- NLbw_regional_models_list[[i]]
x <- t2.full_test_df[,names(NLbw_regional_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_regional_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}
```
####Compare linear and non-linear models
```{r}
length_total <- length(NLbw_global_models_list) + length(NLbw_regional_models_list)
bw_modelcompare <- data.frame(label = rep(NA, length_total), phenotype = rep(NA, length_total), pr = rep(NA, length_total))

for(i in 1:length(NLbw_global_models_list)){
 bw_modelcompare$label[i] <- as.character(name_mapping$region_name[match(sub("_centiles", "",names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
 bw_modelcompare$phenotype[i] <- names(NLbw_global_models_list)[i]
  modelNL <- NLbw_global_models_list[[i]]
  modelOG <- bw_global_models_list[[i]]
  #x <- t2.full_test_df[,names(NLbw_global_models_list)[i]]
  #df$x_zscore <- qnorm(x)
  anova <- anova(modelOG, modelNL, test = "LRT")
  bw_modelcompare$pr[i] <- anova$`Pr(>Chi)`[2]
}

for(i in (length(NLbw_global_models_list)+1):length_total){
  j = i - length(NLbw_global_models_list)
 bw_modelcompare$label[i] <- as.character(name_mapping$region_name[match(sub("_centiles", "",names(NLbw_regional_models_list)[j]), name_mapping$abbreviation)])
 bw_modelcompare$phenotype[i] <- names(NLbw_regional_models_list)[j]
  modelNL <- NLbw_regional_models_list[[j]]
  modelOG <- bw_regional_models_list[[j]]
  #x <- t2.full_test_df[,names(NLbw_regional_models_list)[i]]
  #df$x_zscore <- qnorm(x)
  anova <- anova(modelOG, modelNL, test = "LRT")
  bw_modelcompare$pr[i] <- anova$`Pr(>Chi)`[2]
}

NL_sig_models <- bw_modelcompare[bw_modelcompare$pr < 0.05,]
```
####Plot models significantly better fit with NL model
```{r}
plot <- TRUE
NLall_models <- c(NLbw_global_models_list, NLbw_regional_models_list)
OGall_models <- c(bw_global_models_list, bw_regional_models_list)
plots_nl <- vector(mode = "list", length = length(NLall_models))
for (i  in 1:length(NLall_models)) {
  modelNL <- NLall_models[[i]]
  modelOG <- OGall_models[[i]]
  if(!(names(NLall_models)[i] %in% NL_sig_models$phenotype)) next
  x <- t2.full_test_df[,names(NLall_models)[i]]
 df$x_zscore <- qnorm(x)
 new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
 new_data$y_predNL <- predict(modelNL, newdata = new_data)
 new_data$y_predOG <- predict(modelOG, newdata = new_data)
 
 #Save plot
 title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLall_models)[i]),  name_mapping$abbreviation)])
  plots_nl[[i]] <- ggplot(df, aes(bw_zscore, x_zscore)) +
   geom_line(data = new_data, aes(bw_zscore, y_predNL), color = "red", linewidth = 1) + 
    geom_line(data = new_data, aes(bw_zscore, y_predOG), color = "blue", linewidth = 1) +
    ggtitle(title)

}
plots_nl <- Filter(Negate(is.null), plots_nl)
do.call("grid.arrange", c(plots_nl[1:15], ncol=5))

#The code below gives an error ... haven't solved it yet.
if (plot == TRUE){
  n <- length(plots_nl)
  nCol <- min(c(floor(sqrt(n)), 4))
  nRow <- min(ceiling(n/nCol), 4)
  breaks <- c(seq(from = 0, to = n , by = (nCol*nRow)), n)
  for(k in 1:length(breaks)){
    start <- breaks[k] + 1
    end <- breaks[k+1]
    do.call("grid.arrange", c(plots_nl[start:end], ncol=nCol))
  }
}                                



##Visualize models where it is significantly better than linear model
#Predict on new data
for (i in 1:length(NLbw_global_models_list)){
model <- NLbw_global_models_list[[i]]

x <- t2.full_test_df[,names(NLbw_global_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}

for (i in 1:length(NLbw_regional_models_list)){
model <- NLbw_regional_models_list[[i]]
if(!(names(NLbw_regional_models_list)[i] %in% NL_sig_models$phenotype)){
  stop()
}
x <- t2.full_test_df[,names(NLbw_regional_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_regional_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}
```

###birth weight percentile
####calculate birth weight percentile
```{r}
#convert birthweight into percentiles using the gitHub growthstandards package which use the intergrowth charts
t2.full_test_df <- t2.full_test_df %>%
  mutate(birth_weight_kg = birth_weight_oz_sum_adj * 0.0283495) %>%
  mutate(gestAge_days = gestAge*7+3) %>%
  mutate(sexLong = recode(sex, "M" = "Male", "F" = "Female"))

t2.full_test_df$bweight_percentile <- igb_wtkg2centile(t2.full_test_df$gestAge_days, t2.full_test_df$birth_weight_kg, sex = t2.full_test_df$sexLong)/100

t2.full_test_df$bw_category <- ifelse(t2.full_test_df$bweight_percentile < 0.10, "SGA", ifelse(t2.full_test_df$bweight_percentile > 0.90, "LGA", "AGA"))
```
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bweight_percentile))
bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)

#Global Phenotypes
bwp_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bwp_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_reg_table_global)), name_mapping$abbreviation)]

bwp_reg_table_global_sig <- bwp_reg_table_global %>% filter(bw_p < 0.05)
bwp_reg_table_global$bw_p_adj <- p.adjust(bwp_reg_table_global$bw_p, method = "BH")
bwp_reg_table_global_sig_MC <- bwp_reg_table_global %>% filter(bw_p_adj < 0.05)

bwp_reg_table_global_sig_MC

#Regional Phenotypes
bwp_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bwp_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_reg_table_full)), name_mapping$abbreviation)]

bwp_reg_table_full_sig <- bwp_reg_table_full %>% filter(bw_p < 0.05)
bwp_reg_table_full$bw_p_adj <- p.adjust(bwp_reg_table_full$bw_p, method = "BH")
bwp_reg_table_full_sig_MC <- bwp_reg_table_full %>% filter(bw_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bwp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightpercentile_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
t2.full_test_df$bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)
#cerebral WM-points
t2.bwp_wmv_scatterplot <-ggplot(t2.full_test_df, aes(x = bwp_zscore, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t2.bwp_ctxgmv_scatterplot <-ggplot(t2.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t2.bwp_subctxgmv_scatterplot <- ggplot(t2.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t2.bwp_vent_scatterplot <- ggplot(t2.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_reg_table_full_sig_MC[!(bwp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWp t2"))

(t2.bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWp t2"))
```
###PRS-bw
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bw_pgs))
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {z_score(x)}))

#Global Phenotypes
bw_pgs_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_reg_table_global)), name_mapping$abbreviation)]

bw_pgs_reg_table_global_sig <- bw_pgs_reg_table_global %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_global$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_global$bw_pgs_p, method = "BH")
bw_pgs_reg_table_global_sig_MC <- bw_pgs_reg_table_global %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_reg_table_global_sig_MC

#Regional Phenotypes
bw_pgs_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[,which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bw_pgs_reg_table_full)), name_mapping$abbreviation)]

bw_pgs_reg_table_full_sig <- bw_pgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_full$bw_pgs_p, method = "BH")
bw_pgs_reg_table_full_sig_MC <- bw_pgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bw_pgs_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightPGS_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
t2.bwpgs_wmv_scatterplot <-ggplot(t2.full_test_df, aes(x = bw_pgs, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t2.bwpgs_ctxgmv_scatterplot <-ggplot(t2.full_test_df, aes(x = bw_pgs, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t2.bwpgs_subctxgmv_scatterplot <- ggplot(t2.full_test_df, aes(x = bw_pgs, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_reg_table_full_sig_MC[!(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs t2"))

(t2.bwpgs_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs t2"))
```
####correlations with bw
- spin test in Python using neuromaps package
```{r}
bw_bwpgs <- merge(bw_pgs_reg_table_full, bw_reg_table_full, by = c("label"))
#all regions
plot(bw_bwpgs$bw_beta, bw_bwpgs$bw_pgs_beta)
cor.test(bw_bwpgs$bw_beta, bw_bwpgs$bw_pgs_beta)
#only significant post-FDR in both
bw_bwpgs_sig <- bw_bwpgs %>% filter(bw_p_adj < 0.05 & bw_pgs_p_adj < 0.05)
plot(bw_bwpgs_sig$bw_beta, bw_bwpgs_sig$bw_pgs_beta)
cor.test(bw_bwpgs_sig$bw_beta, bw_bwpgs_sig$bw_pgs_beta)
```
###general P-factor
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$General_p))
gp_zscore <- z_score(t2.full_test_df$General_p)

#Global Phenotypes
gp_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_global)), name_mapping$abbreviation)]

gp_reg_table_global_sig <- gp_reg_table_global %>% filter(gp_p < 0.05)
gp_reg_table_global$gp_p_adj <- p.adjust(gp_reg_table_global$gp_p, method = "BH")
gp_reg_table_global_sig_MC <- gp_reg_table_global %>% filter(gp_p_adj < 0.05)

gp_reg_table_global_sig_MC

#Regional Phenotypes
gp_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_full)), name_mapping$abbreviation)]

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- gp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "gp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_genP_all.csv")
  filename_sig <- paste0(output_folder, "dsk_genP_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
t2.gp_wmv_scatterplot <-ggplot(t2.full_test_df, aes(x = General_p, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
t2.gp_ctxgmv_scatterplot <-ggplot(t2.full_test_df, aes(x = General_p, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
t2.gp_subctxgmv_scatterplot <- ggplot(t2.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
t2.gp_vent_scatterplot <- ggplot(t2.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "P-factor t2"))

(t2.gp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "P-factor t2"))
```

###General P change calculate
```{r}
t2.full_test_df$General_p.t1 <- t1.full_test_df$General_p[match(t2.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
t2.full_test_df$General_p.t2 <- t2.full_test_df$General_p[match(t2.full_test_df$src_subject_id, t2.full_test_df$src_subject_id)]
t2.full_test_df$General_p_change <- t2.full_test_df$General_p.t2 - t2.full_test_df$General_p.t1
```
###general P-factor - change in P-factor -- including baseline P-factor as covar
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$General_p_change))
gp_zscore <- z_score(t2.full_test_df$General_p_change)
gp_baseline_zscore <- z_score(t2.full_test_df$General_p.t1)

#Global Phenotypes
gp_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_zscore + gp_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2],gp_base_beta = summary$coefficients[3,1], gp_base_p = summary$coefficients[3,4], gp_base_se = summary$coefficients[3,2])
})))

gp_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_global)), name_mapping$abbreviation)]

gp_reg_table_global_sig <- gp_reg_table_global %>% filter(gp_p < 0.05)
gp_reg_table_global$gp_p_adj <- p.adjust(gp_reg_table_global$gp_p, method = "BH")
gp_reg_table_global$gp_base_p_adj <- p.adjust(gp_reg_table_global$gp_base_p, method = "BH")
gp_reg_table_global_sig_MC <- gp_reg_table_global %>% filter(gp_p_adj < 0.05)

gp_reg_table_global_sig_MC

#Regional Phenotypes
gp_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_zscore + gp_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2],gp_base_beta = summary$coefficients[3,1], gp_base_p = summary$coefficients[3,4], gp_base_se = summary$coefficients[3,2])
})))

gp_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(gp_reg_table_full)), name_mapping$abbreviation)]

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full$gp_base_p_adj <- p.adjust(gp_reg_table_full$gp_base_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)

#save tables of betas
save_tables = FALSE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Surface_Maps/"
  save_table_full <- gp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_genP_t2_all.csv")
  filename_sig <- paste0(output_folder, "dsk_genP_t2s_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "GP Change, t2"))

(t2.gp_dkt_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "GP Change, t2"))
```

###GA-BWpercentile as cov
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$gestAge) & !is.na(t2.full_test_df$bweight_percentile))
ga_zscore <- z_score(t2.full_test_df$gestAge)
bwp_zscore <- qnorm(t2.full_test_df$bweight_percentile)

#Global regression
bwp_ga_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_ga_reg_table_global)), name_mapping$abbreviation)]

ga_reg_table_global_sig <- bwp_ga_reg_table_global %>% filter(ga_p < 0.05)
bwp_ga_reg_table_global$ga_p_adj <- p.adjust(bwp_ga_reg_table_global$ga_p, method = "BH")
bwp_ga_reg_table_global$bwp_p_adj <- p.adjust(bwp_ga_reg_table_global$bwp_p, method = "BH")
ga_reg_table_global_sig_MC <- bwp_ga_reg_table_global %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_global_sig <- bwp_ga_reg_table_global %>% filter(bwp_p < 0.05)
bwpga_reg_table_global_sig_MC <- bwp_ga_reg_table_global %>% filter(bwp_p_adj < 0.05)

bwpga_reg_table_global_sig_MC


#regional regression
bwp_ga_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwp_ga_reg_table_full)), name_mapping$abbreviation)]

ga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full$ga_p_adj <- p.adjust(bwp_ga_reg_table_full$ga_p, method = "BH")
bwp_ga_reg_table_full$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full$bwp_p, method = "BH")
ga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(bwp_p < 0.05)
bwpga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(bwp_p_adj < 0.05)
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full_sig_MC[!(ga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpga_ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "GA in BWp-GA, t2"))

(t2.bwpga_ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "GA in BWp-GA, t2"))
```
####BWp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full_sig_MC[!(bwpga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bwpga_bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, t2"))

(t2.bwpga_bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, t2"))
```

###BW + BW PGS 
####linear regressions
```{r}
sum(!is.na(t2.full_test_df$bw_pgs) & !is.na(t2.full_test_df$birth_weight_oz_sum_adj))
bw_pgs_zscore <- as.data.frame(sapply(t2.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {z_score(x)}))
#bw_pgs_zscore$bw_zscore <- qnorm(t2.full_test_df$bweight_percentile)
bw_pgs_zscore$bw_zscore <- z_score(t2.full_test_df$birth_weight_oz_sum_adj)

#Global variables
bwbwpgs_reg_table_global <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(global_phenotypes, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_global$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwbwpgs_reg_table_global)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_global_sig <- bwbwpgs_reg_table_global %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_global$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_global$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_global_sig_MC <- bwbwpgs_reg_table_global %>% filter(bw_pgs_p_adj < 0.05)

pgs_bwbwpgs_reg_table_global_sig_MC

bw_bwbwpgs_reg_table_global_sig <- bwbwpgs_reg_table_global %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_global$bw_p_adj <- p.adjust(bwbwpgs_reg_table_global$bw_p, method = "BH")
bw_bwbwpgs_reg_table_global_sig_MC <- bwbwpgs_reg_table_global %>% filter(bw_p_adj < 0.05)

bw_bwbwpgs_reg_table_global_sig_MC

#Regional variables
bwbwpgs_reg_table_full <- as.data.frame(t(sapply(t2.full_test_df[, which(names(t2.full_test_df) %in% paste0(phenotypes_for_MC, ".t2_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_full$label <- name_mapping$region_name[match(sub(".t2_centiles", "", rownames(bwbwpgs_reg_table_full)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_full_sig <- bwbwpgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_full$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_full_sig_MC <- bwbwpgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)

bw_bwbwpgs_reg_table_full_sig <- bwbwpgs_reg_table_full %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_full$bw_p_adj <- p.adjust(bwbwpgs_reg_table_full$bw_p, method = "BH")
bw_bwbwpgs_reg_table_full_sig_MC <- bwbwpgs_reg_table_full %>% filter(bw_p_adj < 0.05)
```
####surface visualization of bw-pgs beta
```{r}
#merge with atlas data
plot_data_dkt <- merge(pgs_bwbwpgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(pgs_bwbwpgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
pgs_bwbwpgs_reg_table_full_sig_MC[!(pgs_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(pgs_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.pgs_bwbwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW_pgs in BW-BWpgs, T2"))

(t2.pgs_bwbwpgs_aseg_plot <-ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW_pgs in BW-BWpgs, T2"))
```
####surface visualization of bw beta
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_bwbwpgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_bwbwpgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_bwbwpgs_reg_table_full_sig_MC[!(bw_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(t2.bw_bwbwpgs_dkt_plot <-ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW in BW-BWpgs, t2"))

(t2.bw_bwbwpgs_aseg_plot <-ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW in BW-BWpgs, t2"))
```
##LONG
###Gestational Age
####linear regressions
```{r}
sum(!is.na(long.full_test_df$gestAge))
ga_zscore <- z_score(long.full_test_df$gestAge)

#Global phenotypes
reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(reg_table_global)), name_mapping$abbreviation)]

reg_table_global_sig <- reg_table_global %>% filter(ga_p < 0.05)
reg_table_global$ga_p_adj <- p.adjust(reg_table_global$ga_p, method = "BH")
reg_table_global_sig_MC <- reg_table_global %>% filter(ga_p_adj < 0.05)

reg_table_global_sig_MC

#Regional phenotypes
reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], ga_se = summary$coefficients[2,2])
})))

reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(reg_table_full)), name_mapping$abbreviation)]

reg_table_full_sig <- reg_table_full %>% filter(ga_p < 0.05)
reg_table_full$ga_p_adj <- p.adjust(reg_table_full$ga_p, method = "BH")
reg_table_full_sig_MC <- reg_table_full %>% filter(ga_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_gestAge_all.csv")
  filename_sig <- paste0(output_folder, "dsk_gestAge_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
```{r}
#cortical GMV-points
long.ga_ctxgmv_scatterplot <-ggplot(long.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#cortical GMV-boxplots
long.ga_ctxgmv_boxplot <- ggplot(long.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_cdk_total_centiles))) + geom_boxplot(aes(group = gestAge), color = "#d1dff6", alpha = 0.5) + geom_point(color = "#d1dff6", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_cdk_total_centiles)) ,method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(long.full_test_df$gestAge), breaks = long.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subcortical GMV - points
long.ga_subctxgmv_scatterplot <- ggplot(long.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#subcortical GMV - boxplots
long.ga_subctxgmv_boxplot <-ggplot(long.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_boxplot(aes(group = gestAge), color = "#d1dff6", alpha = 0.5) + geom_point(color = "#d1dff6", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_scs_subcorticalgv_centiles)) ,method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Gestational Age (Weeks)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(long.full_test_df$gestAge), breaks = long.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
long.ga_vent_scatterplot <-ggplot(long.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "Gestational Age (Weeks)",
       y = "All Ventricles Centile(z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
#ventricles - boxplots
long.ga_vent_boxplot <-ggplot(long.full_test_df, aes(x = gestAge, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_boxplot(aes(group = gestAge), color = "#ecc9c9", alpha = 0.5) + geom_point(color = "#ecc9c9", alpha = 0.3) +
  geom_smooth(aes(x = as.numeric(gestAge), y = qnorm(smri_vol_scs_allventricles_centiles)) ,method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "Gestational Age (Weeks)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") + 
  theme_minimal() +  
  scale_x_continuous("Gestational Age (Weeks)", labels = as.character(long.full_test_df$gestAge), breaks = long.full_test_df$gestAge) +
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualization of betas on surface maps
```{r}
#merge with atlas data
plot_data_dkt <- merge(reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
reg_table_full_sig_MC[!(reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

#Setting manual limits (could match the colorbar limits between different variables)
(long.ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void()+
  labs(title = "GA long"))

(long.ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA long"))
```
###birth weight - storing models in list to compare linear and non-linear across phenotypes
####linear regressions
```{r}
sum(!is.na(long.full_test_df$birth_weight_oz_sum_adj))
df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$bw_zscore <- z_score(long.full_test_df$birth_weight_oz_sum_adj)

#Global models save
bw_global_models_list <- lapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})
  
#Global phenotypes -- save betas and p-values
bw_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_reg_table_global)), name_mapping$abbreviation)]

bw_reg_table_global_sig <- bw_reg_table_global %>% filter(bw_p < 0.05)
bw_reg_table_global$bw_p_adj <- p.adjust(bw_reg_table_global$bw_p, method = "BH")
bw_reg_table_global_sig_MC <- bw_reg_table_global %>% filter(bw_p_adj < 0.05)

bw_reg_table_global_sig_MC

#Regional models save
bw_regional_models_list <- lapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
})

#Regional phenotypes -- save betas and p-values
bw_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_zscore, data = df)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bw_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_reg_table_full)), name_mapping$abbreviation)]

bw_reg_table_full_sig <- bw_reg_table_full %>% filter(bw_p < 0.05)
bw_reg_table_full$bw_p_adj <- p.adjust(bw_reg_table_full$bw_p, method = "BH")
bw_reg_table_full_sig_MC <- bw_reg_table_full %>% filter(bw_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bw_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweight_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweight_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
long.full_test_df$bw_zscore <- z_score(long.full_test_df$birth_weight_sum_oz)
#cerebral WM-points
long.bw_wmv_scatterplot <-ggplot(long.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
long.bw_ctxgmv_scatterplot <-ggplot(long.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
long.bw_subctxgmv_scatterplot <- ggplot(long.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
long.bw_vent_scatterplot <- ggplot(long.full_test_df, aes(x = birth_weight_sum_oz, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight (Oz)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_reg_table_full_sig_MC[!(bw_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bw_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW long"))

(long.bw_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW long"))
```
####non-linear relationship with birthweight
```{r}
sum(!is.na(long.full_test_df$birth_weight_sum_oz))
df <- as.data.frame(long.full_test_df[,"src_subject_id"])
df$bw_zscore <- z_score(long.full_test_df$birth_weight_sum_oz)

#Global non-linear models save
NLbw_global_models_list <- lapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ns(bw_zscore,3), data = df)
})

#Regional non-linear models save
NLbw_regional_models_list <- lapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, "_centiles"))], function(x) {
  df$x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ns(bw_zscore,3), data = df)
})
```

####visualize the nonlinear models
```{r}
##Visualize global models
#Predict on new data
for (i in 1:length(NLbw_global_models_list)){
model <- NLbw_global_models_list[[i]]
x <- long.full_test_df[,names(NLbw_global_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}

##Visualize regional models
#Predict on new data
for (i in 1:length(NLbw_regional_models_list)){
model <- NLbw_regional_models_list[[i]]
x <- long.full_test_df[,names(NLbw_regional_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_regional_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}
```
####Compare linear and non-linear models
```{r}
length_total <- length(NLbw_global_models_list) + length(NLbw_regional_models_list)
bw_modelcompare <- data.frame(label = rep(NA, length_total), phenotype = rep(NA, length_total), pr = rep(NA, length_total))

for(i in 1:length(NLbw_global_models_list)){
 bw_modelcompare$label[i] <- as.character(name_mapping$region_name[match(sub("_centiles", "",names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
 bw_modelcompare$phenotype[i] <- names(NLbw_global_models_list)[i]
  modelNL <- NLbw_global_models_list[[i]]
  modelOG <- bw_global_models_list[[i]]
  #x <- long.full_test_df[,names(NLbw_global_models_list)[i]]
  #df$x_zscore <- qnorm(x)
  anova <- anova(modelOG, modelNL, test = "LRT")
  bw_modelcompare$pr[i] <- anova$`Pr(>Chi)`[2]
}

for(i in (length(NLbw_global_models_list)+1):length_total){
  j = i - length(NLbw_global_models_list)
 bw_modelcompare$label[i] <- as.character(name_mapping$region_name[match(sub("_centiles", "",names(NLbw_regional_models_list)[j]), name_mapping$abbreviation)])
 bw_modelcompare$phenotype[i] <- names(NLbw_regional_models_list)[j]
  modelNL <- NLbw_regional_models_list[[j]]
  modelOG <- bw_regional_models_list[[j]]
  #x <- long.full_test_df[,names(NLbw_regional_models_list)[i]]
  #df$x_zscore <- qnorm(x)
  anova <- anova(modelOG, modelNL, test = "LRT")
  bw_modelcompare$pr[i] <- anova$`Pr(>Chi)`[2]
}

NL_sig_models <- bw_modelcompare[bw_modelcompare$pr < 0.05,]
```
####Plot models significantly better fit with NL model
```{r}
plot <- TRUE
NLall_models <- c(NLbw_global_models_list, NLbw_regional_models_list)
OGall_models <- c(bw_global_models_list, bw_regional_models_list)
plots_nl <- vector(mode = "list", length = length(NLall_models))
for (i  in 1:length(NLall_models)) {
  modelNL <- NLall_models[[i]]
  modelOG <- OGall_models[[i]]
  if(!(names(NLall_models)[i] %in% NL_sig_models$phenotype)) next
  x <- long.full_test_df[,names(NLall_models)[i]]
 df$x_zscore <- qnorm(x)
 new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
 new_data$y_predNL <- predict(modelNL, newdata = new_data)
 new_data$y_predOG <- predict(modelOG, newdata = new_data)
 
 #Save plot
 title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLall_models)[i]),  name_mapping$abbreviation)])
  plots_nl[[i]] <- ggplot(df, aes(bw_zscore, x_zscore)) +
   geom_line(data = new_data, aes(bw_zscore, y_predNL), color = "red", linewidth = 1) + 
    geom_line(data = new_data, aes(bw_zscore, y_predOG), color = "blue", linewidth = 1) +
    ggtitle(title)

}
plots_nl <- Filter(Negate(is.null), plots_nl)
do.call("grid.arrange", c(plots_nl[1:15], ncol=5))

#The code below gives an error ... haven't solved it yet.
if (plot == TRUE){
  n <- length(plots_nl)
  nCol <- min(c(floor(sqrt(n)), 4))
  nRow <- min(ceiling(n/nCol), 4)
  breaks <- c(seq(from = 0, to = n , by = (nCol*nRow)), n)
  for(k in 1:length(breaks)){
    start <- breaks[k] + 1
    end <- breaks[k+1]
    do.call("grid.arrange", c(plots_nl[start:end], ncol=nCol))
  }
}                                



##Visualize models where it is significantly better than linear model
#Predict on new data
for (i in 1:length(NLbw_global_models_list)){
model <- NLbw_global_models_list[[i]]

x <- long.full_test_df[,names(NLbw_global_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_global_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}

for (i in 1:length(NLbw_regional_models_list)){
model <- NLbw_regional_models_list[[i]]
if(!(names(NLbw_regional_models_list)[i] %in% NL_sig_models$phenotype)){
  stop()
}
x <- long.full_test_df[,names(NLbw_regional_models_list)[i]]
df$x_zscore <- qnorm(x)
new_data <- data.frame(bw_zscore = seq(min(df$bw_zscore, na.rm = TRUE), max(df$bw_zscore, na.rm = TRUE), length.out = 100))
new_data$y_pred <- predict(model, newdata = new_data)

#Plot
title <-  as.character(name_mapping$region_name[match(sub("_centiles", "", names(NLbw_regional_models_list)[i]), name_mapping$abbreviation)])
p <- ggplot(df, aes(bw_zscore, x_zscore)) +
  geom_point() +
  geom_line(data = new_data, aes(bw_zscore, y_pred), color = "blue", linewidth = 1) + ggtitle(title)
print(p)
}
```

###birth weight percentile
####calculate birth weight percentile
```{r}
#convert birthweight into percentiles using the gitHub growthstandards package which use the intergrowth charts
long.full_test_df <- long.full_test_df %>%
  mutate(birth_weight_kg = birth_weight_oz_sum_adj * 0.0283495) %>%
  mutate(gestAge_days = gestAge*7+3) %>%
  mutate(sexLong = recode(sex, "M" = "Male", "F" = "Female"))

long.full_test_df$bweight_percentile <- igb_wtkg2centile(long.full_test_df$gestAge_days, long.full_test_df$birth_weight_kg, sex = long.full_test_df$sexLong)/100

long.full_test_df$bw_category <- ifelse(long.full_test_df$bweight_percentile < 0.10, "SGA", ifelse(long.full_test_df$bweight_percentile > 0.90, "LGA", "AGA"))
```
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bweight_percentile))
bwp_zscore <- qnorm(long.full_test_df$bweight_percentile)

#Global Phenotypes
bwp_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bwp_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_reg_table_global)), name_mapping$abbreviation)]

bwp_reg_table_global_sig <- bwp_reg_table_global %>% filter(bw_p < 0.05)
bwp_reg_table_global$bw_p_adj <- p.adjust(bwp_reg_table_global$bw_p, method = "BH")
bwp_reg_table_global_sig_MC <- bwp_reg_table_global %>% filter(bw_p_adj < 0.05)

bwp_reg_table_global_sig_MC

#Regional Phenotypes
bwp_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  
  lm <- lm(x_zscore ~ bwp_zscore)
  summary <- summary(lm)
  
  c(bw_beta = summary$coefficients[2,1], bw_p = summary$coefficients[2,4], bw_se = summary$coefficients[2,2])
})))

bwp_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_reg_table_full)), name_mapping$abbreviation)]

bwp_reg_table_full_sig <- bwp_reg_table_full %>% filter(bw_p < 0.05)
bwp_reg_table_full$bw_p_adj <- p.adjust(bwp_reg_table_full$bw_p, method = "BH")
bwp_reg_table_full_sig_MC <- bwp_reg_table_full %>% filter(bw_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bwp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightpercentile_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightpercentile_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
long.full_test_df$bwp_zscore <- qnorm(long.full_test_df$bweight_percentile)
#cerebral WM-points
long.bwp_wmv_scatterplot <-ggplot(long.full_test_df, aes(x = bwp_zscore, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
long.bwp_ctxgmv_scatterplot <-ggplot(long.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
long.bwp_subctxgmv_scatterplot <- ggplot(long.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
long.bwp_vent_scatterplot <- ggplot(long.full_test_df, aes(x = bwp_zscore, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight Percentile (z-scored)",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bwp_reg_table_full_sig_MC[!(bwp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWp long"))

(long.bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWp long"))
```
###PRS-bw
####add birthweight pgs metrics from t1 table
```{r}
long.full_test_df$bw_pgs <- t1.full_test_df$bw_pgs[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC1 <- t1.full_test_df$PC1[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC2 <- t1.full_test_df$PC2[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC3 <- t1.full_test_df$PC3[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC4 <- t1.full_test_df$PC4[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC5 <- t1.full_test_df$PC5[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC6 <- t1.full_test_df$PC6[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC7 <- t1.full_test_df$PC7[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC8 <- t1.full_test_df$PC8[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC9 <- t1.full_test_df$PC9[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$PC10 <- t1.full_test_df$PC10[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
```
####linear regressions
```{r}
sum(!is.na(long.full_test_df$bw_pgs))
bw_pgs_zscore <- as.data.frame(sapply(long.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {z_score(x)}))

#Global Phenotypes
bw_pgs_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_pgs_reg_table_global)), name_mapping$abbreviation)]

bw_pgs_reg_table_global_sig <- bw_pgs_reg_table_global %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_global$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_global$bw_pgs_p, method = "BH")
bw_pgs_reg_table_global_sig_MC <- bw_pgs_reg_table_global %>% filter(bw_pgs_p_adj < 0.05)

bw_pgs_reg_table_global_sig_MC

#Regional Phenotypes
bw_pgs_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[,which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2])
})))

bw_pgs_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bw_pgs_reg_table_full)), name_mapping$abbreviation)]

bw_pgs_reg_table_full_sig <- bw_pgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bw_pgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bw_pgs_reg_table_full$bw_pgs_p, method = "BH")
bw_pgs_reg_table_full_sig_MC <- bw_pgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)

#save tables of betas
save_tables = TRUE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- bw_pgs_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_birthweightPGS_all.csv")
  filename_sig <- paste0(output_folder, "dsk_birthweightPGS_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
long.bwpgs_wmv_scatterplot <-ggplot(long.full_test_df, aes(x = bw_pgs, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
long.bwpgs_ctxgmv_scatterplot <-ggplot(long.full_test_df, aes(x = bw_pgs, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
long.bwpgs_subctxgmv_scatterplot <- ggplot(long.full_test_df, aes(x = bw_pgs, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#d1dff6", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#92b6f0") + 
  labs(x = "Birth Weight PGS",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on atlas
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_pgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_pgs_reg_table_full_sig_MC[!(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_pgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs long"))

(long.bwpgs_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BW_pgs long"))
```
####correlations with bw
- spin test in Python using neuromaps package
```{r}
bw_bwpgs <- merge(bw_pgs_reg_table_full, bw_reg_table_full, by = c("label"))
#all regions
plot(bw_bwpgs$bw_beta, bw_bwpgs$bw_pgs_beta)
cor.test(bw_bwpgs$bw_beta, bw_bwpgs$bw_pgs_beta)
#only significant post-FDR in both
bw_bwpgs_sig <- bw_bwpgs %>% filter(bw_p_adj < 0.05 & bw_pgs_p_adj < 0.05)
plot(bw_bwpgs_sig$bw_beta, bw_bwpgs_sig$bw_pgs_beta)
cor.test(bw_bwpgs_sig$bw_beta, bw_bwpgs_sig$bw_pgs_beta)
```

###General P change calculate
```{r}
long.full_test_df$General_p.t1 <- t1.full_test_df$General_p[match(long.full_test_df$src_subject_id, t1.full_test_df$src_subject_id)]
long.full_test_df$General_p.t2 <- t2.full_test_df$General_p[match(long.full_test_df$src_subject_id, t2.full_test_df$src_subject_id)]
long.full_test_df$General_p_change <- long.full_test_df$General_p.t2 - long.full_test_df$General_p.t1
```
###general P-factor t1
####linear regressions
```{r}
sum(!is.na(long.full_test_df$General_p.t1))
gp_zscore <- z_score(long.full_test_df$General_p.t1)

#Global Phenotypes
gp_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_reg_table_global)), name_mapping$abbreviation)]

gp_reg_table_global_sig <- gp_reg_table_global %>% filter(gp_p < 0.05)
gp_reg_table_global$gp_p_adj <- p.adjust(gp_reg_table_global$gp_p, method = "BH")
gp_reg_table_global_sig_MC <- gp_reg_table_global %>% filter(gp_p_adj < 0.05)

gp_reg_table_global_sig_MC

#Regional Phenotypes
gp_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_reg_table_full)), name_mapping$abbreviation)]

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)

#save tables of betas
save_tables = FALSE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- gp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "gp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_genP_all.csv")
  filename_sig <- paste0(output_folder, "dsk_genP_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
long.gp_wmv_scatterplot <-ggplot(long.full_test_df, aes(x = General_p, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
long.gp_ctxgmv_scatterplot <-ggplot(long.full_test_df, aes(x = General_p, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
long.gp_subctxgmv_scatterplot <- ggplot(long.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
long.gp_vent_scatterplot <- ggplot(long.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "T1 P-factor long"))

(long.gp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "T1 P-factor long"))
```

###general P-factor t2
####linear regressions
```{r}
sum(!is.na(long.full_test_df$General_p.t2))
gp_zscore <- z_score(long.full_test_df$General_p.t2)

#Global Phenotypes
gp_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_reg_table_global)), name_mapping$abbreviation)]

gp_reg_table_global_sig <- gp_reg_table_global %>% filter(gp_p < 0.05)
gp_reg_table_global$gp_p_adj <- p.adjust(gp_reg_table_global$gp_p, method = "BH")
gp_reg_table_global_sig_MC <- gp_reg_table_global %>% filter(gp_p_adj < 0.05)

gp_reg_table_global_sig_MC

#Regional Phenotypes
gp_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ gp_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2])
})))

gp_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_reg_table_full)), name_mapping$abbreviation)]

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)

#save tables of betas
save_tables = FALSE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/2.0_results/Surface_Maps/"
  save_table_full <- gp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "gp_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_genP_all.csv")
  filename_sig <- paste0(output_folder, "dsk_genP_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####Scatter Plots/Boxplots for global phenotypes
smri_vol_cdk_total_centiles  
smri_vol_scs_allventricles_centiles
smri_vol_scs_subcorticalgv_centiles
totalWM_cb_centiles
```{r}
#cerebral WM-points
long.gp_wmv_scatterplot <-ggplot(long.full_test_df, aes(x = General_p, y = qnorm(totalWM_cb_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cerebral WM Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#cortical GMV-points
long.gp_ctxgmv_scatterplot <-ggplot(long.full_test_df, aes(x = General_p, y = qnorm(smri_vol_cdk_total_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Cortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal() +  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subcortical GMV - points
long.gp_subctxgmv_scatterplot <- ggplot(long.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_subcorticalgv_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "Subcortical Gray Matter Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#ventricles - points
long.gp_vent_scatterplot <- ggplot(long.full_test_df, aes(x = General_p, y = qnorm(smri_vol_scs_allventricles_centiles))) + geom_point(color = "#ecc9c9", alpha = 0.3) + 
  geom_smooth(method = "lm", se = FALSE, color = "#e5a3a3") + 
  labs(x = "General P Factor",
       y = "All Ventricles Centile (z-scored)",
       title = "Timepoint 1") +
  theme_minimal()+  
  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "T2 P-factor long"))

(long.gp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "T2 P-factor long"))
```
s
###general P-factor - change in P-factor -- including baseline P-factor as covar
####linear regressions
```{r}
sum(!is.na(long.full_test_df$General_p_change))
gp_zscore <- z_score(long.full_test_df$General_p_change)
gp_baseline_zscore <- z_score(long.full_test_df$General_p.t1)

#Global Phenotypes
gp_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_zscore + gp_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2],gp_base_beta = summary$coefficients[3,1], gp_base_p = summary$coefficients[3,4], gp_base_se = summary$coefficients[3,2])
})))

gp_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_reg_table_global)), name_mapping$abbreviation)]

gp_reg_table_global_sig <- gp_reg_table_global %>% filter(gp_p < 0.05)
gp_reg_table_global$gp_p_adj <- p.adjust(gp_reg_table_global$gp_p, method = "BH")
gp_reg_table_global$gp_base_p_adj <- p.adjust(gp_reg_table_global$gp_base_p, method = "BH")
gp_reg_table_global_sig_MC <- gp_reg_table_global %>% filter(gp_p_adj < 0.05)

gp_reg_table_global_sig_MC

#Regional Phenotypes
gp_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  x_zscore[is.infinite(x_zscore)] <- NA
  lm <- lm(x_zscore ~ gp_zscore + gp_baseline_zscore)
  summary <- summary(lm)
  
  c(gp_beta = summary$coefficients[2,1], gp_p = summary$coefficients[2,4], gp_se = summary$coefficients[2,2],gp_base_beta = summary$coefficients[3,1], gp_base_p = summary$coefficients[3,4], gp_base_se = summary$coefficients[3,2])
})))

gp_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(gp_reg_table_full)), name_mapping$abbreviation)]

gp_reg_table_full_sig <- gp_reg_table_full %>% filter(gp_p < 0.05)
gp_reg_table_full$gp_p_adj <- p.adjust(gp_reg_table_full$gp_p, method = "BH")
gp_reg_table_full$gp_base_p_adj <- p.adjust(gp_reg_table_full$gp_base_p, method = "BH")
gp_reg_table_full_sig_MC <- gp_reg_table_full %>% filter(gp_p_adj < 0.05)

#save tables of betas
save_tables = FALSE
if(save_tables == TRUE){
  output_folder <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Surface_Maps/"
  save_table_full <- gp_reg_table_full
  save_table_full$hemisphere <- ifelse(grepl("lh", save_table_full$label), "L", 
                         ifelse(grepl("rh", save_table_full$label), "R", NA))
  save_table_full$label <- sub("^rh_|lh_", "", save_table_full$label)
  save_table_sig <- save_table_full
  save_table_sig[which(save_table_sig$save_p_adj>0.05), "bw_pgs_beta"] <- 0
  filename_all <- paste0(output_folder, "dsk_genP_long_all.csv")
  filename_sig <- paste0(output_folder, "dsk_genP_longs_sig.csv")
  write.csv(save_table_full, filename_all)
  write.csv(save_table_sig, filename_sig)
}
```
####visualize on surface
```{r}
#merge with atlas data
plot_data_dkt <- merge(gp_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(gp_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
gp_reg_table_full_sig_MC[!(gp_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(gp_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.gp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "GP Change, Long"))

(long.gp_dkt_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = gp_beta)) +
  scale_fill_gradient2(limits = c(-0.1, 0)) +
  theme_void() +
  labs(title = "GP Change, Long"))
```



###GA-BWpercentile as cov
####linear regressions
```{r}
sum(!is.na(long.full_test_df$gestAge) & !is.na(long.full_test_df$bweight_percentile))
ga_zscore <- z_score(long.full_test_df$gestAge)
bwp_zscore <- qnorm(long.full_test_df$bweight_percentile)

#Global regression
bwp_ga_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_ga_reg_table_global)), name_mapping$abbreviation)]

ga_reg_table_global_sig <- bwp_ga_reg_table_global %>% filter(ga_p < 0.05)
bwp_ga_reg_table_global$ga_p_adj <- p.adjust(bwp_ga_reg_table_global$ga_p, method = "BH")
bwp_ga_reg_table_global$bwp_p_adj <- p.adjust(bwp_ga_reg_table_global$bwp_p, method = "BH")
ga_reg_table_global_sig_MC <- bwp_ga_reg_table_global %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_global_sig <- bwp_ga_reg_table_global %>% filter(bwp_p < 0.05)
bwpga_reg_table_global_sig_MC <- bwp_ga_reg_table_global %>% filter(bwp_p_adj < 0.05)

bwpga_reg_table_global_sig_MC


#regional regression
bwp_ga_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ ga_zscore + bwp_zscore)
  summary <- summary(lm)
  
  c(ga_beta = summary$coefficients[2,1], ga_p = summary$coefficients[2,4], bwp_beta = summary$coefficients[3,1], bwp_p = summary$coefficients[3,4])
})))

bwp_ga_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwp_ga_reg_table_full)), name_mapping$abbreviation)]

ga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(ga_p < 0.05)
bwp_ga_reg_table_full$ga_p_adj <- p.adjust(bwp_ga_reg_table_full$ga_p, method = "BH")
bwp_ga_reg_table_full$bwp_p_adj <- p.adjust(bwp_ga_reg_table_full$bwp_p, method = "BH")
ga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(ga_p_adj < 0.05)
bwpga_reg_table_full_sig <- bwp_ga_reg_table_full %>% filter(bwp_p < 0.05)
bwpga_reg_table_full_sig_MC <- bwp_ga_reg_table_full %>% filter(bwp_p_adj < 0.05)
```
####GA coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(ga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(ga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
ga_reg_table_full_sig_MC[!(ga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(ga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpga_ga_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, long"))

(long.bwpga_ga_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "GA in BWp-GA, long"))
```
####BWp coefs
```{r}
#merge with atlas data
plot_data_dkt <- merge(bwpga_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bwpga_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#bwpga_regions not matched in atlases
bwpga_reg_table_full_sig_MC[!(bwpga_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bwpga_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bwpga_bwp_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk,
             position = position_brain(hemi ~ side),
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, long"))

(long.bwpga_bwp_aseg_plot <- ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = ga_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.23)) +
  theme_void() +
  labs(title = "BWP in BWp-GA, long"))
```

###BW + BW PGS 
```{r}
sum(!is.na(long.full_test_df$bw_pgs) & !is.na(long.full_test_df$birth_weight_oz_sum_adj))
bw_pgs_zscore <- as.data.frame(sapply(long.full_test_df[,c("bw_pgs", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")], function(x) {z_score(x)}))
#bw_pgs_zscore$bw_zscore <- qnorm(long.full_test_df$bweight_percentile)
bw_pgs_zscore$bw_zscore <- z_score(long.full_test_df$birth_weight_oz_sum_adj)

#Global variables
bwbwpgs_reg_table_global <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(global_phenotypes, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_global$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwbwpgs_reg_table_global)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_global_sig <- bwbwpgs_reg_table_global %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_global$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_global$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_global_sig_MC <- bwbwpgs_reg_table_global %>% filter(bw_pgs_p_adj < 0.05)

pgs_bwbwpgs_reg_table_global_sig_MC

bw_bwbwpgs_reg_table_global_sig <- bwbwpgs_reg_table_global %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_global$bw_p_adj <- p.adjust(bwbwpgs_reg_table_global$bw_p, method = "BH")
bw_bwbwpgs_reg_table_global_sig_MC <- bwbwpgs_reg_table_global %>% filter(bw_p_adj < 0.05)

bw_bwbwpgs_reg_table_global_sig_MC

#Regional variables
bwbwpgs_reg_table_full <- as.data.frame(t(sapply(long.full_test_df[, which(names(long.full_test_df) %in% paste0(phenotypes_for_MC, ".long_centiles"))], function(x) {
  x_zscore <- qnorm(x)
  lm <- lm(x_zscore ~ bw_pgs_zscore$bw_pgs + bw_pgs_zscore$bw_zscore + bw_pgs_zscore$PC1 + bw_pgs_zscore$PC2 + bw_pgs_zscore$PC3 + bw_pgs_zscore$PC4 + bw_pgs_zscore$PC5 + bw_pgs_zscore$PC6 + bw_pgs_zscore$PC7 + bw_pgs_zscore$PC8 + bw_pgs_zscore$PC9 + bw_pgs_zscore$PC10)
  summary <- summary(lm)
  
  c(bw_pgs_beta = summary$coefficients[2,1], bw_pgs_p = summary$coefficients[2,4], bw_pgs_se = summary$coefficients[2,2], bw_beta = summary$coefficients[3,1], bw_p = summary$coefficients[3,4], bw_se = summary$coefficients[3,2])
})))

bwbwpgs_reg_table_full$label <- name_mapping$region_name[match(sub(".long_centiles", "", rownames(bwbwpgs_reg_table_full)), name_mapping$abbreviation)]

pgs_bwbwpgs_reg_table_full_sig <- bwbwpgs_reg_table_full %>% filter(bw_pgs_p < 0.05)
bwbwpgs_reg_table_full$bw_pgs_p_adj <- p.adjust(bwbwpgs_reg_table_full$bw_pgs_p, method = "BH")
pgs_bwbwpgs_reg_table_full_sig_MC <- bwbwpgs_reg_table_full %>% filter(bw_pgs_p_adj < 0.05)

bw_bwbwpgs_reg_table_full_sig <- bwbwpgs_reg_table_full %>% filter(bw_p < 0.05)
bwbwpgs_reg_table_full$bw_p_adj <- p.adjust(bwbwpgs_reg_table_full$bw_p, method = "BH")
bw_bwbwpgs_reg_table_full_sig_MC <- bwbwpgs_reg_table_full %>% filter(bw_p_adj < 0.05)
```
####surface visualization of bw-pgs beta
```{r}
#merge with atlas data
plot_data_dkt <- merge(pgs_bwbwpgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(pgs_bwbwpgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
pgs_bwbwpgs_reg_table_full_sig_MC[!(pgs_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(pgs_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.pgs_bwbwpgs_dkt_plot <- ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW_pgs in BW-BWpgs, long"))

(long.pgs_bwbwpgs_aseg_plot <-ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_pgs_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW_pgs in BW-BWpgs, long"))
```
####surface visualization of bw beta
```{r}
#merge with atlas data
plot_data_dkt <- merge(bw_bwbwpgs_reg_table_full_sig_MC, ggseg::dk, by = "label")
plot_data_aseg <- merge(bw_bwbwpgs_reg_table_full_sig_MC, ggseg::aseg, by = "label")

#Regions not matched in atlases
bw_bwbwpgs_reg_table_full_sig_MC[!(bw_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_dkt$label) & !(bw_bwbwpgs_reg_table_full_sig_MC$label %in% plot_data_aseg$label),]

# Plot using ggseg
(long.bw_bwbwpgs_dkt_plot <-ggplot(plot_data_dkt) +
  geom_brain(atlas = dk, 
             position = position_brain(hemi ~ side),
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW in BW-BWpgs, long"))

(long.bw_bwbwpgs_aseg_plot <-ggplot(plot_data_aseg) +
  geom_brain(atlas = aseg,
             aes(fill = bw_beta)) +
  scale_fill_gradient2(limits = c(-0.2, 0.2)) +
  theme_void() +
  labs(title = "BW in BW-BWpgs, long"))
```



##Save scale images
### -0.2 to 0.23
```{r}
# Create dummy data just to generate the colorbar
df <- data.frame(x = 1, y = 1, beta = 0)  # value within the -0.2 to 0.2 range

scale <- ggplot(df, aes(x, y, fill = beta)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "#4878CF",
    mid = "white",
    high = "#D65F5F",
    midpoint = 0,
    limits = c(-0.2, 0.23),
    guide = guide_colorbar(
      barwidth = 20,   # length of colorbar
      barheight = 1    # thickness
    )
  ) +
  theme_void() +  # remove axes, grid, etc.
  theme(
    legend.position = "bottom"
  )
```

### -0.1 to 0
```{r}
# Create dummy data just to generate the colorbar
df <- data.frame(x = 1, y = 1, beta = 0)  # value within the -0.2 to 0.2 range

scale_2 <- ggplot(df, aes(x, y, fill = beta)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "#D65F5F",
    high = "white",
    midpoint = 0,
    limits = c(-0.1, 0),
    guide = guide_colorbar(
      barwidth = 20,   # length of colorbar
      barheight = 1    # thickness
    )
  ) +
  theme_void() +  # remove axes, grid, etc.
  theme(
    legend.position = "bottom"
  )
```