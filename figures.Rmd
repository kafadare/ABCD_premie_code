---
title: "figures"
author: "Eren Kafadar"
date: "2025-05-19"
output: html_document
editor_options: 
  chunk_output_type: inline
---
Next
- plot longitudinal centiles per subject
```{r setup, include=FALSE}
diagnostics <- FALSE
generate <- FALSE
save_tables <- FALSE
knitr::opts_chunk$set(echo = TRUE)
#Load libraries
library(dplyr)
library(magrittr)
library(readr)
library(stringr)
library(gamlss) #to fit model
require(gamlss.ggplots)
library(splines)
library(tidyr)
library(gamlssTools) #Margaret's package
#For figures/plotting
library(ggplot2)
library(gridExtra)
library(ggsegDKT)
library(ggseg)
library(ggcorrplot)
library(cowplot)
library(egg)
library(interactions)
library(growthstandards)

source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/inspect_model_fits.R")
source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/gamlss_functions_EK.R")
source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/data_functions.R")

source("/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/ABCD_premie_code/pred_og_centile_EK.R")

#df to map variable names onto names displayed on figures
name_mapping <- data.frame(
  abbreviation = c(
     "smri_vol_cdk_totallh", "smri_vol_cdk_totalrh", "smri_vol_cdk_total",   
     "totalWM_cb", "totalWM_crb", "totalGM_crb",
     
    "smri_vol_scs_cbwmatterlh", "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_csf",
    "smri_vol_scs_lesionlh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_cbwmatterrh", "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh", "smri_vol_scs_lesionrh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_wmhint",
    "smri_vol_scs_wmhintlh", "smri_vol_scs_wmhintrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat", 
    
    "smri_vol_scs_wholeb", "smri_vol_scs_latventricles",
    "smri_vol_scs_allventricles", "smri_vol_scs_intracranialv", "smri_vol_scs_suprateialv",
    "smri_vol_scs_subcorticalgv",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  ),
  region_name = c(
    "Left-Cerebral_Cortex", "Right-Cerebral-Cortex", "Total-Cerebral-Cortex",
    "Total_Cerebral-WM", "Total_Cerebellum-WM", "Total-Cerebellum-Cortex",
    
    "Left-Cerebral-White-Matter", "Left-Lateral-Ventricle", "Left-Inf-Lat-Vent",
    "Left-Cerebellum-White-Matter", "Left-Cerebellum-Cortex", "Left-Thalamus-Proper",
    "Left-Caudate", "Left-Putamen", "Left-Pallidum",
    "x3rd-ventricle", "x4th-ventricle", "Brain-Stem",
    "Left-Hippocampus", "Left-Amygdala", "Cerebrospinal-Fluid",
    "Left-Lesion", "Left-Accumbens-Area", "Left-VentralDC",
    
   "Right-Cerebral-White-Matter", "Right-Lateral-Ventricle", "Right-Inf-Lat-Vent",
    "Right-Cerebellum-White-Matter", "Right-Cerebellum-Cortex", "Right-Thalamus-Proper",
    "Right-Caudate", "Right-Putamen", "Right-Pallidum",
    "Right-Hippocampus", "Right-Amygdala",
    "Right-Lesion", "Right-Accumbens-Area", "Right-VentralDC",
    
    "WM-Hypointensities","Left-WM-Hypointensities", "Right-WM-Hypointensities",
   
   "CC_Posterior","CC_Mid_Posterior", "CC_Central", "CC_Mid_Anterior",
    "CC_Anterior", 
   
   "WholeBrain", "LatVentricles","AllVentricles", "IntracranialVolume", 
   "SupratentorialVolume", "SubcorticalGrayVolume",
   
     "lh_bankssts", "lh_caudalanteriorcingulate", "lh_caudalmiddlefrontal",
    "lh_cuneus", "lh_entorhinal", "lh_fusiform",
    "lh_inferiorparietal", "lh_inferiortemporal", "lh_isthmuscingulate",
    "lh_lateraloccipital", "lh_lateralorbitofrontal", "lh_lingual",
    "lh_medialorbitofrontal", "lh_middletemporal", "lh_parahippocampal",
    "lh_paracentral", "lh_parsopercularis", "lh_parsorbitalis",
    "lh_parstriangularis", "lh_pericalcarine", "lh_postcentral",
    "lh_posteriorcingulate", "lh_precentral", "lh_precuneus", "lh_rostralanteriorcingulate",
    "lh_rostralmiddlefrontal", "lh_superiorfrontal", "lh_superiorparietal",
    "lh_superiortemporal", "lh_supramarginal", "lh_frontalpole",
    "lh_temporalpole", "lh_transversetemporal", "lh_insula",
   
     "rh_bankssts", "rh_caudalanteriorcingulate", "rh_caudalmiddlefrontal",
    "rh_cuneus", "rh_entorhinal", "rh_fusiform",
    "rh_inferiorparietal", "rh_inferiortemporal", "rh_isthmuscingulate",
    "rh_lateraloccipital", "rh_lateralorbitofrontal", "rh_lingual",
    "rh_medialorbitofrontal", "rh_middletemporal", "rh_parahippocampal",
    "rh_paracentral", "rh_parsopercularis", "rh_parsorbitalis",
    "rh_parstriangularis", "rh_pericalcarine", "rh_postcentral",
    "rh_posteriorcingulate", "rh_precentral", "rh_precuneus", "rh_rostralanteriorcingulate",
    "rh_rostralmiddlefrontal", "rh_superiorfrontal", "rh_superiorparietal",
    "rh_superiortemporal", "rh_supramarginal", "rh_frontalpole",
    "rh_temporalpole", "rh_transversetemporal", "rh_insula"
    )
)

phenotypes_for_MC <- c(
    "smri_vol_scs_ltventriclelh", "smri_vol_scs_inflatventlh",
    "smri_vol_scs_crbwmatterlh", "smri_vol_scs_crbcortexlh", "smri_vol_scs_tplh",
    "smri_vol_scs_caudatelh", "smri_vol_scs_putamenlh", "smri_vol_scs_pallidumlh",
    "smri_vol_scs_3rdventricle", "smri_vol_scs_4thventricle", "smri_vol_scs_bstem",
    "smri_vol_scs_hpuslh", "smri_vol_scs_amygdalalh", "smri_vol_scs_aal", "smri_vol_scs_vedclh",
    
    "smri_vol_scs_ltventriclerh", "smri_vol_scs_inflatventrh",
    "smri_vol_scs_crbwmatterrh", "smri_vol_scs_crbcortexrh", "smri_vol_scs_tprh",
    "smri_vol_scs_caudaterh", "smri_vol_scs_putamenrh", "smri_vol_scs_pallidumrh",
    "smri_vol_scs_hpusrh", "smri_vol_scs_amygdalarh",
    "smri_vol_scs_aar", "smri_vol_scs_vedcrh", 
    
    "smri_vol_scs_ccps",
    "smri_vol_scs_ccmidps", "smri_vol_scs_ccct", "smri_vol_scs_ccmidat",
    "smri_vol_scs_ccat",
    
    "smri_vol_cdk_banksstslh", "smri_vol_cdk_cdacatelh", "smri_vol_cdk_cdmdfrlh",
    "smri_vol_cdk_cuneuslh", "smri_vol_cdk_ehinallh", "smri_vol_cdk_fusiformlh",
    "smri_vol_cdk_ifpllh", "smri_vol_cdk_iftmlh", "smri_vol_cdk_ihcatelh",
    "smri_vol_cdk_locclh", "smri_vol_cdk_lobfrlh", "smri_vol_cdk_linguallh",
    "smri_vol_cdk_mobfrlh", "smri_vol_cdk_mdtmlh", "smri_vol_cdk_parahpallh",
    "smri_vol_cdk_paracnlh", "smri_vol_cdk_parsopclh", "smri_vol_cdk_parsobislh",
    "smri_vol_cdk_parstgrislh", "smri_vol_cdk_pericclh", "smri_vol_cdk_postcnlh",
    "smri_vol_cdk_ptcatelh", "smri_vol_cdk_precnlh", "smri_vol_cdk_pclh",
    "smri_vol_cdk_rracatelh", "smri_vol_cdk_rrmdfrlh", "smri_vol_cdk_sufrlh",
    "smri_vol_cdk_supllh", "smri_vol_cdk_sutmlh", "smri_vol_cdk_smlh",
    "smri_vol_cdk_frpolelh", "smri_vol_cdk_tmpolelh", "smri_vol_cdk_trvtmlh",
    "smri_vol_cdk_insulalh",
    
     "smri_vol_cdk_banksstsrh", "smri_vol_cdk_cdacaterh", "smri_vol_cdk_cdmdfrrh",
    "smri_vol_cdk_cuneusrh", "smri_vol_cdk_ehinalrh", "smri_vol_cdk_fusiformrh",
    "smri_vol_cdk_ifplrh", "smri_vol_cdk_iftmrh", "smri_vol_cdk_ihcaterh",
    "smri_vol_cdk_loccrh", "smri_vol_cdk_lobfrrh", "smri_vol_cdk_lingualrh",
    "smri_vol_cdk_mobfrrh", "smri_vol_cdk_mdtmrh", "smri_vol_cdk_parahpalrh",
    "smri_vol_cdk_paracnrh", "smri_vol_cdk_parsopcrh", "smri_vol_cdk_parsobisrh",
    "smri_vol_cdk_parstgrisrh", "smri_vol_cdk_periccrh", "smri_vol_cdk_postcnrh",
    "smri_vol_cdk_ptcaterh", "smri_vol_cdk_precnrh", "smri_vol_cdk_pcrh",
    "smri_vol_cdk_rracaterh", "smri_vol_cdk_rrmdfrrh", "smri_vol_cdk_sufrrh",
    "smri_vol_cdk_suplrh", "smri_vol_cdk_sutmrh", "smri_vol_cdk_smrh",
    "smri_vol_cdk_frpolerh", "smri_vol_cdk_tmpolerh", "smri_vol_cdk_trvtmrh",
    "smri_vol_cdk_insularh"
  )

global_phenotypes <- c("smri_vol_cdk_total", "totalWM_cb", "smri_vol_scs_allventricles", "smri_vol_scs_subcorticalgv")

```
#Data Setup
Load all saved centiles data tables for t1, t2, and longitudinal
##T1
###Define files
```{r}
#file paths
t1.splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_baseline_full_ONE/"
t1.splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_baseline_full_TWO/"
t1.splitOne_folder_regional <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_regional_ONE/"
t1.splitTwo_folder_regional <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_regional_TWO/"
t1.sOne_fits_stats_filename <- paste0(t1.splitOne_folder, "gamlss_fits_stats_all.csv")
t1.sTwo_fits_stats_filename <- paste0(t1.splitTwo_folder, "gamlss_fits_stats_all.csv")

t1.splitOne_data_filename <-"/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd_baseline_matchedTrainOne_selectVars_famfilter2024-11-26.csv"
t1.splitTwo_data_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd_baseline_matchedTrainTwo_selectVars_famfilter2024-11-26.csv"

t1.splitOne_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd_baseline_matchedTestOne_selectVars_famfilter2024-11-26.csv"
t1.splitTwo_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd_baseline_matchedTestTwo_selectVars_famfilter2024-11-26.csv"

t1.reg_centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Centile_CSVs/regional_baseline_volume_centiles.csv"
t1.global_centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Centile_CSVs/global_baseline_volume_centiles.csv"
```
###Load data frames and clean them up
```{r}
#define the distribution family and phenotype and whether nonSingleton variable is there to define file name.
#rename some of the variables and select baseline scans
rename_vec <- c(age = "PCW_at_scan", sex = "sex_baseline", site = "site_id_l", nonSingleton = "nonSingleton")

#read in the dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t1.sOne_df <- read.csv(t1.splitOne_data_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "baseline_year_1_arm_1" & !is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
t1.sOne_df$sex <- as.factor(t1.sOne_df$sex)
t1.sOne_df$site <- as.factor(t1.sOne_df$site)
t1.sOne_df$nonSingleton <- as.factor(t1.sOne_df$nonSingleton)
t1.sOne_df$age <- as.numeric(t1.sOne_df$age)

#read in the dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t1.sTwo_df <- read.csv(t1.splitTwo_data_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "baseline_year_1_arm_1" & !is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))
t1.sTwo_df$sex <- as.factor(t1.sTwo_df$sex)
t1.sTwo_df$site <- as.factor(t1.sTwo_df$site)
t1.sTwo_df$nonSingleton <- as.factor(t1.sTwo_df$nonSingleton)
t1.sTwo_df$age <- as.numeric(t1.sTwo_df$age)

#read in the test dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t1.sOne_test_df <- read.csv(t1.splitOne_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "baseline_year_1_arm_1" & !is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))
t1.sOne_test_df$sex <- as.factor(t1.sOne_test_df$sex)
t1.sOne_test_df$site <- as.factor(t1.sOne_test_df$site)
t1.sOne_test_df$nonSingleton <- as.factor(t1.sOne_test_df$nonSingleton)
t1.sOne_test_df$age <- as.numeric(t1.sOne_test_df$age)

#read in the test dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t1.sTwo_test_df <- read.csv(t1.splitTwo_test_filename)  %>% select(-1) %>% rename(., all_of(rename_vec)) %>% 
  subset(eventname == "baseline_year_1_arm_1" & !is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))
t1.sTwo_test_df$sex <- as.factor(t1.sTwo_test_df$sex)
t1.sTwo_test_df$site <- as.factor(t1.sTwo_test_df$site)
t1.sTwo_test_df$nonSingleton <- as.factor(t1.sTwo_test_df$nonSingleton)
t1.sTwo_test_df$age <- as.numeric(t1.sTwo_test_df$age)

t1.centiles_reg <- read.csv(t1.reg_centiles_filename)  %>% select(-1)
t1.centiles_global <- read.csv(t1.global_centiles_filename)  %>% select(-1)
t1.centiles_all <- merge(t1.centiles_reg, t1.centiles_global, by = c("src_subject_id", "split_ID"))
names(t1.centiles_all) <- sub("_centiles", ".t1_centiles", names(t1.centiles_all))
rm(t1.centiles_reg, t1.centiles_global)
t1.full_test_df <- rbind(t1.sOne_test_df,t1.sTwo_test_df)
t1.full_test_df <- merge(t1.centiles_all, t1.full_test_df, by = "src_subject_id")
```


##T2
###Define files
```{r}
#file paths
t2.splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_t2_all_ONE/"
t2.splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_t2_all_TWO/"
t2.sOne_fits_stats_filename <- paste0(t2.splitOne_folder, "gamlss_fits_stats_all.csv")
t2.sTwo_fits_stats_filename <- paste0(t2.splitTwo_folder, "gamlss_fits_stats_all.csv")

t2.splitOne_data_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sOne_train.csv"
t2.splitTwo_data_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sTwo_train.csv"

t2.splitOne_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sOne_test.csv"
t2.splitTwo_test_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/abcd5.1_t1t2_wide_sTwo_test.csv"

t2.centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Centile_CSVs/regional_t2_volume_centiles.csv"
```
###Load data frames and clean them up
```{r}
#read in the dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t2.sOne_df <- read.csv(t2.splitOne_data_filename)  %>% select(-1) %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
t2.sOne_df$sex <- as.factor(t2.sOne_df$sex)
t2.sOne_df$site <- as.factor(t2.sOne_df$site)
t2.sOne_df$nonSingleton <- as.factor(t2.sOne_df$nonSingleton)
t2.sOne_df$age <- as.numeric(t2.sOne_df$age)

#read in the dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t2.sTwo_df <- read.csv(t2.splitTwo_data_filename)  %>% select(-1) %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
t2.sTwo_df$sex <- as.factor(t2.sTwo_df$sex)
t2.sTwo_df$site <- as.factor(t2.sTwo_df$site)
t2.sTwo_df$nonSingleton <- as.factor(t2.sTwo_df$nonSingleton)
t2.sTwo_df$age <- as.numeric(t2.sTwo_df$age)

#read in the test dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t2.sOne_test_df <- read.csv(t2.splitOne_test_filename)  %>% select(-1)  %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
t2.sOne_test_df$sex <- as.factor(t2.sOne_test_df$sex)
t2.sOne_test_df$site <- as.factor(t2.sOne_test_df$site)
t2.sOne_test_df$nonSingleton <- as.factor(t2.sOne_test_df$nonSingleton)
t2.sOne_test_df$age <- as.numeric(t2.sOne_test_df$age)

#read in the test dataframes and set variable types, remove NAs in age nonSingleton and sex not M or F.
t2.sTwo_test_df <- read.csv(t2.splitTwo_test_filename)  %>% select(-1) %>% 
  subset(!is.na(age) & !is.na(nonSingleton) & (sex %in% c("M", "F")))#4512 folks
t2.sTwo_test_df$sex <- as.factor(t2.sTwo_test_df$sex)
t2.sTwo_test_df$site <- as.factor(t2.sTwo_test_df$site)
t2.sTwo_test_df$nonSingleton <- as.factor(t2.sTwo_test_df$nonSingleton)
t2.sTwo_test_df$age <- as.numeric(t2.sTwo_test_df$age)

t2.centiles_all <- read.csv(t2.centiles_filename)  %>% select(-1)
t2.full_test_df <- rbind(t2.sOne_test_df,t2.sTwo_test_df)
t2.full_test_df <- merge(t2.centiles_all, t2.full_test_df, by = "src_subject_id")
```


##LONG
###Define files
Test/Train data files same as t2
```{r}
#file paths
long.splitOne_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_long_BCT_ONE/"
long.splitTwo_folder <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/gamlss_fits_long_BCT_TWO/"
long.sOne_fits_stats_filename <- paste0(long.splitOne_folder, "gamlss_fits_stats_all.csv")
long.sTwo_fits_stats_filename <- paste0(long.splitTwo_folder, "gamlss_fits_stats_all.csv")

long.centiles_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/Centile_CSVs/longmodel_all_volume_BCT_centiles.csv"
```
###Load data frames and clean them up
```{r}
long.centiles_all <- read.csv(long.centiles_filename)  %>% select(-1)
names(long.centiles_all) <- sub(".t2_centiles", ".long_centiles", names(long.centiles_all))
#long.full_test_df <- rbind(t2.sOne_test_df,t2.sTwo_test_df)
#merge longitudinal centiles with t2 dataframe
t2.full_test_df <- merge(long.centiles_all, t2.full_test_df, by = "src_subject_id")
```


##Combine dataframes
```{r}
t1.full_test_df <- t1.full_test_df %>% rename(age.t1 = age, site.t1 = site)
t2.full_test_df <- t2.full_test_df %>% rename(age.t2 = age, site.t2 = site)
shared_names = intersect(names(t1.full_test_df), names(t2.full_test_df))
full.df <- merge(t1.full_test_df, t2.full_test_df, by = shared_names, all.x = TRUE)
```

#Load Global Phenotype Models
##t1 global phenotype models
```{r}
#load saved fits
t1.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/baseline_global_fits.csv"
t1.all_fits <- read.csv(t1.all_fits_filename) %>% select(-1)
t1.sOne_fits <- t1.all_fits %>% filter(split_no == 1)
t1.sTwo_fits <- t1.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
t1.sOne_best <- t1.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

t1.sTwo_best <- t1.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
t1.sOne_best_list <- paste0(t1.splitOne_folder,"gamlssFIT_",t1.sOne_best$model_index,".rds")
t1.best_models_One <- lapply(t1.sOne_best_list, readRDS)
t1.sTwo_best_list <- paste0(t1.splitTwo_folder,"gamlssFIT_",t1.sTwo_best$model_index,".rds")
t1.best_models_Two <- lapply(t1.sTwo_best_list, readRDS)
```
##t2 global phenotype models
```{r}
global_t2 <- paste0(c(global_phenotypes, "smri_vol_scs_wholeb"), ".t2")
#load saved fits
t2.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/t2_all_fits.csv"
t2.all_fits <- read.csv(t2.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% global_t2)
t2.sOne_fits <- t2.all_fits %>% filter(split_no == 1)
t2.sTwo_fits <- t2.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
t2.sOne_best <- t2.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

t2.sTwo_best <- t2.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
t2.sOne_best_list <- paste0(t2.splitOne_folder,"gamlssFIT_",t2.sOne_best$model_index,".rds")
t2.best_models_One <- lapply(t2.sOne_best_list, readRDS)
t2.sTwo_best_list <- paste0(t2.splitTwo_folder,"gamlssFIT_",t2.sTwo_best$model_index,".rds")
t2.best_models_Two <- lapply(t2.sTwo_best_list, readRDS)
```
##longitudinal global phenotype models
```{r}
global_t2 <- paste0(c(global_phenotypes, "smri_vol_scs_wholeb"), ".t2")
#load saved fits
long.all_fits_filename <- "/mnt/isilon/bgdlab_processing/Eren/ABCD-braincharts/CSV/process_tables_5.1/longitudinal_all_fits_BCT.csv"
long.all_fits <- read.csv(long.all_fits_filename) %>% select(-1) %>% filter(phenotype %in% global_t2)
long.sOne_fits <- long.all_fits %>% filter(split_no == 1)
long.sTwo_fits <- long.all_fits %>% filter(split_no == 2)

#Choose best fits based on lowest BIC
long.sOne_best <- long.sOne_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
 slice_min(BIC, n = 1)

long.sTwo_best <- long.sTwo_fits %>%
  filter(convergence_warn_end == 0) %>%
  group_by(phenotype) %>%
  slice_min(BIC, n = 1)

#Load models for the best model for each phenotype
long.sOne_best_list <- paste0(long.splitOne_folder,"gamlssFIT_",long.sOne_best$model_index,".rds")
long.best_models_One <- lapply(long.sOne_best_list, readRDS)
long.sTwo_best_list <- paste0(long.splitTwo_folder,"gamlssFIT_",long.sTwo_best$model_index,".rds")
long.best_models_Two <- lapply(long.sTwo_best_list, readRDS)
```

#Explore Centiles Across Models
Plot t1 and t2 centiles across phenotypes
109 index for total GM
```{r}
length <- length(grep(".t1_centiles", names(full.df)))
#Ensure all names are in the same order
names <- names(full.df)[grep(".t1_centiles", names(full.df))] %>% sub(".t1_centiles","",.)
names.t1 <- paste0(names, ".t1_centiles")
names.t2 <- paste0(names, ".t2_centiles")
names.long <- paste0(names, ".long_centiles")
plots <- vector(mode = "list", length = length)
plots.long <- vector(mode = "list", length = length)
plots.t2 <- vector(mode = "list", length = length)
plots.t1 <- vector(mode = "list", length = length)
for(i in 1:length){
  t1.vector <- qnorm(full.df[,names.t1[i]])
  t2.vector <- qnorm(full.df[,names.t2[i]])
  title <-  as.character(name_mapping$region_name[match(names[i],  name_mapping$abbreviation)])
  plots[[i]] <- ggplot(mapping = aes(x = t1.vector, y = t2.vector)) + geom_point() + ggtitle(title)
  names(plots)[i] <- title
  col_name <- paste0(names[i], ".diff")
  full.df[[col_name]] <- t2.vector-t1.vector
  long.vector <- qnorm(full.df[,names.long[i]])
  plots.long[[i]]<- ggplot(mapping = aes(x = full.df[,col_name], y = long.vector)) + geom_point() + ggtitle(title) + xlab("t2-t1 centiles")
  names(plots.long)[i] <- title
  plots.t2[[i]]<- ggplot(mapping = aes(x = full.df[,col_name], y = t2.vector)) + geom_point() + ggtitle(title)
  names(plots.t2)[i] <- title
  plots.t1[[i]]<- ggplot(mapping = aes(x = full.df[,col_name], y = t1.vector)) + geom_point() + ggtitle(title)
  names(plots.t1)[i] <- title
}
```
#Choose individuals to plot
CHOSEN SUBJECTS, all male
decrease in centiles
high long centile
**NDAR_INV79NF4B2M
NDAR_INVVF47E1YM
low long centile
0NDAR_INV3P7XHWPD
NDAR_INV41U1CNA9

increase in centiles
low long centile
NDAR_INVK20NJZWV (site 20)
NDAR_INV38T88Z04 (site 20)
high long centile
NDAR_INV6AC2J61C

no change in centiles
high long centile
NDAR_INV2KJNX54B (site 20)
low long centile
NDAR_INV1BWHMRFY (site 20)
50th long centile
NDAR_INV8KDDNHZY
```{r}
decrease_subjects <- full.df %>% filter((smri_vol_cdk_total.t1_centiles - smri_vol_cdk_total.t2_centiles > 0.1))
hist(decrease_subjects$smri_vol_cdk_total.long_centiles)
decrease_subjects %>% filter(smri_vol_cdk_total.long_centiles > 0.20) %>% select(c("src_subject_id", "sex", "site.t1"))
decrease_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.01) %>% select(c("src_subject_id", "sex", "site.t1"))

increase_subjects <- full.df %>% filter((smri_vol_cdk_total.t2_centiles - smri_vol_cdk_total.t1_centiles > 0.1))
hist(increase_subjects$smri_vol_cdk_total.long_centiles)
increase_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.85) %>% select(c("src_subject_id", "sex", "site.t1"))
increase_subjects %>% filter(smri_vol_cdk_total.long_centiles > 0.99) %>% select(c("src_subject_id", "sex", "site.t1"))


nochange_subjects <- full.df %>% filter(abs(smri_vol_cdk_total.t2_centiles - smri_vol_cdk_total.t1_centiles) < 0.01)
hist(nochange_subjects$smri_vol_cdk_total.long_centiles)
nochange_subjects %>% filter(smri_vol_cdk_total.long_centiles > 0.95) %>% select(c("src_subject_id", "sex", "site.t1"))
nochange_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.05) %>% select(c("src_subject_id", "sex", "site.t1"))
nochange_subjects %>% filter(smri_vol_cdk_total.long_centiles < 0.51 & smri_vol_cdk_total.long_centiles > 0.49) %>% select(c("src_subject_id", "sex", "site.t1"))
```
normal t1 and t2, extreme conditional
"NDAR_INV04YC4RXD" 
"NDAR_INV07924XF1" 
"NDAR_INV08DNLREC" 
"NDAR_INV097LUBWX" 
"NDAR_INV0APJMRD1" 
"NDAR_INV0AUBJJJ4"
"NDAR_INV0C7TZ6YW"
extreme t1 & t2, normal conditional
NDAR_INV00HEV6HB
NDAR_INV0191C80U
NDAR_INV02EBX0JJ
NDAR_INV04TRXUGL
NDAR_INV08K0R9C4
NDAR_INV0A4ZDYNL
NDAR_INV0AEBMADL

```{r}
pool1 <- full.df %>% filter((smri_vol_cdk_total.t2_centiles < 0.75 & smri_vol_cdk_total.t2_centiles > 0.25) & (smri_vol_cdk_total.t1_centiles < 0.75 & smri_vol_cdk_total.t1_centiles > 0.25) & (smri_vol_cdk_total.long_centiles > 0.9 | smri_vol_cdk_total.long_centiles < 0.1))

p1 <- ggplot(pool1) + geom_point(aes(x = smri_vol_cdk_total.t1_centiles, y = smri_vol_cdk_total.t2_centiles, color = smri_vol_cdk_total.long_centiles))
p1

pool2 <- full.df %>% filter((smri_vol_cdk_total.t2_centiles > 0.9 | smri_vol_cdk_total.t2_centiles < 0.1) & (smri_vol_cdk_total.t1_centiles > 0.9 | smri_vol_cdk_total.t1_centiles < 0.1) & (smri_vol_cdk_total.long_centiles < 0.75 & smri_vol_cdk_total.long_centiles > 0.25))

p2 <- ggplot(pool2) + geom_point(aes(x = smri_vol_cdk_total.t1_centiles, y = smri_vol_cdk_total.t2_centiles, color = smri_vol_cdk_total.long_centiles))
p2
```

#Plots for Fig 1
##t1 plot
###one plot
```{r}
#plot by timepoint and add the same 3 subjects to each plot
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
##residualize subjects to plot them correctly
model <- t1.best_models_One[[1]]
df <- full.df  %>% select(c("smri_vol_cdk_total", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1)
t1.subjects_resid <- resid_data(model, df, og_data = t1.sOne_df, rm_terms = c("sex","site"))
t1.subjects_resid <- t1.subjects_resid %>% filter(src_subject_id %in% subjects)
t1.subjects_resid <- t1.subjects_resid [match(subjects, t1.subjects_resid $src_subject_id), ]

#plot t1
t1.plot <- make_centile_fan(model, t1.sOne_df, "age", show_points=FALSE, color_manual="darkgray")
##add subjects and axis labels
t1.plot <- t1.plot + 
  geom_point(aes(x = t1.subjects_resid[1,2], y = t1.subjects_resid[1,1]), color = "#E69F00", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t1.subjects_resid[1,2], y = t1.subjects_resid[1,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[1]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#E69F00") + #orange
  geom_point(aes(x = t1.subjects_resid[2,2], y = t1.subjects_resid[2,1]), color = "#56B4E9", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t1.subjects_resid[2,2], y = t1.subjects_resid[2,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[2]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#56B4E9") + #blue 
  geom_point(aes(x = t1.subjects_resid[3,2], y = t1.subjects_resid[3,1]), color = "#009E73", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t1.subjects_resid[3,2], y = t1.subjects_resid[3,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[4]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#009E73")+ #green
   geom_point(aes(x = t1.subjects_resid[4,2], y = t1.subjects_resid[4,1]), color = "#E0776E", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t1.subjects_resid[4,2], y = t1.subjects_resid[4,1], label = round(full.df[which(full.df$src_subject_id == t1.subjects_resid$src_subject_id[4]), "smri_vol_cdk_total.t1_centiles"], digits = 2)), vjust = -1, color = "#E0776E")+ #pink
theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 1") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- t1.best_models_One[[1]]
df.t1 <- full.df  %>% select(c("smri_vol_cdk_total", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1)

#subject 1
sub1.t1 <- df.t1 %>% filter(src_subject_id == subjects[1])
sub1_age.t1 <- sub1.t1$age
sub1_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub1.t1  <- sub1.t1 %>% slice(rep(1,100))

#simulate across age
sub1.t1 $age <- seq(from = min(t1.sOne_df$age), to = max(t1.sOne_df$age), length.out = 100)

#plot
t1.sub1_plot <- make_centile_fan(model, t1.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub1.t1))

t1.sub1_plot <- t1.sub1_plot + geom_point(aes(x = sub1_age.t1, y = sub1.t1$smri_vol_cdk_total[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.t1, y = sub1.t1$smri_vol_cdk_total[1], label = round(sub1_centile.t1, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 2
sub2.t1 <- df.t1 %>% filter(src_subject_id == subjects[2])
sub2_age.t1 <- sub2.t1$age
sub2_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub2.t1  <- sub2.t1 %>% slice(rep(1,100))

#simulate across age
sub2.t1 $age <- seq(from = min(t1.sOne_df$age), to = max(t1.sOne_df$age), length.out = 100)

#plot
t1.sub2_plot <- make_centile_fan(model, t1.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub2.t1))

t1.sub2_plot <- t1.sub2_plot + geom_point(aes(x = sub2_age.t1, y = sub2.t1$smri_vol_cdk_total[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.t1, y = sub2.t1$smri_vol_cdk_total[1], label = round(sub2_centile.t1, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 3
sub3.t1 <- df.t1 %>% filter(src_subject_id == subjects[3])
sub3_age.t1 <- sub3.t1$age
sub3_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub3.t1  <- sub3.t1 %>% slice(rep(1,100))

#simulate across age
sub3.t1 $age <- seq(from = min(t1.sOne_df$age), to = max(t1.sOne_df$age), length.out = 100)

#plot
t1.sub3_plot <- make_centile_fan(model, t1.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub3.t1))

t1.sub3_plot <- t1.sub3_plot + geom_point(aes(x = sub3_age.t1, y = sub3.t1$smri_vol_cdk_total[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.t1, y = sub3.t1$smri_vol_cdk_total[1], label = round(sub3_centile.t1, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4
sub4.t1 <- df.t1 %>% filter(src_subject_id == subjects[4])
sub4_age.t1 <- sub4.t1$age
sub4_centile.t1 <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.t1_centiles"]

#replicate simulation data frame across age ranges
sub4.t1  <- sub4.t1 %>% slice(rep(1,100))

#simulate across age
sub4.t1 $age <- seq(from = min(t1.sOne_df$age), to = max(t1.sOne_df$age), length.out = 100)

#plot
t1.sub4_plot <- make_centile_fan(model, t1.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub4.t1))

t1.sub4_plot <- t1.sub4_plot + geom_point(aes(x = sub4_age.t1, y = sub4.t1$smri_vol_cdk_total[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.t1, y = sub4.t1$smri_vol_cdk_total[1], label = round(sub4_centile.t1, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
##t2 plot
###one plot
```{r}
#plot by timepoint and add the same 3 subjects to each plot
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
##residualize subjects to plot them correctly
model <- t2.best_models_One[[1]]
df <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2) %>% drop_na()
t2.subjects_resid <- resid_data(model, df, og_data = t2.sOne_df, rm_terms = c("sex","site"))
t2.subjects_resid <- t2.subjects_resid %>% filter(src_subject_id %in% subjects)
t2.subjects_resid <- t2.subjects_resid [match(subjects, t2.subjects_resid $src_subject_id), ]

#plot t2
t2.plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="darkgray")
##add subjects and axis labels
t2.plot <- t2.plot + 
  geom_point(aes(x = t2.subjects_resid[1,2], y = t2.subjects_resid[1,1]), color = "#E69F00", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t2.subjects_resid[1,2], y = t2.subjects_resid[1,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[1]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#E69F00") + #orange
  geom_point(aes(x = t2.subjects_resid[2,2], y = t2.subjects_resid[2,1]), color = "#56B4E9", shape = 16, size = 5, stroke = 0) +
  geom_text(aes(x = t2.subjects_resid[2,2], y = t2.subjects_resid[2,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[2]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#56B4E9") + #blue 
  geom_point(aes(x = t2.subjects_resid[3,2], y = t2.subjects_resid[3,1]), color = "#009E73", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t2.subjects_resid[3,2], y = t2.subjects_resid[3,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[3]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#009E73")+ #green
   geom_point(aes(x = t2.subjects_resid[4,2], y = t2.subjects_resid[4,1]), color = "#E0776E", shape = 16, size = 5, stroke = 0) +
    geom_text(aes(x = t2.subjects_resid[4,2], y = t2.subjects_resid[4,1], label = round(full.df[which(full.df$src_subject_id == t2.subjects_resid$src_subject_id[4]), "smri_vol_cdk_total.t2_centiles"], digits = 2)), vjust = -1, color = "#E0776E")+ #pink
theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 2") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- t2.best_models_One[[1]]
df.t2 <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2)

#subject 1
sub1.t2 <- df.t2 %>% filter(src_subject_id == subjects[1])
sub1_age.t2 <- sub1.t2$age
sub1_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub1.t2  <- sub1.t2 %>% slice(rep(1,100))

#simulate across age
sub1.t2 $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
t2.sub1_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub1.t2))

t2.sub1_plot <- t2.sub1_plot + geom_point(aes(x = sub1_age.t2, y = sub1.t2$smri_vol_cdk_total.t2[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.t2, y = sub1.t2$smri_vol_cdk_total.t2[1], label = round(sub1_centile.t2, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 2
sub2.t2 <- df.t2 %>% filter(src_subject_id == subjects[2])
sub2_age.t2 <- sub2.t2$age
sub2_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub2.t2  <- sub2.t2 %>% slice(rep(1,100))

#simulate across age
sub2.t2 $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
t2.sub2_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub2.t2))

t2.sub2_plot <- t2.sub2_plot + geom_point(aes(x = sub2_age.t2, y = sub2.t2$smri_vol_cdk_total.t2[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.t2, y = sub2.t2$smri_vol_cdk_total.t2[1], label = round(sub2_centile.t2, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 3
sub3.t2 <- df.t2 %>% filter(src_subject_id == subjects[3])
sub3_age.t2 <- sub3.t2$age
sub3_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub3.t2  <- sub3.t2 %>% slice(rep(1,100))

#simulate across age
sub3.t2 $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
t2.sub3_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub3.t2))

t2.sub3_plot <- t2.sub3_plot + geom_point(aes(x = sub3_age.t2, y = sub3.t2$smri_vol_cdk_total.t2[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.t2, y = sub3.t2$smri_vol_cdk_total.t2[1], label = round(sub3_centile.t2, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4
sub4.t2 <- df.t2 %>% filter(src_subject_id == subjects[4])
sub4_age.t2 <- sub4.t2$age
sub4_centile.t2 <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.t2_centiles"]

#replicate simulation data frame across age ranges
sub4.t2  <- sub4.t2 %>% slice(rep(1,100))

#simulate across age
sub4.t2 $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
t2.sub4_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="grey", average_over = FALSE, sim_data_list = list(one = sub4.t2))

t2.sub4_plot <- t2.sub4_plot + geom_point(aes(x = sub4_age.t2, y = sub4.t2$smri_vol_cdk_total.t2[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.t2, y = sub4.t2$smri_vol_cdk_total.t2[1], label = round(sub4_centile.t2, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Timepoint 2") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
##longitudinal plot
###per subject
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
colors <- c("#E69F00", "#56B4E9",  "#009E73", "#E0776E")
##residualize subjects to plot them correctly
model <- long.best_models_One[[1]]
df.long <- full.df  %>% select(c("smri_vol_cdk_total.t2", "smri_vol_cdk_total.t1", "PCW_between_t1t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2)

#subject 1
sub1.long <- df.long %>% filter(src_subject_id == subjects[1])
sub1_age.long <- sub1.long$age
sub1_centile.long <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub1.long  <- sub1.long %>% slice(rep(1,100))

#simulate across age
sub1.long $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub1_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual=colors[1], average_over = FALSE, sim_data_list = list(one = sub1.long))

long.sub1_plot <- long.sub1_plot + geom_point(aes(x = sub1_age.long, y = sub1.long$smri_vol_cdk_total.t2[1]), color = colors[1], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub1_age.long, y = sub1.long$smri_vol_cdk_total.t2[1], label = round(sub1_centile.long, digits = 2)), vjust = -1, color = colors[1]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 2
sub2.long <- df.long %>% filter(src_subject_id == subjects[2])
sub2_age.long <- sub2.long$age
sub2_centile.long <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub2.long  <- sub2.long %>% slice(rep(1,100))

#simulate across age
sub2.long $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub2_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual=colors[2], average_over = FALSE, sim_data_list = list(one = sub2.long))

long.sub2_plot <- long.sub2_plot + geom_point(aes(x = sub2_age.long, y = sub2.long$smri_vol_cdk_total.t2[1]), color = colors[2], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub2_age.long, y = sub2.long$smri_vol_cdk_total.t2[1], label = round(sub2_centile.long, digits = 2)), vjust = -1, color = colors[2]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 3
sub3.long <- df.long %>% filter(src_subject_id == subjects[3])
sub3_age.long <- sub3.long$age
sub3_centile.long <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub3.long  <- sub3.long %>% slice(rep(1,100))

#simulate across age
sub3.long $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub3_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual=colors[3], average_over = FALSE, sim_data_list = list(one = sub3.long))

long.sub3_plot <- long.sub3_plot + geom_point(aes(x = sub3_age.long, y = sub3.long$smri_vol_cdk_total.t2[1]), color = colors[3], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub3_age.long, y = sub3.long$smri_vol_cdk_total.t2[1], label = round(sub3_centile.long, digits = 2)), vjust = -1, color = colors[3]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4
sub4.long <- df.long %>% filter(src_subject_id == subjects[4])
sub4_age.long <- sub4.long$age
sub4_centile.long <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"]

#replicate simulation data frame across age ranges
sub4.long  <- sub4.long %>% slice(rep(1,100))

#simulate across age
sub4.long $age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub4_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual=colors[4], average_over = FALSE, sim_data_list = list(one = sub4.long))

long.sub4_plot <- long.sub4_plot + geom_point(aes(x = sub4_age.long, y = sub4.long$smri_vol_cdk_total.t2[1]), color = colors[4], shape = 16, size = 5, stroke = 1) +
  geom_text(aes(x = sub4_age.long, y = sub4.long$smri_vol_cdk_total.t2[1], label = round(sub4_centile.long, digits = 2)), vjust = -1, color = colors[4]) +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))
```
#Put plots together
```{r}
# Define plots (3 columns of 3 plots each)
plots <- list(
  t1 = list(
    t1.sub1_plot, 
    t1.sub2_plot, 
    t1.sub3_plot, 
    t1.sub4_plot
  ),
  t2 = list(
    t2.sub1_plot, 
    t2.sub2_plot, 
    t2.sub3_plot,
    t2.sub4_plot
  ),
  long = list(
    long.sub1_plot, 
    long.sub2_plot, 
    long.sub3_plot,
    long.sub4_plot
  )
)

#Get x axis and title
x_axis_1 <- get_plot_component(plots$t1[[1]], "axis-b")
x_axis_2 <- get_plot_component(plots$t2[[1]], "axis-b")
x_axis_3 <- get_plot_component(plots$long[[1]], "axis-b")

xlab <- get_plot_component(plots$t1[[1]], "xlab-b")
ylab <- get_plot_component(plots$t1[[1]], "ylab-l")

title_1 <- get_plot_component(plots$t1[[1]], "title", return_all = TRUE)[[2]]
title_2 <- get_plot_component(plots$t2[[1]], "title", return_all = TRUE)[[2]]
title_3 <- get_plot_component(plots$long[[1]], "title", return_all = TRUE)[[2]]



# Remove x-axis and xlab and ylab and titles from all plots
##change this function to be adaptable for # of plots
clean_column <- function(plot_list) {
  plot_list[[1]] <- plot_list[[1]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[2]] <- plot_list[[2]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[3]] <- plot_list[[3]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  plot_list[[4]] <- plot_list[[4]] + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), plot.title = element_blank(), axis.title.x = element_blank(),axis.title.y = element_blank())
  return(plot_list)
}

plots$t1 <- clean_column(plots$t1)
plots$t2 <- clean_column(plots$t2)
plots$long <- clean_column(plots$long)

# Build each column with 3 plots + shared x-axis + shared title
make_column <- function(plot_list, x_axis, title) {
  col_body <- plot_grid(plotlist = plot_list, ncol = 1, align = 'v', rel_heights = c(1, 1, 1))
  with_x <- plot_grid(col_body, x_axis, ncol = 1, rel_heights = c(1, 0.1))
  with_title <- plot_grid(title, with_x, ncol = 1, rel_heights = c(0.1, 1))
  return(with_title)
}

col1 <- make_column(plots$t1, x_axis_1, title_1)
col2 <- make_column(plots$t2, x_axis_2, title_2)
col3 <- make_column(plots$long, x_axis_3, title_3)

# Combine all columns side by side
final_grid <- plot_grid(col1, col2, col3, ncol = 3, align = "h", rel_widths = c(1, 1, 1))
final_grid <- plot_grid(ylab, final_grid, ncol = 2,rel_widths = c(0.05, 1))
final_grid <- plot_grid(final_grid,xlab, ncol = 1, rel_heights = c(1, 0.05))

# Display final plot grid
print(final_grid)
```

#plot longitudinal centiles -- deprecated
```{r}
##specify subjects
subjects <- c("NDAR_INV04YC4RXD" , "NDAR_INV07924XF1", "NDAR_INV00HEV6HB", "NDAR_INV0191C80U")
model <- long.best_models_One[[1]]
df <- full.df  %>% select(c("smri_vol_cdk_total.t1", "smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "PCW_between_t1t2", "nonSingleton")) %>% rename(age = age.t2, site = site.t2) %>% drop_na()
long.subjects_resid <- df

#replace t1 values with residualized t1 values from cross-sectional model
##residualized t1 dataframe
model.t1 <- t1.best_models_One[[1]]
df.t1 <- full.df  %>% select(c("smri_vol_cdk_total", "age.t1", "sex", "site.t1", "src_subject_id", "nonSingleton")) %>% rename(age = age.t1, site = site.t1)
t1.subjects_resid <- resid_data(model.t1, df.t1, og_data = t1.sOne_df, rm_terms = c("sex","site")) %>% filter(src_subject_id %in% df$src_subject_id)
long.subjects_resid$smri_vol_cdk_total.t1 <- t1.subjects_resid[match(t1.subjects_resid$src_subject_id, long.subjects_resid$src_subject_id), "smri_vol_cdk_total"]

#replace t2 values with residualized t2 values from cross-sectional model
##residualized t2 dataframe
model.t2 <- t2.best_models_One[[1]]
df.t2 <- full.df  %>% select(c("smri_vol_cdk_total.t2", "age.t2", "sex", "site.t2", "src_subject_id", "nonSingleton")) %>% rename(age = age.t2, site = site.t2) %>% drop_na()
t2.subjects_resid <- resid_data(model.t2, df.t2, og_data = t2.sOne_df, rm_terms = c("sex","site"))
long.subjects_resid$smri_vol_cdk_total.t2 <- t2.subjects_resid[match(t2.subjects_resid$src_subject_id, long.subjects_resid$src_subject_id), "smri_vol_cdk_total.t2"]

#residualize the longitudinal model on sex and site.
long.subjects_resid <- resid_data(model, long.subjects_resid, og_data = t2.sOne_df, rm_terms = c("sex","site", "nonSingleton"))

#subject 1

long.sub1_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[1])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub1_resid$sex <- "M"
long.sub1_resid$site <- "site16"
long.sub1_resid$nonSingleton <- 0
sub1_age <- long.sub1_resid$age

#calculate correct data point for the correct centile value
long.sub1_centile <- full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub1_resid, 
            type = "response", data = t2.sOne_df)
centile <- as.data.frame(lapply(long.sub1_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub1_resid <- long.sub1_resid %>% slice(rep(1,100))

#simulate across age
long.sub1_resid$age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub1_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="#E69F00", average_over = FALSE, sim_data_list = list(one = long.sub1_resid))

long.sub1_plot <- long.sub1_plot + geom_point(aes(x = sub1_age, y = centile$value), color = "#E69F00", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub1_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[1]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#E69F00") +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal Subject 1") + theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subject 2

long.sub2_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[2])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub2_resid$sex <- "M"
long.sub2_resid$site <- "site16"
long.sub2_resid$nonSingleton <- 0
sub2_age <- long.sub2_resid$age

#calculate correct data point for the correct centile value
long.sub2_centile <- full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub2_resid, 
            type = "response", data = t2.sOne_df)
centile <- as.data.frame(lapply(long.sub2_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub2_resid <- long.sub2_resid %>% slice(rep(1,100))

#simulate across age
long.sub2_resid$age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub2_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="#56B4E9", average_over = FALSE, sim_data_list = list(one = long.sub2_resid))

long.sub2_plot <- long.sub2_plot + geom_point(aes(x = sub2_age, y = centile$value), color = "#56B4E9", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub2_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[2]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#56B4E9") +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal Subject 2") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))


#subject 3

long.sub3_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[3])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub3_resid$sex <- "M"
long.sub3_resid$site <- "site16"
long.sub3_resid$nonSingleton <- 0
sub3_age <- long.sub3_resid$age

#calculate correct data point for the correct centile value
long.sub3_centile <- full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub3_resid, 
            type = "response", data = t2.sOne_df)
centile <- as.data.frame(lapply(long.sub3_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub3_resid <- long.sub3_resid %>% slice(rep(1,100))

#simulate across age
long.sub3_resid$age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub3_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="#009E73", average_over = FALSE, sim_data_list = list(one = long.sub3_resid))

long.sub3_plot <- long.sub3_plot + geom_point(aes(x = sub3_age, y = centile$value), color = "#009E73", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub3_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[3]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#009E73") +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal Subject 3") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

#subject 4

long.sub4_resid <- long.subjects_resid %>% filter(src_subject_id == subjects[4])
#set variables to match the simulations for the t1 and t2 cross-sectional plots
long.sub4_resid$sex <- "M"
long.sub4_resid$site <- "site16"
long.sub4_resid$nonSingleton <- 0
sub4_age <- long.sub4_resid$age

#calculate correct data point for the correct centile value
long.sub4_centile <- full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"]
fname <- model$family[1]
qfun <- paste0("q", fname)
n_param <- length(model$parameters)
pred <- predictAll(model, newdata = long.sub4_resid, 
            type = "response", data = t2.sOne_df)
centile <- as.data.frame(lapply(long.sub4_centile, pred_centile, 
            df = pred, q_func = qfun, n_param = n_param))
names(centile) <- "value"

#replicate simulation data frame across age ranges
long.sub4_resid <- long.sub4_resid %>% slice(rep(1,100))

#simulate across age
long.sub4_resid$age <- seq(from = min(t2.sOne_df$age), to = max(t2.sOne_df$age), length.out = 100)

#plot
long.sub4_plot <- make_centile_fan(model, t2.sOne_df, "age", show_points=FALSE, color_manual="#E0776E", average_over = FALSE, sim_data_list = list(one = long.sub4_resid))

long.sub4_plot <- long.sub4_plot + geom_point(aes(x = sub4_age, y = centile$value), color = "#E0776E", shape = 16, size = 3, stroke = 1) +
  geom_text(aes(x = sub4_age, y = centile$value, label = round(full.df[which(full.df$src_subject_id == subjects[4]), "smri_vol_cdk_total.long_centiles"], digits = 2)), vjust = -1, color = "#E0776E") +
  theme_minimal() + labs(x = "Age (post-conception weeks) ", y = "Total Gray Matter", title = "Conditional Longitudinal Subject 3") +  theme(plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14))

```